<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#5E6AD2" />
  <meta name="color-scheme" content="light dark" />
  <meta name="description" content="Mumbai Transport Hub: Live map, schedules, and updates for BEST buses, local trains, metro, monorail, and ferries." />
  <title>Mumbai Transport Hub | Real-Time Tracking</title>

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="preconnect" href="https://unpkg.com" crossorigin />
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Leaflet for real map rendering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --primary: #5E6AD2;
      --primary-dark: #4C56C4;
      --primary-light: #F1F2FD;
      --secondary: #8B92B2;
      --background: #FAFBFC;
      --surface: #FFFFFF;
      --surface-hover: #F7F8FA;
      --border: #E1E4E8;
      --border-light: #F1F3F4;
      --text-primary: #1D2125;
      --text-secondary: #626F86;
      --text-muted: #8B92B2;
      --success: #00B87A;
      --warning: #F79009;
      --error: #DC3A42;
      --info: #0EA5E9;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }
    [data-theme="dark"] {
      --background: #0F1419;
      --surface: #1A1D23;
      --surface-hover: #222530;
      --border: #2D3442;
      --border-light: #252932;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --text-muted: #6B7280;
      --primary-light: rgba(94, 106, 210, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 14px;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background 0.3s ease, color 0.3s ease;
    }
    .app { height: 100vh; display: flex; flex-direction: column; position: relative; overflow: hidden; }

    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px 12px;
      position: relative;
      z-index: 100;
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
    }
    [data-theme="dark"] .header { background: rgba(26, 29, 35, 0.9); }
    .header-top { display: flex; align-items: center; justify-content: space-between; }
    .logo { font-size: 18px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.2px; display: flex; align-items: center; gap: 8px; }
    .logo-icon { width: 28px; height: 28px; background: var(--primary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; }
    .header-actions { display: flex; gap: 10px; }
    .header-btn { width: 36px; height: 36px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; background: var(--background); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; }
    .header-btn:hover { background: var(--surface-hover); }
    .header-btn:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    .search-bar { position: relative; }
    .search-input { width: 100%; padding: 12px 16px 12px 44px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; color: var(--text-primary); outline: none; transition: all 0.2s ease; }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.1); }
    .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 16px; }

    .content { flex: 1; padding: 16px 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; scroll-behavior: smooth; }
    .section-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .section-title i { color: var(--primary); }

    .transport-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
    .transport-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; transition: all 0.2s ease; cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column; gap: 8px; }
    .transport-card.active { border-color: var(--primary); background: var(--primary-light); }
    .transport-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .card-header { display: flex; align-items: center; gap: 10px; }
    .card-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; flex-shrink: 0; }
    .bus-icon { background: var(--primary); }
    .train-icon { background: var(--success); }
    .metro-icon { background: #8B5CF6; }
    .ferry-icon { background: var(--info); }
    .mono-icon { background: #10B981; }
    .card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); line-height: 1.2; }
    .card-status { display: flex; align-items: center; gap: 6px; }
    .status-indicator { width: 8px; height: 8px; border-radius: 50%; }
    .status-active { background: var(--success); }
    .status-delayed { background: var(--warning); }
    .status-offline { background: var(--error); }
    .card-status-text { font-size: 12px; color: var(--text-muted); }
    .card-stats { display: flex; justify-content: space-between; margin-top: auto; padding-top: 8px; }
    .stat { text-align: center; flex: 1; }
    .stat-number { font-size: 16px; font-weight: 700; color: var(--text-primary); line-height: 1; transition: all 0.3s ease; }
    .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

    .action-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .action-button { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px; font-size: 13px; color: var(--text-secondary); font-weight: 500; cursor: pointer; transition: all 0.2s ease; text-align: left; display: flex; align-items: center; gap: 10px; }
    .action-button:hover { background: var(--surface-hover); transform: translateY(-1px); }
    .action-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 16px; flex-shrink: 0; }

    /* Real map container */
    .map-container { border-radius: var(--radius-lg); overflow: hidden; position: relative; border: 1px solid var(--border); background: var(--surface); }
    #leafletMap { height: 260px; width: 100%; }
    /* Fallback decorative map */
    .map-fallback { height: 200px; position: relative; background: linear-gradient(135deg, #e8f4f8 0%, #f5f9fc 100%); }
    .map-bg { position: absolute; inset: 0; background-image:
      radial-gradient(circle at 20% 30%, rgba(94, 106, 210, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(0, 184, 122, 0.1) 0%, transparent 50%); }
    .map-grid { position: absolute; inset: 0; background-image:
      linear-gradient(90deg, rgba(225, 228, 232, 0.3) 1px, transparent 1px),
      linear-gradient(0deg, rgba(225, 228, 232, 0.3) 1px, transparent 1px);
      background-size: 30px 30px; }
    .vehicle-marker { position: absolute; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transform: translate(-50%, -50%); transition: transform 0.2s ease; cursor: pointer; z-index: 5; }
    .vehicle-marker:hover { transform: translate(-50%, -50%) scale(1.4); z-index: 10; }
    .vehicle-marker::after {
      content: attr(data-route); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm);
      padding: 4px 6px; font-size: 10px; font-weight: 600; white-space: nowrap; box-shadow: var(--shadow-md);
      opacity: 0; pointer-events: none; transition: opacity 0.2s ease; color: var(--text-primary); margin-bottom: 4px;
    }
    .vehicle-marker:hover::after { opacity: 1; }

    .updates-list { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .update-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); display: flex; align-items: flex-start; gap: 12px; transition: background-color 0.3s ease; }
    .update-item:last-child { border-bottom: none; }
    .update-item.new { background-color: var(--primary-light); }
    .update-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; color: white; }
    .update-content { flex: 1; min-width: 0; }
    .update-text { font-size: 13px; color: var(--text-primary); line-height: 1.4; margin-bottom: 4px; }
    .update-time { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }

    .schedule-list { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .schedule-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 12px; transition: background-color 0.3s ease; }
    .schedule-item:last-child { border-bottom: none; }
    .schedule-item:hover { background: var(--surface-hover); }
    .schedule-item.updating { background: var(--primary-light); }
    .schedule-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; color: white; }
    .schedule-content { flex: 1; min-width: 0; }
    .schedule-route { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .schedule-time { font-size: 12px; color: var(--text-muted); }
    .schedule-delay { font-size: 11px; color: var(--warning); font-weight: 600; }

    .bottom-nav { background: var(--surface); border-top: 1px solid var(--border); padding: 8px 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex-shrink: 0; }
    .nav-button { padding: 8px 4px; border-radius: var(--radius-md); background: transparent; border: none; color: var(--text-muted); font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .nav-button.active { color: var(--primary); background: var(--primary-light); }
    .nav-button:hover { background: var(--surface-hover); }
    .nav-button:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    .nav-icon { font-size: 20px; }

    .live-indicator { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 600; color: var(--error); background: rgba(220, 58, 66, 0.1); padding: 2px 6px; border-radius: 10px; margin-left: 8px; }
    .live-indicator::before { content: ""; display: block; width: 6px; height: 6px; background: var(--error); border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:0.4} 100%{opacity:1} }

    .notification {
      position: fixed; top: 80px; right: 20px; background: var(--primary); color: white;
      padding: 12px 16px; border-radius: var(--radius-md); font-size: 13px; font-weight: 500;
      z-index: 1000; box-shadow: var(--shadow-lg); max-width: 300px;
    }

    .stat-number.updating { animation: numberUpdate 0.5s ease; }
    @keyframes numberUpdate { 0%{transform:scale(1)} 50%{transform:scale(1.1); color:var(--primary)} 100%{transform:scale(1)} }

    .network-banner {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1100;
      background: var(--warning); color: #111827; padding: 6px 12px; text-align: center; font-size: 12px; display: none;
    }
    .network-banner.online { background: var(--success); color: #fff; }
    .network-banner.show { display: block; }

    .sr-only {
      position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important;
      margin: -1px !important; overflow: hidden !important; clip: rect(0, 0, 0, 0) !important; white-space: nowrap !important; border: 0 !important;
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }
    @media (max-width: 380px) {
      .action-grid, .transport-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="network-banner" id="networkBanner" role="status" aria-live="polite"></div>
  <a href="#main" class="sr-only" id="skipLink">Skip to content</a>
  <div id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <div class="app">
    <header class="header">
      <div class="header-top">
        <div class="logo" aria-label="Mumbai Transport Hub">
          <div class="logo-icon"><i class="fa-solid fa-train-subway"></i></div>
          Mumbai Transport Hub
        </div>
        <div class="header-actions">
          <button class="header-btn" id="theme-toggle" aria-label="Switch theme" type="button">
            <i class="fa-solid fa-moon"></i>
          </button>
          <button class="header-btn" id="notifications-btn" aria-label="Notifications" type="button">
            <i class="fa-solid fa-bell"></i>
          </button>
        </div>
      </div>
      <div class="search-bar">
        <i class="fa-solid fa-magnifying-glass search-icon" aria-hidden="true"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="Search routes or destinations..." aria-label="Search routes or destinations" autocomplete="off" />
      </div>
    </header>

    <main class="content" id="main">
      <section aria-labelledby="modes-heading">
        <h2 class="section-title" id="modes-heading"><i class="fa-solid fa-bus"></i> Transport Modes <span class="live-indicator">LIVE</span></h2>
        <div class="transport-grid" role="tablist" aria-label="Transport modes">
          <button class="transport-card active" data-transport="bus" role="tab" aria-selected="true" type="button">
            <div class="card-header">
              <div class="bus-icon card-icon"><i class="fa-solid fa-bus"></i></div>
              <div class="card-title">BEST Buses</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="bus-count">1,247</span>
                <span class="stat-label">Active</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="bus-ontime">92%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="train" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="train-icon card-icon"><i class="fa-solid fa-train-subway"></i></div>
              <div class="card-title">Local Trains</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-delayed" aria-hidden="true"></span>
              <span class="card-status-text">Minor Delays</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="train-count">2,847</span>
                <span class="stat-label">Services</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="train-ontime">87%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="metro" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="metro-icon card-icon"><i class="fa-solid fa-train-tram"></i></div>
              <div class="card-title">Metro</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="metro-count">12</span>
                <span class="stat-label">Lines</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="metro-ontime">98%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="ferry" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="ferry-icon card-icon"><i class="fa-solid fa-ship"></i></div>
              <div class="card-title">Ferry</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="ferry-count">8</span>
                <span class="stat-label">Routes</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="ferry-ontime">95%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="monorail" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="mono-icon card-icon"><i class="fa-solid fa-train"></i></div>
              <div class="card-title">Monorail</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="monorail-count">1</span>
                <span class="stat-label">Line</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="monorail-ontime">94%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>
        </div>
      </section>

      <section aria-labelledby="live-heading">
        <h2 class="section-title" id="live-heading"><i class="fa-solid fa-map-location-dot"></i> Live Vehicle Tracking <span class="live-indicator">LIVE</span></h2>
        <div class="map-container">
          <div id="leafletMap" role="img" aria-label="Live map of Mumbai vehicles"></div>
          <div class="map-fallback" id="mapFallback" hidden>
            <div class="map-bg"></div>
            <div class="map-grid"></div>
            <div class="map-content" id="mapContent" aria-hidden="true"></div>
          </div>
        </div>
      </section>

      <section aria-labelledby="departures-heading">
        <h2 class="section-title" id="departures-heading"><i class="fa-solid fa-clock"></i> Next Departures</h2>
        <div class="schedule-list" id="scheduleList" role="list"></div>
      </section>

      <section aria-labelledby="actions-heading">
        <h2 class="section-title" id="actions-heading"><i class="fa-solid fa-bolt"></i> Quick Actions</h2>
        <div class="action-grid">
          <button class="action-button" id="buy-ticket" type="button">
            <span class="action-icon"><i class="fa-solid fa-ticket"></i></span>
            Buy Ticket
          </button>
          <button class="action-button" id="plan-journey" type="button">
            <span class="action-icon"><i class="fa-solid fa-route"></i></span>
            Plan Journey
          </button>
          <button class="action-button" id="nearby-stations" type="button">
            <span class="action-icon"><i class="fa-solid fa-map-pin"></i></span>
            Nearby Stations
          </button>
          <button class="action-button" id="recharge-card" type="button">
            <span class="action-icon"><i class="fa-solid fa-wallet"></i></span>
            Recharge Card
          </button>
        </div>
      </section>

      <section aria-labelledby="updates-heading">
        <h2 class="section-title" id="updates-heading"><i class="fa-solid fa-triangle-exclamation"></i> Service Updates</h2>
        <div class="updates-list" id="updatesList" role="feed" aria-live="polite"></div>
      </section>
    </main>

    <nav class="bottom-nav" role="navigation" aria-label="Primary">
      <button class="nav-button active" data-nav="home" type="button">
        <i class="nav-icon fa-solid fa-house"></i>
        Home
      </button>
      <button class="nav-button" data-nav="map" type="button">
        <i class="nav-icon fa-solid fa-map-location"></i>
        Map
      </button>
      <button class="nav-button" data-nav="tickets" type="button">
        <i class="nav-icon fa-solid fa-ticket"></i>
        Tickets
      </button>
      <button class="nav-button" data-nav="account" type="button">
        <i class="nav-icon fa-solid fa-user"></i>
        Account
      </button>
    </nav>
  </div>

  <noscript>
    <div class="notification" role="alert">This app needs JavaScript enabled.</div>
  </noscript>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <script>
    // Mumbai Transport Hub - robust single-file app
    (function() {
      const STORAGE_KEYS = {
        theme: 'mth.theme',
        transport: 'mth.transport'
      };

      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
      if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
      else document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');

      class MumbaiTransportHub {
        constructor() {
          this.appData = {
            selectedTransport: localStorage.getItem(STORAGE_KEYS.transport) || 'bus',
            theme: document.documentElement.getAttribute('data-theme') || 'light',
            vehicles: new Map(),
            leafletMarkers: new Map(),
            routes: this.initializeRoutes(),
            updates: [],
            searchTimer: null,
            reduceMotion: window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches
          };

          this.map = null;
          this.mapFallbackMode = false;
          this.vehicleBounds = { latMin: 18.85, latMax: 19.35, lngMin: 72.75, lngMax: 73.10 };
          this.timers = { vehicles: null, schedules: null, stats: null, updates: null };
          this.peakHours = [ {start: 7, end: 10}, {start: 18, end: 21} ];

          this.safeInit();
        }

        safeInit() {
          try {
            this.setupEventListeners();
            this.initMap();
            this.createInitialVehicles();
            this.restoreSelectedTransportUI();
            this.updateUI();
            this.startRealTimeUpdates();
            this.showNotification('🚌 Mumbai Transport Hub ready — live tracking active!');
            this.registerServiceWorker();
            this.setupNetworkBanner();
          } catch (e) {
            console.error('Initialization error:', e);
            this.showNotification('⚠️ Initialization failed. Some features may be limited.');
          }
        }

        initializeRoutes() {
          return {
            bus: [
              { id: 'A1E', name: 'A-1 Express', from: 'Colaba', to: 'Bandra', time: 3, delay: 0, passengers: 45, capacity: 70 },
              { id: '2L', name: '2Ltd', from: 'Mumbai Central', to: 'Bandra', time: 7, delay: 2, passengers: 52, capacity: 65 },
              { id: '37', name: '37', from: 'Santacruz', to: 'Colaba', time: 12, delay: 0, passengers: 38, capacity: 60 },
              { id: '54L', name: '54Ltd', from: 'Kurla', to: 'Colaba', time: 5, delay: 1, passengers: 41, capacity: 55 },
              { id: '85', name: '85', from: 'Borivali', to: 'Colaba', time: 15, delay: 0, passengers: 29, capacity: 70 },
              { id: '124', name: '124', from: 'Andheri', to: 'CST', time: 8, delay: 3, passengers: 56, capacity: 65 }
            ],
            train: [
              { id: 'WR_F', name: 'Western Fast', from: 'Borivali', to: 'Churchgate', time: 2, delay: 3, passengers: 1247, capacity: 1800 },
              { id: 'WR_S', name: 'Western Slow', from: 'Virar', to: 'Churchgate', time: 4, delay: 1, passengers: 1456, capacity: 1800 },
              { id: 'CR_F', name: 'Central Fast', from: 'Kalyan', to: 'CST', time: 6, delay: 0, passengers: 1523, capacity: 1800 },
              { id: 'HR', name: 'Harbour Line', from: 'Panvel', to: 'CST', time: 8, delay: 2, passengers: 987, capacity: 1800 },
              { id: 'TH', name: 'Trans-Harbour', from: 'Thane', to: 'Vashi', time: 11, delay: 1, passengers: 754, capacity: 1800 }
            ],
            metro: [
              { id: 'M1', name: 'Line 1 (Blue)', from: 'Versova', to: 'Ghatkopar', time: 1, delay: 0, passengers: 234, capacity: 1200 },
              { id: 'M2A', name: 'Line 2A (Yellow)', from: 'Dahisar', to: 'DN Nagar', time: 3, delay: 0, passengers: 156, capacity: 1200 },
              { id: 'M7', name: 'Line 7 (Red)', from: 'Andheri E', to: 'Dahisar E', time: 5, delay: 0, passengers: 198, capacity: 1200 },
              { id: 'M3', name: 'Line 3 (Pink)', from: 'Colaba', to: 'SEEPZ', time: 7, delay: 1, passengers: 267, capacity: 1200 }
            ],
            ferry: [
              { id: 'F1', name: 'Gateway-Elephanta', from: 'Gateway', to: 'Elephanta', time: 25, delay: 0, passengers: 89, capacity: 150 },
              { id: 'F2', name: 'Colaba-Alibaug', from: 'Colaba', to: 'Alibaug', time: 45, delay: 5, passengers: 67, capacity: 200 },
              { id: 'F3', name: 'Mazagon-Mandwa', from: 'Mazagon', to: 'Mandwa', time: 35, delay: 0, passengers: 43, capacity: 180 }
            ],
            monorail: [
              { id: 'MR1', name: 'Monorail Line 1', from: 'Chembur', to: 'Sant Gadge Maharaj Chowk', time: 4, delay: 0, passengers: 210, capacity: 600 }
            ]
          };
        }

        setupEventListeners() {
          document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());

          document.querySelectorAll('.transport-card').forEach(card => {
            card.addEventListener('click', () => {
              const transport = card.dataset.transport;
              this.selectTransport(transport);
            });
          });

          const searchInput = document.getElementById('searchInput');
          searchInput.addEventListener('input', (e) => {
            clearTimeout(this.appData.searchTimer);
            const q = e.target.value.trim();
            this.appData.searchTimer = setTimeout(() => this.performSearch(q), 220);
          });

          document.getElementById('buy-ticket').addEventListener('click', () =>
            this.showNotification('🎫 Redirecting to ticket booking...'));
          document.getElementById('plan-journey').addEventListener('click', () =>
            this.showNotification('🗺️ Opening route planner...'));
          document.getElementById('nearby-stations').addEventListener('click', () =>
            this.findNearbyStations());
          document.getElementById('recharge-card').addEventListener('click', () =>
            this.showNotification('💳 Opening recharge portal...'));

          document.querySelectorAll('.nav-button').forEach(btn => {
            btn.addEventListener('click', () => {
              document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              this.showNotification(`📱 ${btn.textContent.trim()} section`);
            });
          });

          document.addEventListener('visibilitychange', () => {
            if (document.hidden) this.pauseUpdates();
            else this.resumeUpdates();
          });

          window.addEventListener('beforeunload', () => this.cleanup());
        }

        initMap() {
          const fallback = document.getElementById('mapFallback');
          const leafletDiv = document.getElementById('leafletMap');
          try {
            if (window.L && leafletDiv) {
              this.map = L.map('leafletMap', { zoomControl: false, attributionControl: false }).setView([19.076, 72.8777], 11);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
              }).addTo(this.map);
              fallback.hidden = true;
              leafletDiv.hidden = false;
            } else {
              throw new Error('Leaflet not available yet');
            }
          } catch (e) {
            console.warn('Map init fallback:', e.message);
            this.mapFallbackMode = true;
            fallback.hidden = false;
            leafletDiv.hidden = true;
          }
        }

        createInitialVehicles() {
          const colors = { bus: '#5E6AD2', train: '#00B87A', metro: '#8B5CF6', ferry: '#0EA5E9', monorail: '#10B981' };
          const types = Object.keys(colors);
          const routes = ['A1E','2L','37','WR_F','CR_F','M1','M2A','F1','MR1'];

          for (let i = 0; i < 24; i++) {
            const type = types[i % types.length];
            const route = routes[i % routes.length];
            const lat = this.randomInRange(this.vehicleBounds.latMin, this.vehicleBounds.latMax);
            const lng = this.randomInRange(this.vehicleBounds.lngMin, this.vehicleBounds.lngMax);
            const dx = (Math.random() - 0.5) * 0.002;
            const dy = (Math.random() - 0.5) * 0.002;

            const vehicle = {
              id: `vehicle_${i}`,
              type, route,
              color: colors[type],
              lat, lng, dx, dy,
              speed: Math.random() * 0.8 + 0.2,
              lastUpdate: Date.now()
            };
            this.appData.vehicles.set(vehicle.id, vehicle);

            if (this.map && !this.mapFallbackMode) {
              const marker = L.circleMarker([vehicle.lat, vehicle.lng], {
                radius: 5, color: '#fff', weight: 1.5, fillColor: vehicle.color, fillOpacity: 1
              }).bindTooltip(`${vehicle.type.toUpperCase()} ${vehicle.route}`, { direction: 'top', offset: [0, -4] });
              marker.addTo(this.map);
              this.appData.leafletMarkers.set(vehicle.id, marker);
            }
          }
        }

        updateVehiclePositions() {
          try {
            const mapContent = document.getElementById('mapContent');
            if (this.mapFallbackMode && mapContent) {
              mapContent.querySelectorAll('.vehicle-marker').forEach(m => m.remove());
            }

            const deltaScale = this.appData.reduceMotion ? 0.5 : 1;
            this.appData.vehicles.forEach(v => {
              v.lat += v.dy * v.speed * deltaScale;
              v.lng += v.dx * v.speed * deltaScale;

              if (v.lat < this.vehicleBounds.latMin || v.lat > this.vehicleBounds.latMax) v.dy *= -1;
              if (v.lng < this.vehicleBounds.lngMin || v.lng > this.vehicleBounds.lngMax) v.dx *= -1;

              v.lat = Math.min(this.vehicleBounds.latMax, Math.max(this.vehicleBounds.latMin, v.lat));
              v.lng = Math.min(this.vehicleBounds.lngMax, Math.max(this.vehicleBounds.lngMin, v.lng));

              if (Math.random() < 0.03) {
                v.dx += (Math.random() - 0.5) * 0.0006;
                v.dy += (Math.random() - 0.5) * 0.0006;
              }

              if (this.map && !this.mapFallbackMode) {
                const marker = this.appData.leafletMarkers.get(v.id);
                if (marker) marker.setLatLng([v.lat, v.lng]);
              } else if (mapContent) {
                // Render fallback markers in a simple grid (not geo-accurate)
                const marker = document.createElement('div');
                marker.className = 'vehicle-marker';
                marker.style.backgroundColor = v.color;
                const xPct = ((v.lng - this.vehicleBounds.lngMin) / (this.vehicleBounds.lngMax - this.vehicleBounds.lngMin)) * 90 + 5;
                const yPct = ((v.lat - this.vehicleBounds.latMin) / (this.vehicleBounds.latMax - this.vehicleBounds.latMin)) * 90 + 5;
                marker.style.left = xPct + '%';
                marker.style.top = (100 - yPct) + '%';
                marker.setAttribute('data-route', v.route);
                marker.title = `${v.type.toUpperCase()} ${v.route} - Live tracking`;
                mapContent.appendChild(marker);
              }
            });
          } catch (e) {
            console.error('updateVehiclePositions error:', e);
          }
        }

        updateSchedules() {
          const scheduleList = document.getElementById('scheduleList');
          const transport = this.appData.selectedTransport;
          const routes = this.appData.routes[transport] || [];
          const nowHour = new Date().getHours();
          const isPeak = this.peakHours.some(p => nowHour >= p.start && nowHour <= p.end);

          routes.forEach(route => {
            if (Math.random() < 0.3) route.time = Math.max(1, route.time + (Math.random() > 0.5 ? -1 : 1));
            if (isPeak && Math.random() < 0.4) route.delay = Math.min(10, (route.delay || 0) + Math.floor(Math.random() * 2));
            else if (!isPeak && route.delay > 0 && Math.random() < 0.6) route.delay = Math.max(0, route.delay - 1);
          });

          scheduleList.innerHTML = '';

          const colors = { bus: '#5E6AD2', train: '#00B87A', metro: '#8B5CF6', ferry: '#0EA5E9', monorail: '#10B981' };
          const icons = { bus: 'fa-bus', train: 'fa-train-subway', metro: 'fa-train-tram', ferry: 'fa-ship', monorail: 'fa-train' };

          routes.slice(0, 8).forEach(route => {
            const item = document.createElement('div');
            item.className = 'schedule-item';
            const totalTime = (route.time || 0) + (route.delay || 0);
            const delayText = route.delay > 0 ? ` (+${route.delay} min delay)` : '';
            const occupancy = Math.min(100, Math.round((route.passengers / route.capacity) * 100));

            item.innerHTML = `
              <div class="schedule-icon" style="background: ${colors[transport]};"><i class="fa-solid ${icons[transport]}"></i></div>
              <div class="schedule-content">
                <div class="schedule-route">${route.name} • ${route.from} → ${route.to}</div>
                <div class="schedule-time">Next: ${totalTime} min${delayText} • ${occupancy}% full</div>
              </div>
            `;
            if (Math.random() < 0.15) {
              item.classList.add('updating');
              setTimeout(() => item.classList.remove('updating'), 900);
            }
            scheduleList.appendChild(item);
          });
        }

        updateStats() {
          const stats = {
            bus: { count: 1247, ontime: 92 },
            train: { count: 2847, ontime: 87 },
            metro: { count: 12, ontime: 98 },
            ferry: { count: 8, ontime: 95 },
            monorail: { count: 1, ontime: 94 }
          };
          Object.keys(stats).forEach(transport => {
            const countEl = document.getElementById(`${transport}-count`);
            const ontimeEl = document.getElementById(`${transport}-ontime`);
            if (!countEl || !ontimeEl) return;

            const countVariation = Math.floor(Math.random() * 10) - 5;
            const ontimeVariation = Math.floor(Math.random() * 4) - 2;
            const newCount = Math.max(0, stats[transport].count + countVariation);
            const newOntime = Math.max(70, Math.min(100, stats[transport].ontime + ontimeVariation));

            if (countEl.textContent !== newCount.toLocaleString()) {
              countEl.classList.add('updating');
              countEl.textContent = newCount.toLocaleString();
              setTimeout(() => countEl.classList.remove('updating'), 500);
            }
            if (ontimeEl.textContent !== `${newOntime}%`) {
              ontimeEl.classList.add('updating');
              ontimeEl.textContent = `${newOntime}%`;
              setTimeout(() => ontimeEl.classList.remove('updating'), 500);
            }

            const card = document.querySelector(`[data-transport="${transport}"]`);
            if (card) {
              const indicator = card.querySelector('.status-indicator');
              const statusText = card.querySelector('.card-status-text');
              if (newOntime >= 95) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = 'Operational';
              } else if (newOntime >= 85) {
                indicator.className = 'status-indicator status-delayed';
                statusText.textContent = 'Minor Delays';
              } else {
                indicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Major Delays';
              }
            }
          });
        }

        updateServiceUpdates() {
          const updatesList = document.getElementById('updatesList');
          const possible = [
            { type: 'success', icon: 'fa-circle-check', text: 'Metro Line 1 running at 2-min frequency during peak', category: 'metro' },
            { type: 'warning', icon: 'fa-triangle-exclamation', text: 'Western Line delays 3-5 min due to signal issue at Dadar', category: 'train' },
            { type: 'info', icon: 'fa-circle-info', text: 'BEST 2Ltd diverted via Linking Road (construction)', category: 'bus' },
            { type: 'success', icon: 'fa-ship', text: 'Ferry to Elephanta on schedule (every 30 min)', category: 'ferry' },
            { type: 'warning', icon: 'fa-cloud-rain', text: 'Heavy rain may impact bus timings. Plan extra time.', category: 'weather' },
            { type: 'info', icon: 'fa-tools', text: 'Central Line block Kurla-Ghatkopar 11 PM–4 AM (maintenance)', category: 'maintenance' }
          ];

          if (Math.random() < 0.1 && this.appData.updates.length < 6) {
            this.appData.updates.unshift({
              ...possible[Math.floor(Math.random() * possible.length)],
              id: Date.now(),
              time: new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date()),
              isNew: true
            });
          }

          updatesList.innerHTML = '';
          if (this.appData.updates.length === 0) {
            updatesList.innerHTML = `
              <div class="update-item">
                <div class="update-icon" style="background: var(--success);">
                  <i class="fa-solid fa-circle-check"></i>
                </div>
                <div class="update-content">
                  <div class="update-text">All Mumbai transport services operating normally</div>
                  <div class="update-time"><i class="fa-regular fa-clock"></i> ${new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date())}</div>
                </div>
              </div>
            `;
            return;
          }

          const colorMap = { success: 'var(--success)', warning: 'var(--warning)', info: 'var(--info)', error: 'var(--error)' };
          this.appData.updates.forEach(u => {
            const item = document.createElement('div');
            item.className = `update-item ${u.isNew ? 'new' : ''}`;
            item.innerHTML = `
              <div class="update-icon" style="background: ${colorMap[u.type]};"><i class="fa-solid ${u.icon}"></i></div>
              <div class="update-content">
                <div class="update-text">${u.text}</div>
                <div class="update-time"><i class="fa-regular fa-clock"></i> ${u.time}</div>
              </div>
            `;
            updatesList.appendChild(item);
            if (u.isNew) setTimeout(() => { u.isNew = false; }, 1500);
          });
        }

        selectTransport(transport) {
          this.appData.selectedTransport = transport;
          localStorage.setItem(STORAGE_KEYS.transport, transport);
          document.querySelectorAll('.transport-card').forEach(card => {
            const isActive = card.dataset.transport === transport;
            card.classList.toggle('active', isActive);
            card.setAttribute('aria-selected', String(isActive));
          });
          this.updateSchedules();
          this.showNotification(`🚌 Switched to ${transport.toUpperCase()} view`);
        }

        performSearch(query) {
          const scheduleList = document.getElementById('scheduleList');
          if (query.length < 2) {
            this.updateSchedules();
            return;
          }

          const allRoutes = [];
          const colors = { bus: '#5E6AD2', train: '#00B87A', metro: '#8B5CF6', ferry: '#0EA5E9', monorail: '#10B981' };
          const icons = { bus: 'fa-bus', train: 'fa-train-subway', metro: 'fa-train-tram', ferry: 'fa-ship', monorail: 'fa-train' };

          Object.keys(this.appData.routes).forEach(transport => {
            this.appData.routes[transport].forEach(route => allRoutes.push({ ...route, transport, color: colors[transport], icon: icons[transport] }));
          });

          const q = query.toLowerCase();
          const filtered = allRoutes.filter(route =>
            route.name.toLowerCase().includes(q) || route.from.toLowerCase().includes(q) || route.to.toLowerCase().includes(q)
          );

          scheduleList.innerHTML = '';
          if (filtered.length === 0) {
            scheduleList.innerHTML = `
              <div class="update-item">
                <div class="update-icon" style="background: var(--text-muted);">
                  <i class="fa-solid fa-magnifying-glass"></i>
                </div>
                <div class="update-content">
                  <div class="update-text">No routes found for "${this.escapeHtml(query)}"</div>
                  <div class="update-time">Try searching for route numbers or station names</div>
                </div>
              </div>
            `;
            return;
          }

          filtered.slice(0, 12).forEach(route => {
            const item = document.createElement('div');
            item.className = 'schedule-item';
            const totalTime = (route.time || 0) + (route.delay || 0);
            const delayText = route.delay > 0 ? ` (+${route.delay} min delay)` : '';
            item.innerHTML = `
              <div class="schedule-icon" style="background: ${route.color};"><i class="fa-solid ${route.icon}"></i></div>
              <div class="schedule-content">
                <div class="schedule-route">${route.name} • ${route.from} → ${route.to}</div>
                <div class="schedule-time">Next: ${totalTime} min${delayText} • ${route.transport.toUpperCase()}</div>
              </div>
            `;
            scheduleList.appendChild(item);
          });
        }

        findNearbyStations() {
          const stations = [
            'Churchgate Station - 0.3 km (Western Line)',
            'Marine Lines - 0.8 km (Western Line)',
            'Charni Road - 1.2 km (Western Line)',
            'CST Terminus - 1.5 km (Central/Harbour Lines)',
            'Ghatkopar Metro - 2.1 km (Metro Line 1)'
          ];
          this.showNotification(`📍 Nearby: ${stations[0]}`);
          setTimeout(() => this.showNotification(`📍 Found ${stations.length} stations within 3km radius`), 1500);
        }

        toggleTheme() {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          const newTheme = isDark ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem(STORAGE_KEYS.theme, newTheme);
          const themeIcon = document.querySelector('#theme-toggle i');
          themeIcon.className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
          this.showNotification(`${isDark ? '🌞' : '🌙'} Switched to ${newTheme} theme`);
        }

        showNotification(message) {
          const notification = document.createElement('div');
          notification.className = 'notification';
          notification.role = 'status';
          notification.textContent = message;
          document.body.appendChild(notification);
          const live = document.getElementById('liveRegion');
          if (live) live.textContent = message;

          setTimeout(() => {
            notification.remove();
          }, 2600);
        }

        updateUI() {
          this.updateVehiclePositions();
          this.updateSchedules();
          this.updateStats();
          this.updateServiceUpdates();
        }

        startRealTimeUpdates() {
          const vehicleInterval = this.appData.reduceMotion ? 3000 : 1800;
          this.timers.vehicles = setInterval(() => this.updateVehiclePositions(), vehicleInterval);
          this.timers.schedules = setInterval(() => this.updateSchedules(), 5000);
          this.timers.stats = setInterval(() => this.updateStats(), 8000);
          this.timers.updates = setInterval(() => this.updateServiceUpdates(), 15000);

          setInterval(() => {
            if (this.appData.updates.length > 8) this.appData.updates = this.appData.updates.slice(0, 6);
          }, 60000);
        }

        pauseUpdates() {
          Object.values(this.timers).forEach(t => t && clearInterval(t));
          this.timers = { vehicles: null, schedules: null, stats: null, updates: null };
        }
        resumeUpdates() {
          if (!this.timers.vehicles) this.startRealTimeUpdates();
        }
        cleanup() { this.pauseUpdates(); }

        restoreSelectedTransportUI() {
          const t = this.appData.selectedTransport;
          document.querySelectorAll('.transport-card').forEach(card => {
            const isActive = card.dataset.transport === t;
            card.classList.toggle('active', isActive);
            card.setAttribute('aria-selected', String(isActive));
          });
        }

        setupNetworkBanner() {
          const banner = document.getElementById('networkBanner');
          const update = () => {
            if (navigator.onLine) {
              banner.textContent = 'Online';
              banner.className = 'network-banner online show';
              setTimeout(() => banner.classList.remove('show'), 1200);
            } else {
              banner.textContent = 'You are offline. Showing cached data (if available).';
              banner.className = 'network-banner show';
            }
          };
          window.addEventListener('online', update);
          window.addEventListener('offline', update);
          update();
        }

        registerServiceWorker() {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => {
              console.warn('SW registration failed (ok if no sw.js yet):', err);
            });
          }
        }

        randomInRange(min, max) { return Math.random() * (max - min) + min; }
        escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
      }

      let transportHub;
      document.addEventListener('DOMContentLoaded', () => {
        transportHub = new MumbaiTransportHub();

        // Initial service update
        setTimeout(() => {
          transportHub.appData.updates.push({
            id: Date.now(),
            type: 'success',
            icon: 'fa-circle-check',
            text: 'Metro Line 1 running with 2-minute peak frequency',
            time: new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date()),
            isNew: true
          });
          transportHub.updateServiceUpdates();
        }, 2000);

        setInterval(() => {
          if (!document.hidden && Math.random() < 0.1) transportHub.updateUI();
        }, 30000);

        window.MumbaiTransport = transportHub;
      });
    })();
  </script>
</body>
</html>
