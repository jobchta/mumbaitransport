check if there needs to be improvements : <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#5E6AD2">
    <meta name="description" content="Real-time Mumbai public transport schedules, routes and updates">
    <title>MumbaiTransport.in</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <style>
        :root {
            --primary: #5E6AD2;
            --primary-dark: #4C56C4;
            --primary-light: #F1F2FD;
            --secondary: #8B92B2;
            --background: #FAFBFC;
            --surface: #FFFFFF;
            --surface-hover: #F7F8FA;
            --border: #E1E4E8;
            --border-light: #F1F3F4;
            --text-primary: #1D2125;
            --text-secondary: #626F86;
            --text-muted: #8B92B2;
            --success: #00B87A;
            --warning: #F79009;
            --error: #DC3A42;
            --info: #0EA5E9;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        [data-theme="dark"] {
            --background: #0F1419;
            --surface: #1A1D23;
            --surface-hover: #222530;
            --border: #2D3442;
            --border-light: #252932;
            --text-primary: #FFFFFF;
            --text-secondary: #9CA3AF;
            --text-muted: #6B7280;
            --primary-light: rgba(94, 106, 210, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px 12px;
            position: relative;
            z-index: 100;
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
        }

        [data-theme="dark"] .header {
            background: rgba(26, 29, 35, 0.9);
        }

        .header-top { display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 18px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.2px; display: flex; align-items: center; gap: 8px; }
        .logo-icon { width: 28px; height: 28px; background: var(--primary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; }
        .header-actions { display: flex; gap: 10px; }
        .header-btn { width: 36px; height: 36px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; background: var(--background); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; }
        .header-btn:hover { background: var(--surface-hover); }
        .header-btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.3); }

        .search-bar { position: relative; }
        .search-input { width: 100%; padding: 12px 16px 12px 44px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; color: var(--text-primary); outline: none; transition: all 0.2s ease; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.1); }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 16px; }

        .content {
            flex: 1;
            padding: 16px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .section-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .section-title i { color: var(--primary); }

        .transport-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        .transport-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; transition: all 0.2s ease; cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column; gap: 8px; }
        .transport-card.active { border-color: var(--primary); background: var(--primary-light); }
        .transport-card:focus { outline: none; box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.3); }
        .card-header { display: flex; align-items: center; gap: 10px; }
        .card-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; flex-shrink: 0; }
        .bus-icon { background: var(--primary); }
        .train-icon { background: var(--success); }
        .metro-icon { background: #8B5CF6; }
        .ferry-icon { background: var(--info); }
        .card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); line-height: 1.2; }
        .card-status { display: flex; align-items: center; gap: 6px; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; }
        .status-active { background: var(--success); }
        .status-delayed { background: var(--warning); }
        .status-offline { background: var(--error); }
        .card-status-text { font-size: 12px; color: var(--text-muted); }
        .card-stats { display: flex; justify-content: space-between; margin-top: auto; padding-top: 8px; }
        .stat { text-align: center; flex: 1; }
        .stat-number { font-size: 16px; font-weight: 700; color: var(--text-primary); line-height: 1; }
        .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

        .action-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .action-button { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px; font-size: 13px; color: var(--text-secondary); font-weight: 500; cursor: pointer; transition: all 0.2s ease; text-align: left; display: flex; align-items: center; gap: 10px; }
        .action-button:focus { outline: none; box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.3); }
        .action-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 16px; flex-shrink: 0; }
        
        .map-container { height: 200px; border-radius: var(--radius-lg); overflow: hidden; position: relative; border: 1px solid var(--border); }
        .mapboxgl-map { width: 100%; height: 100%; }
        .mapboxgl-ctrl-logo, .mapboxgl-ctrl-attrib { display: none; }
        .map-controls { position: absolute; top: 12px; right: 12px; z-index: 2; display: flex; gap: 8px; }
        .map-btn { background: var(--surface); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md); cursor: pointer; transition: all 0.3s ease; color: var(--text-muted); }
        .map-btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.3); }
        
        .updates-list { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
        .update-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); display: flex; align-items: flex-start; gap: 12px; }
        .update-item:last-child { border-bottom: none; }
        .update-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; color: white; }
        .update-content { flex: 1; min-width: 0; }
        .update-text { font-size: 13px; color: var(--text-primary); line-height: 1.4; margin-bottom: 4px; }
        .update-time { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }

        .bottom-nav { background: var(--surface); border-top: 1px solid var(--border); padding: 8px 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex-shrink: 0; }
        .nav-button { padding: 8px 4px; border-radius: var(--radius-md); background: transparent; border: none; color: var(--text-muted); font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-button.active { color: var(--primary); }
        .nav-button:focus { outline: none; box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.3); }
        .nav-icon { font-size: 20px; }

        .offline-banner { background: var(--warning); color: white; padding: 8px 20px; font-size: 12px; text-align: center; font-weight: 500; display: none; }
        .offline-banner.show { display: block; }

        .loading { display: flex; justify-content: center; padding: 16px; }
        .loading-spinner { width: 24px; height: 24px; border: 3px solid rgba(94, 106, 210, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--surface); border-radius: var(--radius-lg); width: 90%; max-width: 400px; max-height: 90vh; display: flex; flex-direction: column; transform: translateY(20px); transition: transform 0.3s ease; }
        .modal.active .modal-content { transform: translateY(0); }
        .modal-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .modal-close { background: none; border: none; font-size: 20px; color: var(--text-muted); cursor: pointer; }
        .modal-body { padding: 16px; overflow-y: auto; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-muted); font-weight: 500; }
        .form-input { width: 100%; padding: 12px 16px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; color: var(--text-primary); outline: none; transition: all 0.2s ease; }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.1); }
        .form-submit { background: var(--primary); color: white; border: none; border-radius: var(--radius-md); padding: 14px; font-size: 14px; font-weight: 600; width: 100%; cursor: pointer; transition: background 0.2s ease; }
        .form-submit:hover { background: var(--primary-dark); }
        .form-submit:disabled { background: var(--text-muted); cursor: not-allowed; }
        
        .route-results { margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px; }
        .route-option { padding: 12px; border-radius: var(--radius-md); background: var(--background); margin-bottom: 12px; border: 1px solid var(--border); cursor: pointer; }
        .route-option:hover { border-color: var(--primary); }
        .route-option:focus { outline: none; box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.3); }
        .route-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .route-summary { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
        .route-icon { width: 24px; height: 24px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        .route-info { display: flex; flex-direction: column; align-items: flex-end; }
        .route-duration { font-weight: 600; font-size: 14px; }
        .route-distance { font-size: 12px; color: var(--text-muted); }

        .schedule-list { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
        .schedule-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 12px; }
        .schedule-item:last-child { border-bottom: none; }
        .schedule-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; color: white; }
        .schedule-content { flex: 1; min-width: 0; }
        .schedule-route { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .schedule-time { font-size: 12px; color: var(--text-muted); }

        .empty-state { padding: 24px; text-align: center; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .empty-icon { font-size: 24px; color: var(--text-muted); }

        @media (max-width: 380px) {
            .action-grid, .transport-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Geocoder styles */
        .geocoder-container {
            margin-bottom: 10px;
            position: relative;
        }
        .mapboxgl-ctrl-geocoder {
            width: 100%;
            max-width: none;
            box-shadow: none;
            border: 1px solid var(--border);
            background-color: var(--background);
            border-radius: var(--radius-md);
        }
        .mapboxgl-ctrl-geocoder input[type="text"] {
            padding: 12px 16px !important;
            height: auto;
            color: var(--text-primary);
            background-color: var(--background);
            border-radius: var(--radius-md);
        }
        .mapboxgl-ctrl-geocoder--icon-search {
            top: 50%;
            transform: translateY(-50%);
            left: 12px;
        }
        .mapboxgl-ctrl-geocoder--input {
            padding-left: 44px !important;
        }
        .mapboxgl-ctrl-geocoder svg path {
            fill: var(--text-muted);
        }
        .mapboxgl-ctrl-geocoder .suggestions {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
        }
        .mapboxgl-ctrl-geocoder .suggestions > li > a {
            color: var(--text-primary);
        }
        .mapboxgl-ctrl-geocoder .suggestions > li > a:hover {
            background-color: var(--surface-hover);
        }
        .mapboxgl-ctrl-geocoder--suggestion-active > a {
            background-color: var(--primary-light) !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // Mapbox token
        const MAPBOX_TOKEN = 'pk.eyJ1IjoibXVtYmFpdHJhbnNwb3J0IiwiYSI6ImNtZTJzZmRjeDA4dzgyanM4Ynp1YXdsdjQifQ.FiuY5kDVDHC7x9Yr8h5wCw';
        const BEST_API_URL = 'https://api.bestundertaking.com/v1';
        const MUMBAI_METRO_API = 'https://api.mumbaimetro.in/v1';
        const RAILWAY_API = 'https://indianrailapi.com/api/v2';
        const FERRY_API = 'https://api.mumbaiferry.in/v1';
        const CACHE_NAME = 'mumbai-transport-v2';

        function MumbaiTransportApp() {
            // State management
            const [theme, setTheme] = React.useState(localStorage.getItem('theme') || 'light');
            const [isOnline, setIsOnline] = React.useState(navigator.onLine);
            const [updates, setUpdates] = React.useState([]);
            const [selectedMode, setSelectedMode] = React.useState('bus');
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [routeResults, setRouteResults] = React.useState([]);
            const [schedules, setSchedules] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(false);
            const [searchQuery, setSearchQuery] = React.useState('');
            const [activeNav, setActiveNav] = React.useState('home');
            const [transportStatus, setTransportStatus] = React.useState({
                bus: 'active',
                train: 'delayed',
                metro: 'active',
                ferry: 'active'
            });
            
            // Refs
            const mapRef = React.useRef(null);
            const mapContainerRef = React.useRef(null);
            const userMarkerRef = React.useRef(null);
            const startLocationRef = React.useRef(null);
            const endLocationRef = React.useRef(null);
            const geocoderRefs = React.useRef({ start: null, end: null });

            // Theme and online status setup
            React.useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);

                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, [theme]);

            // Map initialization
            React.useEffect(() => {
                if (mapRef.current) return; // initialize map only once
                
                mapboxgl.accessToken = MAPBOX_TOKEN;
                mapboxgl.workerUrl = 'https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl-csp-worker.js';
                
                mapRef.current = new mapboxgl.Map({
                    container: mapContainerRef.current,
                    style: 'mapbox://styles/mapbox/standard',
                    center: [72.8777, 19.0760], // Mumbai coordinates
                    zoom: 11,
                    attributionControl: false
                });

                mapRef.current.on('load', () => {
                    mapRef.current.setConfigProperty('basemap', 'showPlaceLabels', true);
                    mapRef.current.setConfigProperty('basemap', 'showPointOfInterestLabels', true);
                    fetchTransportStatus();
                    fetchSchedules(selectedMode);
                    addUpdate("Welcome to MumbaiTransport! Loading real-time data...", "info");
                });

                return () => {
                    if (mapRef.current) {
                        mapRef.current.remove();
                        mapRef.current = null;
                    }
                };
            }, []);
            
            // Initialize geocoders when modal opens
            React.useEffect(() => {
                if (isModalOpen && mapRef.current && window.MapboxGeocoder) {
                    const geocoderOptions = (placeholder) => ({
                        accessToken: MAPBOX_TOKEN,
                        mapboxgl: mapboxgl,
                        placeholder: placeholder,
                        proximity: { longitude: 72.8777, latitude: 19.0760 },
                        countries: 'in',
                        bbox: [72.7758, 18.8938, 72.9986, 19.2550], // Bounding box for Mumbai
                        marker: false,
                        flyTo: false,
                        types: 'address,poi,place,locality,neighborhood'
                    });

                    if (!geocoderRefs.current.start) {
                        const startGeocoder = new MapboxGeocoder(geocoderOptions('Start Location'));
                        startGeocoder.addTo('#start-location-container');
                        geocoderRefs.current.start = startGeocoder;
                    }

                    if (!geocoderRefs.current.end) {
                        const endGeocoder = new MapboxGeocoder(geocoderOptions('Destination'));
                        endGeocoder.addTo('#end-location-container');
                        geocoderRefs.current.end = endGeocoder;
                    }
                }
            }, [isModalOpen]);

            // Fetch transport status
            const fetchTransportStatus = async () => {
                try {
                    setIsLoading(true);
                    
                    // Simulate API calls
                    await new Promise(resolve => setTimeout(resolve, 800));
                    setTransportStatus({
                        bus: Math.random() > 0.8 ? 'delayed' : 'active',
                        train: Math.random() > 0.6 ? 'delayed' : 'active',
                        metro: 'active',
                        ferry: Math.random() > 0.9 ? 'offline' : 'active'
                    });
                    
                    setIsLoading(false);
                } catch (error) {
                    console.error('Error fetching transport status:', error);
                    addUpdate('Failed to load transport status.', 'error');
                    setIsLoading(false);
                }
            };

            // Theme toggle
            const toggleTheme = () => {
                setTheme(prev => (prev === 'light' ? 'dark' : 'light'));
            };

            // Transport mode selection
            const selectTransportMode = (mode) => {
                setSelectedMode(mode);
                fetchSchedules(mode);
                if ('vibrate' in navigator) navigator.vibrate(10);
            };

            // Add service update
            const addUpdate = (message, type = 'info') => {
                setUpdates(prev => [
                    {
                        id: Date.now(),
                        message,
                        type,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    },
                    ...prev.slice(0, 4)
                ]);
            };

            // Fetch schedules for selected transport mode
            const fetchSchedules = async (mode = selectedMode) => {
                setIsLoading(true);
                try {
                    await new Promise(resolve => setTimeout(resolve, 500)); // Simulate network delay
                    const simulatedResponse = simulateApiResponse(mode);
                    const processedSchedules = processSchedules(simulatedResponse, mode);
                    setSchedules(processedSchedules);
                    addUpdate(`Successfully loaded ${mode} schedules`, 'success');
                } catch (error) {
                    console.error(`Error fetching ${mode} schedules:`, error);
                    addUpdate(`Failed to load ${mode} schedules.`, 'error');
                    setSchedules([]);
                } finally {
                    setIsLoading(false);
                }
            };

            // Simulate API responses with realistic data
            const simulateApiResponse = (mode) => {
                const now = new Date();
                const currentHour = now.getHours();
                const isPeakHours = (currentHour >= 7 && currentHour <= 11) || (currentHour >= 17 && currentHour <= 21);
                
                const getNextTime = (base, i, interval) => {
                    const delay = isPeakHours ? Math.random() * 3 : Math.random() * 8;
                    return new Date(base.getTime() + (i * interval + delay) * 60000);
                };

                const formatTime = (date) => date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const baseData = {
                    bus: {
                        schedules: [
                            { route: 'A-1 Express', time: formatTime(getNextTime(now, 1, 5)), destination: 'Colaba Depot', status: 'On Time' },
                            { route: 'C-72', time: formatTime(getNextTime(now, 2, 7)), destination: 'Vikroli Depot', status: 'Delayed' },
                            { route: '27', time: formatTime(getNextTime(now, 3, 6)), destination: 'Worli', status: 'On Time' },
                            { route: '84 LTD', time: formatTime(getNextTime(now, 4, 8)), destination: 'Andheri Stn (W)', status: 'On Time' },
                            { route: '33', time: formatTime(getNextTime(now, 5, 5)), destination: 'Anik Depot', status: 'Delayed' }
                        ]
                    },
                    train: {
                        Trains: [
                            { TrainNo: '90768', TrainName: 'CSMT-Slow', DepartureTime: formatTime(getNextTime(now, 1, 4)), Destination: 'Thane', Delay: '5 min' },
                            { TrainNo: '97411', TrainName: 'Vadala-Fast', DepartureTime: formatTime(getNextTime(now, 2, 6)), Destination: 'Panvel', Delay: 'On Time' },
                            { TrainNo: '92112', TrainName: 'Churchgate-Slow', DepartureTime: formatTime(getNextTime(now, 3, 3)), Destination: 'Borivali', Delay: 'On Time' },
                            { TrainNo: '94425', TrainName: 'CSMT-Harbour', DepartureTime: formatTime(getNextTime(now, 4, 7)), Destination: 'Andheri', Delay: '10 min' },
                            { TrainNo: '90012', TrainName: 'Churchgate-Fast', DepartureTime: formatTime(getNextTime(now, 5, 5)), Destination: 'Virar', Delay: 'On Time' }
                        ]
                    },
                    metro: {
                        schedules: [
                            { line: '1', train: 'M203', time: formatTime(getNextTime(now, 1, 5)), destination: 'Ghatkopar', status: 'On Time' },
                            { line: '1', train: 'M204', time: formatTime(getNextTime(now, 2, 5)), destination: 'Versova', status: 'On Time' },
                            { line: '2A', train: 'M408', time: formatTime(getNextTime(now, 3, 8)), destination: 'Dahisar East', status: 'On Time' },
                            { line: '7', train: 'M705', time: formatTime(getNextTime(now, 4, 8)), destination: 'Gundavali', status: 'On Time' },
                            { line: '1', train: 'M205', time: formatTime(getNextTime(now, 5, 5)), destination: 'Ghatkopar', status: 'On Time' }
                        ]
                    },
                    ferry: {
                        schedules: [
                            { route: 'Gateway - Elephanta', time: formatTime(getNextTime(now, 1, 30)), destination: 'Elephanta', status: 'On Time' },
                            { route: 'Gateway - Mandwa', time: formatTime(getNextTime(now, 2, 15)), destination: 'Mandwa', status: 'On Time' },
                            { route: 'Gateway - Elephanta', time: formatTime(getNextTime(now, 3, 30)), destination: 'Elephanta', status: 'Delayed' },
                            { route: 'Gorai - Borivali', time: formatTime(getNextTime(now, 4, 40)), destination: 'Borivali', status: 'On Time' },
                            { route: 'Gateway - Mandwa', time: formatTime(getNextTime(now, 5, 60)), destination: 'Mandwa', status: 'On Time' }
                        ]
                    }
                };
                return baseData[mode];
            };

            // Process schedules into consistent format
            const processSchedules = (data, mode) => {
                switch (mode) {
                    case 'bus': return data.schedules.map(item => ({ ...item, mode }));
                    case 'train': return data.Trains.map(item => ({ mode, route: `${item.TrainName} (${item.TrainNo})`, time: item.DepartureTime, destination: item.Destination, status: item.Delay === 'On Time' ? 'On Time' : `Delayed (${item.Delay})` }));
                    case 'metro': return data.schedules.map(item => ({ mode, route: `Line ${item.line} - Train ${item.train}`, time: item.time, destination: item.destination, status: item.status }));
                    case 'ferry': return data.schedules.map(item => ({ ...item, mode }));
                    default: return [];
                }
            };

            // Locate user on map
            const locateUser = () => {
                if (!mapRef.current) return;
                
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            const userCoords = [longitude, latitude];
                            mapRef.current.flyTo({ center: userCoords, zoom: 15 });
                            if (userMarkerRef.current) {
                                userMarkerRef.current.setLngLat(userCoords);
                            } else {
                                userMarkerRef.current = new mapboxgl.Marker({ color: '#5E6AD2' }).setLngLat(userCoords).addTo(mapRef.current);
                            }
                            addUpdate('Your location has been found', 'success');
                        },
                        error => {
                            console.error('Error getting location:', error);
                            addUpdate('Could not retrieve your location.', 'error');
                        },
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                } else {
                    addUpdate('Geolocation is not supported by your browser', 'error');
                }
            };

            // Improved geocodeLocation function
            const geocodeLocation = async (query) => {
                if (!query || typeof query !== 'string' || query.trim() === '') {
                    throw new Error('Please enter a valid location');
                }
                try {
                    const response = await fetch(
                        `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
                        `access_token=${MAPBOX_TOKEN}&proximity=72.8777,19.0760&limit=1&bbox=72.7758,18.8938,72.9986,19.2550`
                    );
                    if (!response.ok) throw new Error(`Geocoding API error: ${response.status}`);
                    const data = await response.json();
                    if (!data.features || data.features.length === 0) throw new Error('Location not found. Please try a different name.');
                    const [lng, lat] = data.features[0].center;
                    if (isNaN(lng) || isNaN(lat)) throw new Error('Invalid coordinates received from server');
                    return { coords: [lng, lat], name: data.features[0].place_name };
                } catch (error) {
                    console.error('Geocoding error:', error);
                    throw new Error(`Location search failed: ${error.message}`);
                }
            };

            // Robust route search handler
            const handleRouteSearch = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setRouteResults([]);
                
                try {
                    const startQuery = geocoderRefs.current.start?.getInputValue()?.trim();
                    const endQuery = geocoderRefs.current.end?.getInputValue()?.trim();

                    if (!startQuery || !endQuery) throw new Error('Please enter both start and end locations');
                    if (startQuery === endQuery) throw new Error('Start and end locations must be different');

                    const [start, end] = await Promise.all([geocodeLocation(startQuery), geocodeLocation(endQuery)]);

                    if (!isValidCoordinate(start.coords) || !isValidCoordinate(end.coords)) throw new Error('Invalid route coordinates received');

                    const profiles = ['driving', 'walking', 'cycling'];
                    const promises = profiles.map(profile =>
                        fetch(`https://api.mapbox.com/directions/v5/mapbox/${profile}/${start.coords.join(',')};${end.coords.join(',')}?geometries=geojson&access_token=${MAPBOX_TOKEN}`)
                        .then(res => res.ok ? res.json() : Promise.reject(new Error(res.statusText)))
                        .then(data => ({ ...data, profile }))
                        .catch(() => null) // Return null on error for a specific profile
                    );
                    
                    const results = await Promise.all(promises);
                    const validRoutes = results.filter(result => result && result.routes && result.routes.length > 0);

                    if (validRoutes.length === 0) throw new Error('No routes found between these locations');
                    
                    // Sort to prioritize public transit if available, then driving
                    validRoutes.sort((a, b) => {
                        if (a.profile === 'transit') return -1;
                        if (b.profile === 'transit') return 1;
                        if (a.profile === 'driving') return -1;
                        if (b.profile === 'driving') return 1;
                        return 0;
                    });
                    
                    const processedResults = validRoutes.map(result => ({
                        geometry: result.routes[0].geometry,
                        duration: result.routes[0].duration,
                        distance: result.routes[0].distance,
                        profile: result.profile,
                        startName: start.name,
                        endName: end.name
                    }));

                    setRouteResults(processedResults);
                    drawRouteOnMap(processedResults[0].geometry);
                    addUpdate(`Route found from ${start.name.split(',')[0]} to ${end.name.split(',')[0]}`, 'success');

                } catch (error) {
                    console.error('Route search error:', error);
                    addUpdate(error.message, 'error');
                    setRouteResults([{ message: error.message, type: 'error' }]);
                } finally {
                    setIsLoading(false);
                }
            };

            // Coordinate validation helper
            const isValidCoordinate = (coord) => (
                Array.isArray(coord) && coord.length === 2 && !isNaN(coord[0]) && !isNaN(coord[1]) && Math.abs(coord[0]) <= 180 && Math.abs(coord[1]) <= 90
            );

            // Draw route on map
            const drawRouteOnMap = (geometry) => {
                if (!mapRef.current) return;
                
                if (mapRef.current.getLayer('route')) {
                    mapRef.current.removeLayer('route');
                    mapRef.current.removeSource('route');
                }
                
                mapRef.current.addSource('route', { type: 'geojson', data: { type: 'Feature', properties: {}, geometry } });
                mapRef.current.addLayer({
                    id: 'route',
                    type: 'line',
                    source: 'route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#5E6AD2', 'line-width': 6, 'line-opacity': 0.8 }
                });
                
                const bounds = new mapboxgl.LngLatBounds();
                geometry.coordinates.forEach(coord => bounds.extend(coord));
                mapRef.current.fitBounds(bounds, { padding: { top: 20, bottom: 40, left: 20, right: 20 } });
            };

            // Helper maps for icons and colors
            const iconMap = {
                info: 'fa-circle-info', warning: 'fa-triangle-exclamation', error: 'fa-circle-exclamation', success: 'fa-circle-check',
                bus: 'fa-bus', train: 'fa-train-subway', metro: 'fa-train-tram', ferry: 'fa-ship',
                driving: 'fa-car', walking: 'fa-person-walking', cycling: 'fa-bicycle'
            };
            const colorMap = {
                info: 'var(--info)', warning: 'var(--warning)', error: 'var(--error)', success: 'var(--success)',
                bus: 'var(--primary)', train: 'var(--success)', metro: '#8B5CF6', ferry: 'var(--info)',
                driving: 'var(--primary)', walking: '#e55f25', cycling: '#2596be'
            };

            return (
                <div className="app">
                    <header className="header">
                        <div className="header-top">
                            <div className="logo">
                                <div className="logo-icon"><i className="fa-solid fa-route"></i></div>
                                MumbaiTransport
                            </div>
                            <div className="header-actions">
                                <button className="header-btn" onClick={toggleTheme} aria-label={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}>
                                    <i className={`fa-solid ${theme === 'light' ? 'fa-moon' : 'fa-sun'}`}></i>
                                </button>
                            </div>
                        </div>
                        <div className="search-bar">
                            <i className="fa-solid fa-magnifying-glass search-icon"></i>
                            <input type="text" className="search-input" placeholder="Search routes or destinations..." aria-label="Search routes or destinations" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                        </div>
                    </header>
                    
                    <main className="content">
                        <section>
                            <h2 className="section-title"><i className="fa-solid fa-bus"></i> Transport Modes</h2>
                            <div className="transport-grid">
                                {['bus', 'train', 'metro', 'ferry'].map(mode => (
                                    <div key={mode} className={`transport-card ${selectedMode === mode ? 'active' : ''}`} onClick={() => selectTransportMode(mode)} role="button" tabIndex={0} onKeyDown={e => e.key === 'Enter' && selectTransportMode(mode)} aria-label={`Select ${mode} mode`}>
                                        <div className="card-header">
                                            <div className={`${mode}-icon card-icon`}><i className={`fa-solid ${iconMap[mode]}`}></i></div>
                                            <div className="card-title">{mode.charAt(0).toUpperCase() + mode.slice(1)}</div>
                                        </div>
                                        <div className="card-status">
                                            <span className={`status-indicator status-${transportStatus[mode]}`}></span>
                                            <span className="card-status-text">{transportStatus[mode] === 'active' ? 'Operational' : transportStatus[mode] === 'delayed' ? 'Minor Delays' : 'Offline'}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                        
                        <section>
                            <h2 className="section-title"><i className="fa-solid fa-clock"></i> Schedules for {selectedMode.charAt(0).toUpperCase() + selectedMode.slice(1)}</h2>
                            {isLoading && schedules.length === 0 ? (
                                <div className="loading"><div className="loading-spinner"></div></div>
                            ) : schedules.length > 0 ? (
                                <div className="schedule-list">
                                    {schedules.map((schedule, index) => (
                                        <div key={index} className="schedule-item">
                                            <div className="schedule-icon" style={{ background: colorMap[schedule.mode] }}><i className={`fa-solid ${iconMap[schedule.mode]}`}></i></div>
                                            <div className="schedule-content">
                                                <div className="schedule-route">{schedule.route}</div>
                                                <div className="schedule-time">{schedule.time} to {schedule.destination}
                                                    {schedule.status !== 'On Time' && <span style={{ color: 'var(--warning)', marginLeft: '8px' }}>({schedule.status})</span>}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="empty-state"><i className="fa-solid fa-calendar-xmark empty-icon"></i><p>No schedules available</p></div>
                            )}
                        </section>
                        
                        <section>
                            <h2 className="section-title"><i className="fa-solid fa-bolt"></i> Quick Actions</h2>
                            <div className="action-grid">
                                <button className="action-button" onClick={() => setIsModalOpen(true)} aria-label="Plan a route"><span className="action-icon"><i className="fa-solid fa-map-location-dot"></i></span> Plan a Route</button>
                                <button className="action-button" onClick={() => document.querySelector('.schedule-list')?.scrollIntoView({ behavior: 'smooth' })} aria-label="View schedules"><span className="action-icon"><i className="fa-solid fa-clock"></i></span> View Schedules</button>
                            </div>
                        </section>
                        
                        <section>
                            <h2 className="section-title"><i className="fa-solid fa-map"></i> Map</h2>
                            <div className="map-container" ref={mapContainerRef}>
                                <div className="map-controls">
                                    <button className="map-btn" onClick={locateUser} aria-label="Locate me"><i className="fa-solid fa-location-crosshairs"></i></button>
                                </div>
                            </div>
                        </section>
                        
                        <section>
                            <h2 className="section-title"><i className="fa-solid fa-satellite-dish"></i> Service Updates</h2>
                            {updates.length > 0 ? (
                                <div className="updates-list">
                                    {updates.map(update => (
                                        <div key={update.id} className="update-item">
                                            <div className="update-icon" style={{ background: colorMap[update.type] }}><i className={`fa-solid ${iconMap[update.type]}`}></i></div>
                                            <div className="update-content">
                                                <div className="update-text">{update.message}</div>
                                                <div className="update-time"><i className="fa-regular fa-clock"></i> {update.time}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="empty-state"><i className="fa-solid fa-bell-slash empty-icon"></i><p>No updates available</p></div>
                            )}
                        </section>
                    </main>
                    
                    <nav className="bottom-nav">
                        {['home', 'map', 'schedules', 'profile'].map(nav => (
                            <button key={nav} className={`nav-button ${activeNav === nav ? 'active' : ''}`} onClick={() => setActiveNav(nav)} aria-label={nav.charAt(0).toUpperCase() + nav.slice(1)}>
                                <i className={`nav-icon fa-solid fa-${nav === 'home' ? 'house' : nav === 'map' ? 'map-location' : nav === 'schedules' ? 'clock' : 'user'}`}></i>
                                {nav.charAt(0).toUpperCase() + nav.slice(1)}
                            </button>
                        ))}
                    </nav>
                    
                    <div className={`offline-banner ${!isOnline ? 'show' : ''}`}><i className="fa-solid fa-wifi"></i> You're offline. Showing cached data.</div>
                    
                    <div className={`modal ${isModalOpen ? 'active' : ''}`}>
                        <div className="modal-content">
                            <div className="modal-header">
                                <h3 className="modal-title">Plan Your Route</h3>
                                <button className="modal-close" onClick={() => setIsModalOpen(false)} aria-label="Close route planner">&times;</button>
                            </div>
                            <div className="modal-body">
                                <form onSubmit={handleRouteSearch}>
                                    <div className="form-group">
                                        <label className="form-label">Start Location</label>
                                        <div id="start-location-container" className="geocoder-container"></div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Destination</label>
                                        <div id="end-location-container" className="geocoder-container"></div>
                                    </div>
                                    <button className="form-submit" type="submit" disabled={isLoading} aria-busy={isLoading}>
                                        {isLoading ? <div className="loading-spinner" style={{ margin: '0 auto', width: '20px', height: '20px' }}></div> : 'Find Route'}
                                    </button>
                                </form>
                                <div className="route-results">
                                    {routeResults.length > 0 ? (
                                        routeResults.map((result, index) => (
                                            result.message ? (
                                                <div key={index} className="route-option" style={{ color: 'var(--error)' }}>{result.message}</div>
                                            ) : (
                                                <div key={index} className="route-option" onClick={() => drawRouteOnMap(result.geometry)} role="button" tabIndex={0} onKeyDown={e => e.key === 'Enter' && drawRouteOnMap(result.geometry)} aria-label={`Route from ${result.startName} to ${result.endName}`}>
                                                    <div className="route-header">
                                                        <div className="route-summary">
                                                            <div className="route-icon" style={{ background: colorMap[result.profile] }}><i className={`fa-solid ${iconMap[result.profile]}`}></i></div>
                                                            <span style={{ textTransform: 'capitalize' }}>{result.profile}</span>
                                                        </div>
                                                        <div className="route-info">
                                                            <div className="route-duration">{Math.round(result.duration / 60)} min</div>
                                                            <div className="route-distance">{(result.distance / 1000).toFixed(1)} km</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )
                                        ))
                                    ) : !isLoading && (
                                        <div className="empty-state"><i className="fa-solid fa-directions empty-icon"></i><p>Enter locations to find routes</p></div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Start the app
        ReactDOM.render(<MumbaiTransportApp />, document.getElementById('root'));
    </script>
</body>
</html>
