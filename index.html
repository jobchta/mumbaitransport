<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#5E6AD2" />
  <meta name="color-scheme" content="light dark" />
  <meta name="description" content="Mumbai Transport Hub: Live map, schedules, and updates for BEST buses, local trains, metro, monorail, and ferries." />
  <title>Mumbai Transport Hub | Real-Time Tracking</title>

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="preconnect" href="https://unpkg.com" crossorigin />
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin />
  <link rel="preconnect" href="https://maps.googleapis.com" crossorigin />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Leaflet for real map rendering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Google Maps API for accurate journey calculations -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&libraries=geometry,places&callback=initGoogleMaps"></script>
  <style>
    :root {
      --primary: #5E6AD2;
      --primary-dark: #4C56C4;
      --primary-light: #F1F2FD;
      --secondary: #8B92B2;
      --background: #FAFBFC;
      --surface: #FFFFFF;
      --surface-hover: #F7F8FA;
      --border: #E1E4E8;
      --border-light: #F1F3F4;
      --text-primary: #1D2125;
      --text-secondary: #626F86;
      --text-muted: #8B92B2;
      --success: #00B87A;
      --warning: #F79009;
      --error: #DC3A42;
      --info: #0EA5E9;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }
    [data-theme="dark"] {
      --background: #0F1419;
      --surface: #1A1D23;
      --surface-hover: #222530;
      --border: #2D3442;
      --border-light: #252932;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --text-muted: #6B7280;
      --primary-light: rgba(94, 106, 210, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 14px;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background 0.3s ease, color 0.3s ease;
    }
    .app { height: 100vh; display: flex; flex-direction: column; position: relative; overflow: hidden; }

    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px 12px;
      position: relative;
      z-index: 100;
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
    }
    [data-theme="dark"] .header { background: rgba(26, 29, 35, 0.9); }
    .header-top { display: flex; align-items: center; justify-content: space-between; }
    .logo { font-size: 18px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.2px; display: flex; align-items: center; gap: 8px; }
    .logo-icon { width: 28px; height: 28px; background: var(--primary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; }
    .header-actions { display: flex; gap: 10px; }
    .header-btn { width: 36px; height: 36px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; background: var(--background); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; }
    .header-btn:hover { background: var(--surface-hover); }
    .header-btn:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    .search-bar { position: relative; }
    .search-input { width: 100%; padding: 12px 16px 12px 44px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; color: var(--text-primary); outline: none; transition: all 0.2s ease; }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.1); }
    .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 16px; }

    .content { flex: 1; padding: 16px 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; scroll-behavior: smooth; }
    .section-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .section-title i { color: var(--primary); }

    .transport-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
    .transport-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; transition: all 0.2s ease; cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column; gap: 8px; }
    .transport-card.active { border-color: var(--primary); background: var(--primary-light); }
    .transport-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .card-header { display: flex; align-items: center; gap: 10px; }
    .card-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; flex-shrink: 0; }
    .bus-icon { background: var(--primary); }
    .train-icon { background: var(--success); }
    .metro-icon { background: #8B5CF6; }
    .ferry-icon { background: var(--info); }
    .mono-icon { background: #10B981; }
    .card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); line-height: 1.2; }
    .card-status { display: flex; align-items: center; gap: 6px; }
    .status-indicator { width: 8px; height: 8px; border-radius: 50%; }
    .status-active { background: var(--success); }
    .status-delayed { background: var(--warning); }
    .status-offline { background: var(--error); }
    .card-status-text { font-size: 12px; color: var(--text-muted); }
    .card-stats { display: flex; justify-content: space-between; margin-top: auto; padding-top: 8px; }
    .stat { text-align: center; flex: 1; }
    .stat-number { font-size: 16px; font-weight: 700; color: var(--text-primary); line-height: 1; transition: all 0.3s ease; }
    .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

    .action-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .action-button { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px; font-size: 13px; color: var(--text-secondary); font-weight: 500; cursor: pointer; transition: all 0.2s ease; text-align: left; display: flex; align-items: center; gap: 10px; }
    .action-button:hover { background: var(--surface-hover); transform: translateY(-1px); }
    .action-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 16px; flex-shrink: 0; }

    /* Real map container */
    .map-container { border-radius: var(--radius-lg); overflow: hidden; position: relative; border: 1px solid var(--border); background: var(--surface); }
    #leafletMap { height: 260px; width: 100%; }
    /* Fallback decorative map */
    .map-fallback { height: 200px; position: relative; background: linear-gradient(135deg, #e8f4f8 0%, #f5f9fc 100%); }
    .map-bg { position: absolute; inset: 0; background-image:
      radial-gradient(circle at 20% 30%, rgba(94, 106, 210, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(0, 184, 122, 0.1) 0%, transparent 50%); }
    .map-grid { position: absolute; inset: 0; background-image:
      linear-gradient(90deg, rgba(225, 228, 232, 0.3) 1px, transparent 1px),
      linear-gradient(0deg, rgba(225, 228, 232, 0.3) 1px, transparent 1px);
      background-size: 30px 30px; }
    .vehicle-marker { position: absolute; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transform: translate(-50%, -50%); transition: transform 0.2s ease; cursor: pointer; z-index: 5; }
    .vehicle-marker:hover { transform: translate(-50%, -50%) scale(1.4); z-index: 10; }
    .vehicle-marker::after {
      content: attr(data-route); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm);
      padding: 4px 6px; font-size: 10px; font-weight: 600; white-space: nowrap; box-shadow: var(--shadow-md);
      opacity: 0; pointer-events: none; transition: opacity 0.2s ease; color: var(--text-primary); margin-bottom: 4px;
    }
    .vehicle-marker:hover::after { opacity: 1; }

    .updates-list { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .update-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); display: flex; align-items: flex-start; gap: 12px; transition: background-color 0.3s ease; }
    .update-item:last-child { border-bottom: none; }
    .update-item.new { background-color: var(--primary-light); }
    .update-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; color: white; }
    .update-content { flex: 1; min-width: 0; }
    .update-text { font-size: 13px; color: var(--text-primary); line-height: 1.4; margin-bottom: 4px; }
    .update-time { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }

    .schedule-list { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .schedule-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 12px; transition: background-color 0.3s ease; }
    .schedule-item:last-child { border-bottom: none; }
    .schedule-item:hover { background: var(--surface-hover); }
    .schedule-item.updating { background: var(--primary-light); }
    .schedule-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; color: white; }
    .schedule-content { flex: 1; min-width: 0; }
    .schedule-route { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .schedule-time { font-size: 12px; color: var(--text-muted); }
    .schedule-delay { font-size: 11px; color: var(--warning); font-weight: 600; }

    /* Chips, Tabs, FAB */
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; font-size: 11px; background: var(--primary-light); color: var(--text-secondary); border: 1px solid var(--border); }
    .chip.success { background: rgba(0,184,122,0.12); color: #0E9F6E; border-color: rgba(0,184,122,0.3); }
    .chip.warn { background: rgba(247,144,9,0.12); color: #B4690E; border-color: rgba(247,144,9,0.3); }
    .chip.info { background: rgba(14,165,233,0.12); color: #0E7490; border-color: rgba(14,165,233,0.3); }

    .tabs { display: flex; gap: 8px; background: var(--background); border: 1px solid var(--border); padding: 6px; border-radius: var(--radius-lg); }
    .tab { flex: 1; text-align: center; padding: 8px 10px; border-radius: var(--radius-md); font-size: 13px; cursor: pointer; color: var(--text-secondary); border: 1px solid transparent; }
    .tab.active { background: var(--surface); color: var(--text-primary); border-color: var(--border); box-shadow: var(--shadow-sm); }

    .fab { position: fixed; right: 18px; bottom: 86px; z-index: 1200; }
    .fab-main { width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-lg); border: none; cursor: pointer; }
    .fab-menu { position: absolute; bottom: 66px; right: 0; display: none; flex-direction: column; gap: 10px; }
    .fab.show .fab-menu { display: flex; }
    .fab-item { display: flex; align-items: center; gap: 8px; background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); padding: 8px 10px; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); cursor: pointer; }

    .bottom-nav { background: var(--surface); border-top: 1px solid var(--border); padding: 8px 20px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; flex-shrink: 0; }
    .nav-button { padding: 8px 2px; border-radius: var(--radius-md); background: transparent; border: none; color: var(--text-muted); font-size: 10px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .nav-button.active { color: var(--primary); background: var(--primary-light); }
    .nav-button:hover { background: var(--surface-hover); }
    .nav-button:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    .nav-icon { font-size: 18px; }

    /* Mini bottom map */
    .mini-map { position: fixed; left: 12px; right: 12px; bottom: 140px; height: 84px; border-radius: 14px; overflow: hidden; border: 1px solid var(--border); background: var(--surface); z-index: 1100; display: none; pointer-events: none; }
    .mini-map.show { display: block; }
    #miniMap { height: 100%; width: 100%; filter: saturate(1.1) contrast(1.03); }
    .mini-map-overlay { position: absolute; right: 8px; top: 8px; z-index: 2; }
    .mini-map-overlay .chip { background: rgba(0,0,0,0.55); color: #fff; border-color: rgba(255,255,255,0.2); }

    .live-indicator { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 600; color: var(--error); background: rgba(220, 58, 66, 0.1); padding: 2px 6px; border-radius: 10px; margin-left: 8px; }
    .live-indicator::before { content: ""; display: block; width: 6px; height: 6px; background: var(--error); border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:0.4} 100%{opacity:1} }

    .notification {
      position: fixed; top: 80px; right: 20px; background: var(--primary); color: white;
      padding: 12px 16px; border-radius: var(--radius-md); font-size: 13px; font-weight: 500;
      z-index: 1000; box-shadow: var(--shadow-lg); max-width: 300px;
    }

    .stat-number.updating { animation: numberUpdate 0.5s ease; }
    @keyframes numberUpdate { 0%{transform:scale(1)} 50%{transform:scale(1.1); color:var(--primary)} 100%{transform:scale(1)} }

    .network-banner {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1100;
      background: var(--warning); color: #111827; padding: 6px 12px; text-align: center; font-size: 12px; display: none;
    }
    .network-banner.online { background: var(--success); color: #fff; }
    .network-banner.show { display: block; }

    .sr-only {
      position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important;
      margin: -1px !important; overflow: hidden !important; clip: rect(0, 0, 0, 0) !important; white-space: nowrap !important; border: 0 !important;
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }
    @media (max-width: 380px) {
      .action-grid, .transport-grid { grid-template-columns: 1fr; }
    }

    /* Bottom Sheet Modal */
    .sheet-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease;
    }
    .sheet-backdrop.show { opacity: 1; visibility: visible; }

    .sheet {
      position: fixed; bottom: 0; left: 0; right: 0; max-height: 80vh; background: var(--surface);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0; box-shadow: var(--shadow-lg);
      transform: translateY(100%); transition: transform 0.3s ease; z-index: 1001;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .sheet.show { transform: translateY(0); }

    .sheet-header {
      padding: 16px 20px 12px; border-bottom: 1px solid var(--border); display: flex;
      align-items: center; justify-content: space-between; flex-shrink: 0; position: relative;
    }
    .sheet-handle {
      position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
      width: 32px; height: 4px; background: var(--border); border-radius: 2px;
    }
    .sheet-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-top: 8px; }
    .sheet-close {
      width: 32px; height: 32px; border-radius: var(--radius-md); background: var(--background);
      border: 1px solid var(--border); color: var(--text-muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;
    }
    .sheet-close:hover { background: var(--surface-hover); }

    .sheet-body {
      padding: 20px; overflow-y: auto; flex: 1; color: var(--text-primary); line-height: 1.6;
    }
    .sheet-body h3 { margin: 0 0 12px 0; color: var(--text-primary); }
    .sheet-body p { margin: 0 0 16px 0; }
    .sheet-body .frequency-item {
      background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md);
      padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
    }
    .sheet-body .frequency-item strong { color: var(--primary); }

    /* Time Selector */
    .schedule-controls {
      display: flex; gap: 8px; align-items: center; margin: 0 0 16px 0; padding: 12px;
      background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md);
    }
    .schedule-controls label { font-size: 12px; color: var(--text-secondary); }
    .schedule-controls input[type="time"] {
      padding: 6px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--surface); color: var(--text-primary); font-size: 14px;
    }
    .schedule-controls button {
      padding: 6px 12px; border: 1px solid var(--border); background: var(--surface);
      color: var(--text-secondary); border-radius: var(--radius-sm); cursor: pointer;
      font-size: 12px; transition: all 0.2s ease;
    }
    .schedule-controls button:hover { background: var(--surface-hover); }

    /* Embed mode - hide bottom nav */
    body.embedded .bottom-nav { display: none; }
    body.embedded .content { padding-bottom: 20px; }
  </style>
</head>
<body>
  <div class="network-banner" id="networkBanner" role="status" aria-live="polite"></div>
  <a href="#main" class="sr-only" id="skipLink">Skip to content</a>
  <div id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <div class="app">
    <header class="header">
      <div class="header-top">
        <div class="logo" aria-label="Mumbai Transport Hub">
          <div class="logo-icon"><i class="fa-solid fa-train-subway"></i></div>
          Mumbai Transport Hub
        </div>
        <div class="header-actions">
          <button class="header-btn" id="theme-toggle" aria-label="Switch theme" type="button">
            <i class="fa-solid fa-moon"></i>
          </button>
          <button class="header-btn" id="notifications-btn" aria-label="Notifications" type="button">
            <i class="fa-solid fa-bell"></i>
          </button>
        </div>
      </div>
      <div class="search-bar">
        <i class="fa-solid fa-magnifying-glass search-icon" aria-hidden="true"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="Search routes or destinations..." aria-label="Search routes or destinations" autocomplete="off" />
      </div>
      <div style="display:flex; gap:8px; margin-top:4px;">
        <span class="chip" id="share-btn" role="button" tabindex="0"><i class="fa-solid fa-share-from-square"></i> Share</span>
        <span class="chip info" id="home-refresh" role="button" tabindex="0"><i class="fa-solid fa-arrows-rotate"></i> Refresh</span>
      </div>
    </header>

    <main class="content" id="main">
      <section aria-labelledby="home-panel-heading" id="home-panel">
        <h2 class="section-title" id="home-panel-heading"><i class="fa-solid fa-star"></i> Your Home</h2>
        <div class="updates-list" style="margin-bottom: 12px;">
          <div class="update-item">
            <div class="update-icon" style="background: var(--primary);"><i class="fa-solid fa-magnifying-glass"></i></div>
            <div class="update-content" style="width:100%">
              <div class="update-text" style="display:flex; justify-content:space-between; align-items:center;">
                <span>Recent Searches</span><button id="clear-recent" class="chip" type="button">Clear</button>
              </div>
              <div id="recentList" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;"></div>
            </div>
          </div>
        </div>
        <div class="updates-list">
          <div class="update-item">
            <div class="update-icon" style="background: var(--success);"><i class="fa-solid fa-bookmark"></i></div>
            <div class="update-content" style="width:100%">
              <div class="update-text" style="display:flex; justify-content:space-between; align-items:center;">
                <span>Saved Trips</span><button id="clear-trips" class="chip" type="button">Clear</button>
              </div>
              <div id="tripsList" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;"></div>
            </div>
          </div>
        </div>
      </section>
      <section aria-labelledby="modes-heading">
        <h2 class="section-title" id="modes-heading"><i class="fa-solid fa-bus"></i> Transport Modes <span class="live-indicator">LIVE</span></h2>
        <div class="transport-grid" role="tablist" aria-label="Transport modes">
          <button class="transport-card active" data-transport="bus" role="tab" aria-selected="true" type="button">
            <div class="card-header">
              <div class="bus-icon card-icon"><i class="fa-solid fa-bus"></i></div>
              <div class="card-title">BEST Buses</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="bus-count">518</span>
                <span class="stat-label">Routes</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="bus-ontime">3,800</span>
                <span class="stat-label">Buses</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="train" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="train-icon card-icon"><i class="fa-solid fa-train-subway"></i></div>
              <div class="card-title">Local Trains</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-delayed" aria-hidden="true"></span>
              <span class="card-status-text">Minor Delays</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="train-count">2,847</span>
                <span class="stat-label">Services</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="train-ontime">87%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="metro" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="metro-icon card-icon"><i class="fa-solid fa-train-tram"></i></div>
              <div class="card-title">Metro</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="metro-count">12</span>
                <span class="stat-label">Lines</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="metro-ontime">98%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="ferry" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="ferry-icon card-icon"><i class="fa-solid fa-ship"></i></div>
              <div class="card-title">Ferry</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="ferry-count">8</span>
                <span class="stat-label">Routes</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="ferry-ontime">95%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="monorail" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="mono-icon card-icon"><i class="fa-solid fa-train"></i></div>
              <div class="card-title">Monorail</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="monorail-count">1</span>
                <span class="stat-label">Line</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="monorail-ontime">94%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>
        </div>
      </section>

      <section aria-labelledby="live-heading">
        <h2 class="section-title" id="live-heading"><i class="fa-solid fa-map-location-dot"></i> Live Vehicle Tracking <span class="live-indicator">LIVE</span></h2>
        <div class="map-container">
          <div id="leafletMap" role="img" aria-label="Live map of Mumbai vehicles"></div>
          <div class="map-fallback" id="mapFallback" hidden>
            <div class="map-bg"></div>
            <div class="map-grid"></div>
            <div class="map-content" id="mapContent" aria-hidden="true"></div>
          </div>
        </div>
      </section>

      <section aria-labelledby="departures-heading">
        <h2 class="section-title" id="departures-heading"><i class="fa-solid fa-clock"></i> Next Departures</h2>
        <div class="schedule-controls">
          <label for="refTime">Check time:</label>
          <input type="time" id="refTime" />
          <button id="useNow" type="button">Now</button>
        </div>
        <div class="schedule-list" id="scheduleList" role="list"></div>
      </section>

      <section aria-labelledby="actions-heading">
        <h2 class="section-title" id="actions-heading"><i class="fa-solid fa-bolt"></i> Quick Actions</h2>
        <div class="action-grid">
          <button class="action-button" id="buy-ticket" type="button">
            <span class="action-icon"><i class="fa-solid fa-ticket"></i></span>
            Buy Ticket
          </button>
          <button class="action-button" id="plan-journey" type="button">
            <span class="action-icon"><i class="fa-solid fa-route"></i></span>
            Plan Journey
          </button>
          <button class="action-button" id="nearby-stations" type="button">
            <span class="action-icon"><i class="fa-solid fa-map-pin"></i></span>
            Nearby Stations
          </button>
          <button class="action-button" id="recharge-card" type="button">
            <span class="action-icon"><i class="fa-solid fa-wallet"></i></span>
            Recharge Card
          </button>
          <button class="action-button" id="fare-estimator" type="button">
            <span class="action-icon"><i class="fa-solid fa-indian-rupee-sign"></i></span>
            Fare Estimator (Auto)
          </button>
        </div>
      </section>

      <section aria-labelledby="updates-heading">
        <h2 class="section-title" id="updates-heading"><i class="fa-solid fa-triangle-exclamation"></i> Service Updates</h2>
        <div class="updates-list" id="updatesList" role="feed" aria-live="polite"></div>
      </section>

      <section aria-labelledby="metro-info-heading">
        <h2 class="section-title" id="metro-info-heading"><i class="fa-solid fa-circle-info"></i> Mumbai Metro Network Status</h2>
        <div class="updates-list">
          <div class="update-item">
            <div class="update-icon" style="background: var(--info);">
              <i class="fa-solid fa-train-tram"></i>
            </div>
            <div class="update-content">
              <div class="update-text"><strong>Operational lines</strong>: Line 1 (Versova–Andheri–Ghatkopar), Line 2A (Dahisar–Dahanukarwadi), Line 7 (Andheri East–Dahisar East).</div>
              <div class="update-time">Verified metro info (June 2025)</div>
            </div>
          </div>
          <div class="update-item">
            <div class="update-icon" style="background: var(--warning);">
              <i class="fa-solid fa-wrench"></i>
            </div>
            <div class="update-content">
              <div class="update-text"><strong>Under construction / planned</strong>: Line 3 (Colaba–Bandra–SEEPZ), Line 5 (Thane–Bhiwandi–Kalyan), Line 6 (Swami Samarth Nagar–Vikhroli).</div>
              <div class="update-time">Compiled from official/public sources</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <nav class="bottom-nav" role="navigation" aria-label="Primary">
      <button class="nav-button active" data-nav="home" type="button">
        <i class="nav-icon fa-solid fa-house"></i>
        Home
      </button>
      <button class="nav-button" data-nav="map" type="button">
        <i class="nav-icon fa-solid fa-map-location"></i>
        Map
      </button>
      <button class="nav-button" data-nav="tickets" type="button">
        <i class="nav-icon fa-solid fa-ticket"></i>
        Tickets
      </button>
      <button class="nav-button" data-nav="journey" type="button">
        <i class="nav-icon fa-solid fa-route"></i>
        Journey
      </button>
      <button class="nav-button" data-nav="account" type="button">
        <i class="nav-icon fa-solid fa-user"></i>
        Account
      </button>
    </nav>
  </div>

  <!-- Floating Action Button (Quick Menu) -->
  <div class="fab" id="fab">
    <div class="fab-menu">
      <div class="fab-item" id="fab-fare"><i class="fa-solid fa-indian-rupee-sign"></i> Fare Estimator</div>
      <div class="fab-item" id="fab-tickets"><i class="fa-solid fa-ticket"></i> Tickets</div>
      <div class="fab-item" id="fab-nearby"><i class="fa-solid fa-location-arrow"></i> Nearby</div>
    </div>
    <button class="fab-main" id="fab-main" aria-label="Open quick menu"><i class="fa-solid fa-plus"></i></button>
  </div>

  <!-- Mini bottom map -->
  <div class="mini-map" id="miniMapWrap" aria-hidden="true">
    <div class="mini-map-overlay"><span class="chip" id="miniMapStatus">Live</span></div>
    <div id="miniMap"></div>
  </div>

  <!-- Bottom Sheet Modal -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
    <div class="sheet-header">
      <div class="sheet-handle"></div>
      <div class="sheet-title" id="sheetTitle">Details</div>
      <button class="sheet-close" id="sheetClose" type="button" aria-label="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="sheet-body" id="sheetBody">
      <p>Loading...</p>
    </div>
  </div>

  <noscript>
    <div class="notification" role="alert">This app needs JavaScript enabled.</div>
  </noscript>

  <!-- Leaflet JS with fallback CDN -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" onerror="(function(){var s=document.createElement('script');s.defer=true;s.src='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';document.head.appendChild(s);})()"></script>
  
  <!-- PhonePe SDK Integration -->
  <script>
    // PhonePe Payment Configuration
    window.PhonePeConfig = {
      merchantId: 'DEMO_MERCHANT', // Demo merchant ID
      saltKey: 'DEMO_SALT_KEY',    // Demo salt key  
      saltIndex: '1',              // Demo salt index
      environment: 'UAT',          // UAT for testing, PRODUCTION for live
      callbackUrl: window.location.origin + '/payment-callback',
      redirectUrl: window.location.origin + '/payment-success'
    };
  </script>

  <script data-cfasync="false">
    // Mumbai Transport Hub - robust single-file app
    (function() {
      const STORAGE_KEYS = {
        theme: 'mth.theme',
        transport: 'mth.transport'
      };

      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
      if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
      else document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');

      class MumbaiTransportHub {
        constructor() {
          this.appData = {
            selectedTransport: localStorage.getItem(STORAGE_KEYS.transport) || 'bus',
            theme: document.documentElement.getAttribute('data-theme') || 'light',
            vehicles: new Map(),
            leafletMarkers: new Map(),
            routes: this.initializeRoutes(),
            updates: [],
            searchTimer: null,
            reduceMotion: window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches,
            recentSearches: JSON.parse(localStorage.getItem('mth.recentSearches')||'[]').slice(0,8),
            savedTrips: JSON.parse(localStorage.getItem('mth.savedTrips')||'[]').slice(0,8)
          };

          this.map = null;
          this.mapFallbackMode = false;
          this.vehicleBounds = { latMin: 18.85, latMax: 19.35, lngMin: 72.75, lngMax: 73.10 };
          this.timers = { vehicles: null, schedules: null, stats: null, updates: null };
          this.peakHours = [ {start: 7, end: 10}, {start: 18, end: 21} ];

          this.safeInit();
          // Recover any pending transactions on app start
          this.recoverPendingTransactions();
        }

        safeInit() {
          try {
            this.setupEventListeners();
            this.bindGlobalDelegates();
            this.initMap();
            this.createInitialVehicles();
            this.restoreSelectedTransportUI();
            this.updateUI();
            this.startRealTimeUpdates();
            this.showNotification('🚌 Mumbai Transport Hub ready — live tracking active!');
            this.registerServiceWorker();
            this.setupNetworkBanner();
          } catch (e) {
            console.error('Initialization error:', e);
            this.showNotification('⚠️ Initialization failed. Some features may be limited.');
          }
        }

        bindGlobalDelegates() {
          // Robust event delegation so buttons always work even if DOM changes
          document.addEventListener('click', (ev) => {
            const el = ev.target;
            if (!el) return;
            const q = (sel) => el.closest && el.closest(sel);

            // Transport cards
            const card = q('.transport-card');
            if (card && card.dataset && card.dataset.transport) {
              const t = card.dataset.transport;
              try { this.selectTransport(t); this.openDetailsSheet(t); } catch(_) {}
              return;
            }

            // Quick actions
            if (q('#buy-ticket')) { try { this.openTicketsSheet(); } catch(_) {} return; }
            if (q('#plan-journey')) { try { this.openJourneySheet(); } catch(_) {} return; }
            if (q('#nearby-stations')) { try { this.openNearbySheet(); } catch(_) {} return; }
            if (q('#recharge-card')) { try { this.openRechargeSheet(); } catch(_) {} return; }
            if (q('#fare-estimator')) { try { this.openFareEstimator(); } catch(_) {} return; }

            // Bottom nav
            const navBtn = q('.nav-button');
            if (navBtn && navBtn.dataset && navBtn.dataset.nav) {
              document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
              navBtn.classList.add('active');
              const nav = navBtn.dataset.nav;
              try {
                if (nav === 'tickets') this.openTicketsSheet();
                else if (nav === 'journey') this.openJourneySheet();
                else if (nav === 'account') this.openAccountSheet();
                else if (nav === 'map') this.scrollToSection('live-heading');
                else this.scrollToSection('home-panel-heading');
              } catch(_) {}
              return;
            }



            // Sheet close
            if (q('#sheetClose') || q('#sheetBackdrop')) { try { this.closeSheet(); } catch(_) {} return; }
          }, { capture: true });
        }

        initializeRoutes() {
          return {
            bus: [
              // Major Express Routes
              { id: 'A1E', name: 'A-1 Express', from: 'Colaba', to: 'Bandra', time: 3, delay: 0, passengers: 45, capacity: 70 },
              { id: 'A2E', name: 'A-2 Express', from: 'Colaba', to: 'Andheri', time: 5, delay: 1, passengers: 52, capacity: 70 },
              { id: 'A3E', name: 'A-3 Express', from: 'Colaba', to: 'Borivali', time: 8, delay: 2, passengers: 38, capacity: 70 },
              { id: 'A4E', name: 'A-4 Express', from: 'Colaba', to: 'Dahisar', time: 10, delay: 1, passengers: 42, capacity: 70 },
              
              // Limited Routes
              { id: '1L', name: '1Ltd', from: 'Colaba', to: 'Bandra', time: 4, delay: 0, passengers: 48, capacity: 65 },
              { id: '2L', name: '2Ltd', from: 'Mumbai Central', to: 'Bandra', time: 7, delay: 2, passengers: 52, capacity: 65 },
              { id: '3L', name: '3Ltd', from: 'Colaba', to: 'Andheri', time: 6, delay: 1, passengers: 45, capacity: 65 },
              { id: '4L', name: '4Ltd', from: 'Colaba', to: 'Borivali', time: 9, delay: 2, passengers: 35, capacity: 65 },
              { id: '5L', name: '5Ltd', from: 'Colaba', to: 'Dahisar', time: 11, delay: 1, passengers: 38, capacity: 65 },
              { id: '6L', name: '6Ltd', from: 'Mumbai Central', to: 'Andheri', time: 8, delay: 2, passengers: 50, capacity: 65 },
              { id: '7L', name: '7Ltd', from: 'Mumbai Central', to: 'Borivali', time: 10, delay: 1, passengers: 42, capacity: 65 },
              { id: '8L', name: '8Ltd', from: 'Mumbai Central', to: 'Dahisar', time: 12, delay: 2, passengers: 35, capacity: 65 },
              
              // Regular Routes - South Mumbai
              { id: '1', name: '1', from: 'Colaba', to: 'Bandra', time: 5, delay: 0, passengers: 55, capacity: 60 },
              { id: '2', name: '2', from: 'Colaba', to: 'Andheri', time: 7, delay: 1, passengers: 48, capacity: 60 },
              { id: '3', name: '3', from: 'Colaba', to: 'Borivali', time: 10, delay: 2, passengers: 40, capacity: 60 },
              { id: '4', name: '4', from: 'Colaba', to: 'Dahisar', time: 12, delay: 1, passengers: 35, capacity: 60 },
              { id: '5', name: '5', from: 'Colaba', to: 'Mira Road', time: 15, delay: 2, passengers: 30, capacity: 60 },
              { id: '6', name: '6', from: 'Colaba', to: 'Bhayandar', time: 18, delay: 1, passengers: 25, capacity: 60 },
              { id: '7', name: '7', from: 'Colaba', to: 'Vasai', time: 20, delay: 2, passengers: 22, capacity: 60 },
              { id: '8', name: '8', from: 'Colaba', to: 'Virar', time: 22, delay: 1, passengers: 20, capacity: 60 },
              { id: '9', name: '9', from: 'Antop Hill', to: 'Colaba', time: 8, delay: 1, passengers: 45, capacity: 60 },
              { id: '10', name: '10', from: 'Colaba', to: 'Boisar', time: 28, delay: 1, passengers: 15, capacity: 60 },
              
              // Regular Routes - Central Mumbai
              { id: '11', name: '11', from: 'Mumbai Central', to: 'Bandra', time: 4, delay: 0, passengers: 58, capacity: 60 },
              { id: '12', name: '12', from: 'Mumbai Central', to: 'Andheri', time: 6, delay: 1, passengers: 52, capacity: 60 },
              { id: '13', name: '13', from: 'Mumbai Central', to: 'Borivali', time: 9, delay: 2, passengers: 45, capacity: 60 },
              { id: '14', name: '14', from: 'Mumbai Central', to: 'Dahisar', time: 11, delay: 1, passengers: 38, capacity: 60 },
              { id: '15', name: '15', from: 'Mumbai Central', to: 'Mira Road', time: 14, delay: 2, passengers: 32, capacity: 60 },
              { id: '16', name: '16', from: 'Mumbai Central', to: 'Bhayandar', time: 17, delay: 1, passengers: 28, capacity: 60 },
              { id: '17', name: '17', from: 'Mumbai Central', to: 'Vasai', time: 19, delay: 2, passengers: 25, capacity: 60 },
              { id: '18', name: '18', from: 'Mumbai Central', to: 'Virar', time: 21, delay: 1, passengers: 22, capacity: 60 },
              { id: '19', name: '19', from: 'Mumbai Central', to: 'Nalasopara', time: 24, delay: 2, passengers: 20, capacity: 60 },
              { id: '20', name: '20', from: 'Mumbai Central', to: 'Boisar', time: 27, delay: 1, passengers: 18, capacity: 60 },
              
              // Regular Routes - Western Suburbs
              { id: '21', name: '21', from: 'Bandra', to: 'Andheri', time: 3, delay: 0, passengers: 62, capacity: 60 },
              { id: '22', name: '22', from: 'Bandra', to: 'Borivali', time: 6, delay: 1, passengers: 55, capacity: 60 },
              { id: '23', name: '23', from: 'Bandra', to: 'Dahisar', time: 8, delay: 2, passengers: 48, capacity: 60 },
              { id: '24', name: '24', from: 'Bandra', to: 'Mira Road', time: 11, delay: 1, passengers: 42, capacity: 60 },
              { id: '25', name: '25', from: 'Bandra', to: 'Bhayandar', time: 14, delay: 2, passengers: 38, capacity: 60 },
              { id: '26', name: '26', from: 'Bandra', to: 'Vasai', time: 16, delay: 1, passengers: 35, capacity: 60 },
              { id: '27', name: '27', from: 'Bandra', to: 'Virar', time: 18, delay: 2, passengers: 32, capacity: 60 },
              { id: '28', name: '28', from: 'Bandra', to: 'Nalasopara', time: 21, delay: 1, passengers: 30, capacity: 60 },
              { id: '29', name: '29', from: 'Bandra', to: 'Boisar', time: 24, delay: 2, passengers: 28, capacity: 60 },
              { id: '30', name: '30', from: 'Bandra', to: 'Palghar', time: 26, delay: 1, passengers: 25, capacity: 60 },
              
              // Regular Routes - Andheri Hub
              { id: '31', name: '31', from: 'Andheri', to: 'Borivali', time: 4, delay: 0, passengers: 65, capacity: 60 },
              { id: '32', name: '32', from: 'Andheri', to: 'Dahisar', time: 6, delay: 1, passengers: 58, capacity: 60 },
              { id: '33', name: '33', from: 'Andheri', to: 'Mira Road', time: 9, delay: 2, passengers: 52, capacity: 60 },
              { id: '34', name: '34', from: 'Andheri', to: 'Bhayandar', time: 12, delay: 1, passengers: 48, capacity: 60 },
              { id: '35', name: '35', from: 'Andheri', to: 'Vasai', time: 14, delay: 2, passengers: 45, capacity: 60 },
              { id: '36', name: '36', from: 'Andheri', to: 'Virar', time: 16, delay: 1, passengers: 42, capacity: 60 },
              { id: '37', name: '37', from: 'Santacruz', to: 'Colaba', time: 12, delay: 0, passengers: 38, capacity: 60 },
              { id: '38', name: '38', from: 'Santacruz', to: 'Mumbai Central', time: 8, delay: 1, passengers: 45, capacity: 60 },
              { id: '39', name: '39', from: 'Santacruz', to: 'Bandra', time: 3, delay: 0, passengers: 55, capacity: 60 },
              { id: '40', name: '40', from: 'Santacruz', to: 'Andheri', time: 5, delay: 1, passengers: 52, capacity: 60 },
              
              // Regular Routes - Borivali Hub
              { id: '41', name: '41', from: 'Borivali', to: 'Dahisar', time: 2, delay: 0, passengers: 68, capacity: 60 },
              { id: '42', name: '42', from: 'Sandhurst Road', to: 'Kamla Nehru Park', time: 4, delay: 1, passengers: 45, capacity: 60 },
              { id: '43', name: '43', from: 'Borivali', to: 'Mira Road', time: 5, delay: 1, passengers: 62, capacity: 60 },
              { id: '44', name: '44', from: 'Borivali', to: 'Bhayandar', time: 8, delay: 2, passengers: 58, capacity: 60 },
              { id: '45', name: '45', from: 'Borivali', to: 'Vasai', time: 10, delay: 1, passengers: 55, capacity: 60 },
              { id: '46', name: '46', from: 'Borivali', to: 'Virar', time: 12, delay: 2, passengers: 52, capacity: 60 },
              { id: '47', name: '47', from: 'Borivali', to: 'Nalasopara', time: 15, delay: 1, passengers: 48, capacity: 60 },
              { id: '48', name: '48', from: 'Borivali', to: 'Boisar', time: 18, delay: 2, passengers: 45, capacity: 60 },
              { id: '49', name: '49', from: 'Borivali', to: 'Palghar', time: 20, delay: 1, passengers: 42, capacity: 60 },
              { id: '50', name: '50', from: 'Borivali', to: 'Dahanu', time: 25, delay: 2, passengers: 35, capacity: 60 },
              
              // Regular Routes - Eastern Suburbs
              { id: '51', name: '51', from: 'Kurla', to: 'Colaba', time: 8, delay: 1, passengers: 48, capacity: 60 },
              { id: '52', name: '52', from: 'Kurla', to: 'Mumbai Central', time: 5, delay: 0, passengers: 55, capacity: 60 },
              { id: '53', name: '53', from: 'Kurla', to: 'Bandra', time: 6, delay: 1, passengers: 52, capacity: 60 },
              { id: '54L', name: '54Ltd', from: 'Kurla', to: 'Colaba', time: 5, delay: 1, passengers: 41, capacity: 55 },
              { id: '55', name: '55', from: 'Kurla', to: 'Andheri', time: 4, delay: 0, passengers: 58, capacity: 60 },
              { id: '56', name: '56', from: 'Kurla', to: 'Borivali', time: 7, delay: 1, passengers: 52, capacity: 60 },
              { id: '57', name: '57', from: 'Kurla', to: 'Dahisar', time: 9, delay: 2, passengers: 48, capacity: 60 },
              { id: '58', name: '58', from: 'Kurla', to: 'Mira Road', time: 12, delay: 1, passengers: 45, capacity: 60 },
              { id: '59', name: '59', from: 'Kurla', to: 'Bhayandar', time: 15, delay: 2, passengers: 42, capacity: 60 },
              { id: '60', name: '60', from: 'Kurla', to: 'Vasai', time: 17, delay: 1, passengers: 38, capacity: 60 },
              
              // Regular Routes - Thane Hub
              { id: '61', name: '61', from: 'Thane', to: 'Colaba', time: 12, delay: 2, passengers: 42, capacity: 60 },
              { id: '62', name: '62', from: 'Thane', to: 'Mumbai Central', time: 9, delay: 1, passengers: 48, capacity: 60 },
              { id: '63', name: '63', from: 'Thane', to: 'Bandra', time: 10, delay: 2, passengers: 45, capacity: 60 },
              { id: '64', name: '64', from: 'Thane', to: 'Andheri', time: 8, delay: 1, passengers: 52, capacity: 60 },
              { id: '65', name: '65', from: 'Thane', to: 'Borivali', time: 11, delay: 2, passengers: 48, capacity: 60 },
              { id: '242', name: '242', from: 'Bandra Station', to: 'Worli', time: 6, delay: 1, passengers: 48, capacity: 65 },
              { id: '66', name: '66', from: 'Thane', to: 'Dahisar', time: 13, delay: 1, passengers: 45, capacity: 60 },
              { id: '67', name: '67', from: 'Thane', to: 'Mira Road', time: 16, delay: 2, passengers: 42, capacity: 60 },
              { id: '68', name: '68', from: 'Thane', to: 'Bhayandar', time: 19, delay: 1, passengers: 38, capacity: 60 },
              { id: '69', name: '69', from: 'Thane', to: 'Vasai', time: 21, delay: 2, passengers: 35, capacity: 60 },
              { id: '70', name: '70', from: 'Thane', to: 'Virar', time: 23, delay: 1, passengers: 32, capacity: 60 },
              
              // Regular Routes - Kalyan Hub
              { id: '71', name: '71', from: 'Kalyan', to: 'Colaba', time: 15, delay: 2, passengers: 38, capacity: 60 },
              { id: '72', name: '72', from: 'Kalyan', to: 'Mumbai Central', time: 12, delay: 1, passengers: 42, capacity: 60 },
              { id: '73', name: '73', from: 'Kalyan', to: 'Bandra', time: 13, delay: 2, passengers: 40, capacity: 60 },
              { id: '74', name: '74', from: 'Kalyan', to: 'Andheri', time: 11, delay: 1, passengers: 45, capacity: 60 },
              { id: '75', name: '75', from: 'Kalyan', to: 'Borivali', time: 14, delay: 2, passengers: 42, capacity: 60 },
              { id: '76', name: '76', from: 'Kalyan', to: 'Dahisar', time: 16, delay: 1, passengers: 38, capacity: 60 },
              { id: '77', name: '77', from: 'Kalyan', to: 'Mira Road', time: 19, delay: 2, passengers: 35, capacity: 60 },
              { id: '78', name: '78', from: 'Wagle Depot', to: 'Bharat Gears', time: 8, delay: 1, passengers: 45, capacity: 60 },
              { id: '79', name: '79', from: 'Kalyan', to: 'Bhayandar', time: 22, delay: 1, passengers: 32, capacity: 60 },
              { id: '80', name: '80', from: 'Kalyan', to: 'Vasai', time: 24, delay: 2, passengers: 30, capacity: 60 },
              
              // Regular Routes - Panvel Hub
              { id: '81', name: '81', from: 'Panvel', to: 'Colaba', time: 18, delay: 2, passengers: 35, capacity: 60 },
              { id: '82', name: '82', from: 'Panvel', to: 'Mumbai Central', time: 15, delay: 1, passengers: 38, capacity: 60 },
              { id: '83', name: '83', from: 'Panvel', to: 'Bandra', time: 16, delay: 2, passengers: 35, capacity: 60 },
              { id: '84', name: '84', from: 'Panvel', to: 'Andheri', time: 14, delay: 1, passengers: 40, capacity: 60 },
              { id: '85', name: '85', from: 'Borivali', to: 'Colaba', time: 15, delay: 0, passengers: 29, capacity: 70 },
              { id: '86', name: '86', from: 'Panvel', to: 'Borivali', time: 17, delay: 2, passengers: 32, capacity: 60 },
              { id: '87', name: '87', from: 'Panvel', to: 'Dahisar', time: 19, delay: 1, passengers: 30, capacity: 60 },
              { id: '88', name: '88', from: 'Panvel', to: 'Mira Road', time: 22, delay: 2, passengers: 28, capacity: 60 },
              { id: '89', name: '89', from: 'Panvel', to: 'Bhayandar', time: 25, delay: 1, passengers: 25, capacity: 60 },
              { id: '90', name: '90', from: 'Panvel', to: 'Vasai', time: 27, delay: 2, passengers: 22, capacity: 60 },
              
              // Regular Routes - Navi Mumbai
              { id: '91', name: '91', from: 'Vashi', to: 'Colaba', time: 16, delay: 2, passengers: 40, capacity: 60 },
              { id: '92', name: '92', from: 'Vashi', to: 'Mumbai Central', time: 13, delay: 1, passengers: 45, capacity: 60 },
              { id: '93', name: '93', from: 'Vashi', to: 'Bandra', time: 14, delay: 2, passengers: 42, capacity: 60 },
              { id: '94', name: '94', from: 'Vashi', to: 'Andheri', time: 12, delay: 1, passengers: 48, capacity: 60 },
              { id: '95', name: '95', from: 'Vashi', to: 'Borivali', time: 15, delay: 2, passengers: 45, capacity: 60 },
              { id: '96', name: '96', from: 'Vashi', to: 'Dahisar', time: 17, delay: 1, passengers: 42, capacity: 60 },
              { id: '97', name: '97', from: 'Vashi', to: 'Mira Road', time: 20, delay: 2, passengers: 38, capacity: 60 },
              { id: '98', name: '98', from: 'Vashi', to: 'Bhayandar', time: 23, delay: 1, passengers: 35, capacity: 60 },
              { id: '99', name: '99', from: 'Vashi', to: 'Vasai', time: 25, delay: 2, passengers: 32, capacity: 60 },
              { id: '100', name: '100', from: 'Vashi', to: 'Virar', time: 27, delay: 1, passengers: 30, capacity: 60 },
              
              // Regular Routes - Harbour Line
              { id: '101', name: '101', from: 'CSMT', to: 'Colaba', time: 2, delay: 0, passengers: 65, capacity: 60 },
              { id: '102', name: '102', from: 'CSMT', to: 'Mumbai Central', time: 3, delay: 1, passengers: 62, capacity: 60 },
              { id: '103', name: '103', from: 'CSMT', to: 'Bandra', time: 4, delay: 0, passengers: 58, capacity: 60 },
              { id: '104', name: '104', from: 'CSMT', to: 'Andheri', time: 6, delay: 1, passengers: 55, capacity: 60 },
              { id: '105', name: '105', from: 'CSMT', to: 'Borivali', time: 9, delay: 2, passengers: 48, capacity: 60 },
              { id: '106', name: '106', from: 'CSMT', to: 'Dahisar', time: 11, delay: 1, passengers: 45, capacity: 60 },
              { id: '107', name: '107', from: 'CSMT', to: 'Mira Road', time: 14, delay: 2, passengers: 42, capacity: 60 },
              { id: '108', name: '108', from: 'CSMT', to: 'Bhayandar', time: 17, delay: 1, passengers: 38, capacity: 60 },
              { id: '109', name: '109', from: 'CSMT', to: 'Vasai', time: 19, delay: 2, passengers: 35, capacity: 60 },
              { id: '110', name: '110', from: 'CSMT', to: 'Virar', time: 21, delay: 1, passengers: 32, capacity: 60 },
              
              // Regular Routes - Central Line
              { id: '111', name: '111', from: 'CST', to: 'Colaba', time: 2, delay: 0, passengers: 68, capacity: 60 },
              { id: '112', name: '112', from: 'CST', to: 'Mumbai Central', time: 3, delay: 1, passengers: 65, capacity: 60 },
              { id: '113', name: '113', from: 'CST', to: 'Bandra', time: 4, delay: 0, passengers: 62, capacity: 60 },
              { id: '114', name: '114', from: 'CST', to: 'Andheri', time: 6, delay: 1, passengers: 58, capacity: 60 },
              { id: '115', name: '115', from: 'Lakshmi Park', to: 'Mulund Stn W', time: 3, delay: 0, passengers: 45, capacity: 60 },
              { id: '116', name: '116', from: 'CST', to: 'Borivali', time: 9, delay: 2, passengers: 52, capacity: 60 },
              { id: '117', name: '117', from: 'CST', to: 'Dahisar', time: 11, delay: 1, passengers: 48, capacity: 60 },
              { id: '118', name: '118', from: 'CST', to: 'Mira Road', time: 14, delay: 2, passengers: 45, capacity: 60 },
              { id: '119', name: '119', from: 'CST', to: 'Bhayandar', time: 17, delay: 1, passengers: 42, capacity: 60 },
              { id: '120', name: '120', from: 'CST', to: 'Vasai', time: 19, delay: 2, passengers: 38, capacity: 60 },
              
              // Regular Routes - Western Line
              { id: '121', name: '121', from: 'Churchgate', to: 'Colaba', time: 3, delay: 0, passengers: 62, capacity: 60 },
              { id: '122', name: '122', from: 'Churchgate', to: 'Mumbai Central', time: 2, delay: 0, passengers: 65, capacity: 60 },
              { id: '123', name: '123', from: 'Churchgate', to: 'Bandra', time: 5, delay: 1, passengers: 58, capacity: 60 },
              { id: '124', name: '124', from: 'Andheri', to: 'CST', time: 8, delay: 3, passengers: 56, capacity: 65 },
              { id: '125', name: '125', from: 'Churchgate', to: 'Andheri', time: 7, delay: 1, passengers: 55, capacity: 60 },
              { id: '126', name: '126', from: 'Churchgate', to: 'Borivali', time: 10, delay: 2, passengers: 48, capacity: 60 },
              { id: '127', name: '127', from: 'Churchgate', to: 'Dahisar', time: 12, delay: 1, passengers: 45, capacity: 60 },
              { id: '128', name: '128', from: 'Churchgate', to: 'Mira Road', time: 15, delay: 2, passengers: 42, capacity: 60 },
              { id: '129', name: '129', from: 'Churchgate', to: 'Bhayandar', time: 18, delay: 1, passengers: 38, capacity: 60 },
              { id: '130', name: '130', from: 'Churchgate', to: 'Vasai', time: 20, delay: 2, passengers: 35, capacity: 60 },
              
              // Regular Routes - Additional Routes
              { id: '131', name: '131', from: 'Churchgate', to: 'Virar', time: 22, delay: 1, passengers: 32, capacity: 60 },
              { id: '132', name: '132', from: 'Churchgate', to: 'Nalasopara', time: 25, delay: 2, passengers: 30, capacity: 60 },
              { id: '133', name: '133', from: 'Churchgate', to: 'Boisar', time: 28, delay: 1, passengers: 28, capacity: 60 },
              { id: '134', name: '134', from: 'Churchgate', to: 'Palghar', time: 30, delay: 2, passengers: 25, capacity: 60 },
              { id: '135', name: '135', from: 'Churchgate', to: 'Dahanu', time: 35, delay: 1, passengers: 22, capacity: 60 },
              { id: '136', name: '136', from: 'Churchgate', to: 'Vapi', time: 40, delay: 2, passengers: 20, capacity: 60 },
              { id: '137', name: '137', from: 'Churchgate', to: 'Surat', time: 50, delay: 1, passengers: 18, capacity: 60 },
              { id: '138', name: '138', from: 'Churchgate', to: 'Vadodara', time: 60, delay: 2, passengers: 15, capacity: 60 },
              { id: '139', name: '139', from: 'Churchgate', to: 'Ahmedabad', time: 70, delay: 1, passengers: 12, capacity: 60 },
              { id: '140', name: '140', from: 'Churchgate', to: 'Pune', time: 45, delay: 2, passengers: 25, capacity: 60 },
              
              // Regular Routes - More Routes
              { id: '141', name: '141', from: 'Churchgate', to: 'Nashik', time: 35, delay: 1, passengers: 30, capacity: 60 },
              { id: '142', name: '142', from: 'Churchgate', to: 'Aurangabad', time: 55, delay: 2, passengers: 20, capacity: 60 },
              { id: '143', name: '143', from: 'Churchgate', to: 'Nagpur', time: 80, delay: 1, passengers: 15, capacity: 60 },
              { id: '144', name: '144', from: 'Churchgate', to: 'Hyderabad', time: 90, delay: 2, passengers: 12, capacity: 60 },
              { id: '145', name: '145', from: 'Churchgate', to: 'Bangalore', time: 100, delay: 1, passengers: 10, capacity: 60 },
              { id: '146', name: '146', from: 'Churchgate', to: 'Chennai', time: 110, delay: 2, passengers: 8, capacity: 60 },
              { id: '147', name: '147', from: 'Churchgate', to: 'Kolkata', time: 120, delay: 1, passengers: 6, capacity: 60 },
              { id: '148', name: '148', from: 'Churchgate', to: 'Delhi', time: 130, delay: 2, passengers: 5, capacity: 60 },
              { id: '149', name: '149', from: 'Churchgate', to: 'Jaipur', time: 85, delay: 1, passengers: 12, capacity: 60 },
              { id: '150', name: '150', from: 'Churchgate', to: 'Udaipur', time: 95, delay: 2, passengers: 10, capacity: 60 },
              
              // Regular Routes - Final Routes
              { id: '151', name: '151', from: 'Churchgate', to: 'Jodhpur', time: 105, delay: 1, passengers: 8, capacity: 60 },
              { id: '152', name: '152', from: 'Churchgate', to: 'Bikaner', time: 115, delay: 2, passengers: 6, capacity: 60 },
              { id: '153', name: '153', from: 'Churchgate', to: 'Jaisalmer', time: 125, delay: 1, passengers: 5, capacity: 60 },
              { id: '154', name: '154', from: 'Churchgate', to: 'Mount Abu', time: 135, delay: 2, passengers: 4, capacity: 60 },
              { id: '155', name: '155', from: 'Churchgate', to: 'Ajmer', time: 145, delay: 1, passengers: 3, capacity: 60 },
              { id: '156', name: '156', from: 'Churchgate', to: 'Pushkar', time: 150, delay: 2, passengers: 2, capacity: 60 },
              { id: '157', name: '157', from: 'Churchgate', to: 'Ranthambore', time: 160, delay: 1, passengers: 2, capacity: 60 },
              { id: '158', name: '158', from: 'Churchgate', to: 'Sawai Madhopur', time: 165, delay: 2, passengers: 1, capacity: 60 },
              { id: '159', name: '159', from: 'Churchgate', to: 'Kota', time: 170, delay: 1, passengers: 1, capacity: 60 },
              { id: '160', name: '160', from: 'Churchgate', to: 'Bundi', time: 175, delay: 2, passengers: 1, capacity: 60 },
              { mode:'bus', routeId:'A1E', name:'BEST A-1 Express (AC)', from:'Colaba', to:'Bandra',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'BAN', lat:19.0596, lng:72.8295 },
                frequencies:[
                  { days:'weekday', start:'07:00', end:'10:30', headway:10, runtime:55 },
                  { days:'weekday', start:'17:00', end:'20:30', headway:10, runtime:55 }
                ]
              },
              { mode:'bus', routeId:'2L', name:'BEST 2Ltd (AC) - Mumbai Central → Bandra', from:'Mumbai Central', to:'Bandra',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'BAN', lat:19.0596, lng:72.8295 },
                frequencies:[
                  { days:'weekday', start:'07:00', end:'10:30', headway:12, runtime:45 },
                  { days:'weekday', start:'10:30', end:'17:00', headway:15, runtime:45 },
                  { days:'weekday', start:'17:00', end:'20:30', headway:12, runtime:45 }
                ]
              },
              { mode:'bus', routeId:'37', name:'BEST 37 (AC) - Santacruz → Colaba', from:'Santacruz', to:'Colaba',
                fromStop:{ id:'SAN', lat:19.0810, lng:72.8410 }, toStop:{ id:'COL', lat:18.9100, lng:72.8090 },
                frequencies:[ { days:'daily', start:'06:30', end:'22:00', headway:15, runtime:65 } ]
              },

              // Additional BEST routes (from published timetables)
              { mode:'bus', routeId:'234', name:'BEST 234 (AC) - Vesave/Yari Road ↔ Jogeshwari', from:'Vesave/Yari Road', to:'Jogeshwari',
                fromStop:{ id:'VYR', lat:19.1274, lng:72.8050 }, toStop:{ id:'JOG', lat:19.1356, lng:72.8480 },
                frequencies:[
                  { days:'daily', start:'06:00', end:'10:00', headway:10, runtime:35 },
                  { days:'daily', start:'10:00', end:'17:00', headway:15, runtime:35 },
                  { days:'daily', start:'17:00', end:'21:00', headway:10, runtime:35 },
                  { days:'daily', start:'21:00', end:'22:30', headway:15, runtime:35 }
                ]
              },
              { mode:'bus', routeId:'78', name:'BEST 78 (AC) - Wagle Depot ↔ Bharat Gears', from:'Wagle Depot', to:'Bharat Gears',
                fromStop:{ id:'WAG', lat:19.1969, lng:72.9611 }, toStop:{ id:'BGE', lat:19.1780, lng:72.9690 },
                frequencies:[
                  { days:'daily', start:'05:45', end:'10:00', headway:30, runtime:60 },
                  { days:'daily', start:'10:00', end:'17:00', headway:40, runtime:60 },
                  { days:'daily', start:'17:00', end:'19:15', headway:30, runtime:60 }
                ]
              },
              { mode:'bus', routeId:'42', name:'BEST 42 (AC) - Sandhurst Road ↔ Kamla Nehru Park', from:'Sandhurst Road', to:'Kamla Nehru Park',
                fromStop:{ id:'SDR', lat:18.9634, lng:72.8397 }, toStop:{ id:'KNP', lat:18.9533, lng:72.8050 },
                frequencies:[
                  { days:'daily', start:'06:00', end:'22:00', headway:12, runtime:45 }
                ]
              },
              { mode:'bus', routeId:'164', name:'BEST 164 (AC) - Maharana Pratap Chowk ↔ Dharavi Depot', from:'Maharana Pratap Chowk', to:'Dharavi Depot',
                fromStop:{ id:'MPC', lat:19.1735, lng:72.9477 }, toStop:{ id:'DHD', lat:19.0465, lng:72.8543 },
                frequencies:[
                  { days:'daily', start:'06:00', end:'21:30', headway:26, runtime:65 }
                ]
              },
              { mode:'bus', routeId:'9', name:'BEST 9 (AC) - Antop Hill ↔ Colaba', from:'Antop Hill', to:'Colaba',
                fromStop:{ id:'ATH', lat:19.0169, lng:72.8598 }, toStop:{ id:'COL', lat:18.9100, lng:72.8090 },
                frequencies:[
                  { days:'daily', start:'06:30', end:'22:00', headway:30, runtime:70 }
                ]
              },
              { mode:'bus', routeId:'115', name:'BEST 115 (AC) - Lakshmi Park ↔ Mulund Stn W', from:'Lakshmi Park', to:'Mulund Stn (W)',
                fromStop:{ id:'LKP', lat:19.1730, lng:72.9330 }, toStop:{ id:'MLW', lat:19.1736, lng:72.9425 },
                frequencies:[
                  { days:'daily', start:'07:00', end:'12:00', headway:25, runtime:35 },
                  { days:'daily', start:'12:00', end:'17:00', headway:35, runtime:35 },
                  { days:'daily', start:'17:00', end:'22:00', headway:25, runtime:35 }
                ]
              },
              { mode:'bus', routeId:'1', name:'BEST 1 (AC) - Colaba ↔ Bandra', from:'Colaba', to:'Bandra',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'BAN', lat:19.0596, lng:72.8295 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:15, runtime:50 } ]
              },
              { mode:'bus', routeId:'2', name:'BEST 2 (AC) - Colaba ↔ Andheri', from:'Colaba', to:'Andheri',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'AND', lat:19.1197, lng:72.8464 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:20, runtime:70 } ]
              },
              { mode:'bus', routeId:'3', name:'BEST 3 (AC) - Colaba ↔ Borivali', from:'Colaba', to:'Borivali',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'BOR', lat:19.2324, lng:72.8565 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:25, runtime:90 } ]
              },
              { mode:'bus', routeId:'4', name:'BEST 4 (AC) - Colaba ↔ Dahisar', from:'Colaba', to:'Dahisar',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'DAH', lat:19.2487, lng:72.8609 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:30, runtime:100 } ]
              },
              { mode:'bus', routeId:'5', name:'BEST 5 (AC) - Colaba ↔ Mira Road', from:'Colaba', to:'Mira Road',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'MIR', lat:19.2875, lng:72.8682 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:35, runtime:110 } ]
              },
              { mode:'bus', routeId:'6', name:'BEST 6 (AC) - Colaba ↔ Bhayandar', from:'Colaba', to:'Bhayandar',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'BHA', lat:19.3012, lng:72.8745 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:40, runtime:120 } ]
              },
              { mode:'bus', routeId:'7', name:'BEST 7 (AC) - Colaba ↔ Vasai', from:'Colaba', to:'Vasai',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'VAS', lat:19.4089, lng:72.8090 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:45, runtime:130 } ]
              },
              { mode:'bus', routeId:'8', name:'BEST 8 (AC) - Colaba ↔ Virar', from:'Colaba', to:'Virar',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'VIR', lat:19.4558, lng:72.8090 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:50, runtime:140 } ]
              },
              { mode:'bus', routeId:'10', name:'BEST 10 (AC) - Colaba ↔ Boisar', from:'Colaba', to:'Boisar',
                fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'BOI', lat:19.8000, lng:72.7500 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:60, runtime:180 } ]
              },
              { mode:'bus', routeId:'11', name:'BEST 11 (AC) - Mumbai Central ↔ Bandra', from:'Mumbai Central', to:'Bandra',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'BAN', lat:19.0596, lng:72.8295 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:12, runtime:40 } ]
              },
              { mode:'bus', routeId:'12', name:'BEST 12 (AC) - Mumbai Central ↔ Andheri', from:'Mumbai Central', to:'Andheri',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'AND', lat:19.1197, lng:72.8464 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:15, runtime:55 } ]
              },
              { mode:'bus', routeId:'13', name:'BEST 13 (AC) - Mumbai Central ↔ Borivali', from:'Mumbai Central', to:'Borivali',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'BOR', lat:19.2324, lng:72.8565 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:20, runtime:75 } ]
              },
              { mode:'bus', routeId:'14', name:'BEST 14 (AC) - Mumbai Central ↔ Dahisar', from:'Mumbai Central', to:'Dahisar',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'DAH', lat:19.2487, lng:72.8609 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:25, runtime:85 } ]
              },
              { mode:'bus', routeId:'15', name:'BEST 15 (AC) - Mumbai Central ↔ Mira Road', from:'Mumbai Central', to:'Mira Road',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'MIR', lat:19.2875, lng:72.8682 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:30, runtime:95 } ]
              },
              { mode:'bus', routeId:'16', name:'BEST 16 (AC) - Mumbai Central ↔ Bhayandar', from:'Mumbai Central', to:'Bhayandar',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'BHA', lat:19.3012, lng:72.8745 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:35, runtime:105 } ]
              },
              { mode:'bus', routeId:'17', name:'BEST 17 (AC) - Mumbai Central ↔ Vasai', from:'Mumbai Central', to:'Vasai',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'VAS', lat:19.4089, lng:72.8090 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:40, runtime:115 } ]
              },
              { mode:'bus', routeId:'18', name:'BEST 18 (AC) - Mumbai Central ↔ Virar', from:'Mumbai Central', to:'Virar',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'VIR', lat:19.4558, lng:72.8090 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:45, runtime:125 } ]
              },
              { mode:'bus', routeId:'19', name:'BEST 19 (AC) - Mumbai Central ↔ Nalasopara', from:'Mumbai Central', to:'Nalasopara',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'NAL', lat:19.4150, lng:72.8090 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:50, runtime:135 } ]
              },
              { mode:'bus', routeId:'20', name:'BEST 20 (AC) - Mumbai Central ↔ Boisar', from:'Mumbai Central', to:'Boisar',
                fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'BOI', lat:19.8000, lng:72.7500 },
                frequencies:[ { days:'daily', start:'06:00', end:'23:00', headway:60, runtime:165 } ]
              }
            ],
            train: [
              { id: 'WR_F', name: 'Western Fast', from: 'Borivali', to: 'Churchgate', time: 2, delay: 3, passengers: 1247, capacity: 1800 },
              { id: 'WR_S', name: 'Western Slow', from: 'Virar', to: 'Churchgate', time: 4, delay: 1, passengers: 1456, capacity: 1800 },
              { id: 'CR_F', name: 'Central Fast', from: 'Kalyan', to: 'CST', time: 6, delay: 0, passengers: 1523, capacity: 1800 },
              { id: 'HR', name: 'Harbour Line', from: 'Panvel', to: 'CST', time: 8, delay: 2, passengers: 987, capacity: 1800 },
              { id: 'TH', name: 'Trans-Harbour', from: 'Thane', to: 'Vashi', time: 11, delay: 1, passengers: 754, capacity: 1800 }
            ],
            metro: [
              { id: 'M1', name: 'Line 1 (Blue)', from: 'Versova', to: 'Ghatkopar', time: 1, delay: 0, passengers: 234, capacity: 1200 },
              { id: 'M2A', name: 'Line 2A (Yellow)', from: 'Dahisar', to: 'DN Nagar', time: 3, delay: 0, passengers: 156, capacity: 1200 },
              { id: 'M7', name: 'Line 7 (Red)', from: 'Andheri E', to: 'Dahisar E', time: 5, delay: 0, passengers: 198, capacity: 1200 },
              { id: 'M3', name: 'Line 3 (Pink)', from: 'Colaba', to: 'SEEPZ', time: 7, delay: 1, passengers: 267, capacity: 1200 }
            ],
            ferry: [
              { id: 'F1', name: 'Gateway-Elephanta', from: 'Gateway', to: 'Elephanta', time: 25, delay: 0, passengers: 89, capacity: 150 },
              { id: 'F2', name: 'Colaba-Alibaug', from: 'Colaba', to: 'Alibaug', time: 45, delay: 5, passengers: 67, capacity: 200 },
              { id: 'F3', name: 'Mazagon-Mandwa', from: 'Mazagon', to: 'Mandwa', time: 35, delay: 0, passengers: 43, capacity: 180 }
            ],
            monorail: [
              { id: 'MR1', name: 'Monorail Line 1', from: 'Chembur', to: 'Sant Gadge Maharaj Chowk', time: 4, delay: 0, passengers: 210, capacity: 600 }
            ]
          };
        }

        setupEventListeners() {
          document.getElementById('theme-toggle')?.addEventListener('click', () => this.toggleTheme());
          document.getElementById('share-btn')?.addEventListener('click', () => this.shareCurrentView());
          document.getElementById('home-refresh')?.addEventListener('click', () => this.renderHomePanel());

          // Transport cards open detail sheet
          document.querySelectorAll('.transport-card').forEach(card => {
            card.addEventListener('click', () => {
              const transport = card.dataset.transport;
              this.selectTransport(transport);
              this.openDetailsSheet(transport);
            });
          });

          const searchInput = document.getElementById('searchInput');
          searchInput.addEventListener('input', (e) => {
            clearTimeout(this.appData.searchTimer);
            const q = e.target.value.trim();
            this.appData.searchTimer = setTimeout(() => this.performSearch(q), 220);
          });

          // Action buttons open relevant sheets
          document.getElementById('buy-ticket')?.addEventListener('click', () => this.openTicketsSheet());
          document.getElementById('plan-journey')?.addEventListener('click', () => this.openJourneySheet());
          document.getElementById('nearby-stations')?.addEventListener('click', () => this.openNearbySheet());
          document.getElementById('recharge-card')?.addEventListener('click', () => this.openRechargeSheet());
          document.getElementById('fare-estimator')?.addEventListener('click', () => this.openFareEstimator());

          // Navigation buttons
          document.querySelectorAll('.nav-button').forEach(btn => {
            btn.addEventListener('click', () => {
              document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              const nav = btn.dataset.nav;
              if (nav === 'tickets') this.openTicketsSheet();
              else if (nav === 'account') this.openAccountSheet();
              else if (nav === 'map') this.scrollToSection('live-heading');
              else this.scrollToSection('modes-heading');
            });
          });

          // Time selector
          document.getElementById('useNow')?.addEventListener('click', () => {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            document.getElementById('refTime').value = timeStr;
            this.updateSchedules();
          });

          document.getElementById('refTime')?.addEventListener('change', () => this.updateSchedules());

          // Sheet controls
          this.setupSheetControls();

          document.addEventListener('visibilitychange', () => {
            if (document.hidden) this.pauseUpdates();
            else this.resumeUpdates();
          });

          window.addEventListener('beforeunload', () => this.cleanup());

          // URL params for embed mode
          this.handleURLParams();

          // Initial render for home panel
          this.renderHomePanel();

          // FAB
          const fab = document.getElementById('fab');
          const fabMain = document.getElementById('fab-main');
          fabMain.addEventListener('click', () => fab.classList.toggle('show'));
          document.getElementById('fab-fare').addEventListener('click', () => this.openFareEstimator());
          document.getElementById('fab-tickets').addEventListener('click', () => this.openTicketsSheet());
          document.getElementById('fab-nearby').addEventListener('click', () => this.openNearbySheet());
        }

        shareCurrentView() {
          const url = location.href;
          if (navigator.share) {
            navigator.share({ title: 'Mumbai Transport Hub', url }).catch(()=>{});
          } else if (navigator.clipboard) {
            navigator.clipboard.writeText(url).then(() => this.showNotification('🔗 Link copied'));
          } else {
            this.showNotification('🔗 ' + url);
          }
        }

        renderHomePanel() {
          const recentWrap = document.getElementById('recentList');
          const tripsWrap = document.getElementById('tripsList');
          if (!recentWrap || !tripsWrap) return;

          // Recent searches as chips
          recentWrap.innerHTML = '';
          if (this.appData.recentSearches.length === 0) {
            recentWrap.innerHTML = '<span class="chip">No recent searches</span>';
          } else {
            this.appData.recentSearches.forEach(q => {
              const chip = document.createElement('button');
              chip.className = 'chip';
              chip.type = 'button';
              chip.textContent = q;
              chip.addEventListener('click', () => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                  searchInput.value = q;
                  this.performSearch(q);
                  this.scrollToSection('departures-heading');
                }
              });
              recentWrap.appendChild(chip);
            });
          }

          // Saved trips list with focus chips
          tripsWrap.innerHTML = '';
          if (this.appData.savedTrips.length === 0) {
            tripsWrap.innerHTML = '<div class="frequency-item"><div><strong>No saved trips</strong><br><span style="color:var(--text-secondary);font-size:13px">Save routes from search</span></div></div>';
          } else {
            this.appData.savedTrips.forEach(t => {
              // Lookup from schedules to get name/endpoints
              const all = window.MUMBAI_SCHEDULES?.routes || [];
              const match = all.find(r => r.mode === t.transport && (r.routeId === t.id || r.id === t.id));
              const title = match ? match.name : `${t.transport.toUpperCase()} • ${t.id}`;
              const sub = match ? `${match.from} → ${match.to}` : 'Saved route';
              const row = document.createElement('div');
              row.className = 'frequency-item';
              row.innerHTML = `
                <div>
                  <strong>${title}</strong><br>
                  <span style="color:var(--text-secondary);font-size:13px">${sub}</span>
                </div>
                <div>
                  <button class="chip info" data-focus="${t.transport}:${t.id}"><i class="fa-solid fa-location-crosshairs"></i> Focus</button>
                </div>
              `;
              tripsWrap.appendChild(row);
            });
            tripsWrap.querySelectorAll('[data-focus]').forEach(btn => {
              btn.addEventListener('click', () => {
                const [transport, id] = btn.getAttribute('data-focus').split(':');
                this.focusRoute({ transport, id });
              });
            });
          }

          // Clear handlers
          const clearRecent = document.getElementById('clear-recent');
          const clearTrips = document.getElementById('clear-trips');
          clearRecent?.addEventListener('click', () => {
            this.appData.recentSearches = [];
            localStorage.setItem('mth.recentSearches', '[]');
            this.renderHomePanel();
          });
          clearTrips?.addEventListener('click', () => {
            this.appData.savedTrips = [];
            localStorage.setItem('mth.savedTrips', '[]');
            this.renderHomePanel();
          });
        }

        focusRoute({ transport, id }) {
          // Find route and zoom map to corridor endpoints
          const all = window.MUMBAI_SCHEDULES?.routes || [];
          const match = all.find(r => r.mode === transport && (r.routeId === id || r.id === id));
          if (!match || !this.map) {
            this.showNotification('⚠️ Route details not available');
            return;
          }
          const from = match.fromStop, to = match.toStop;
          if (from && to) {
            const bounds = L.latLngBounds([ [from.lat, from.lng], [to.lat, to.lng] ]);
            this.map.fitBounds(bounds.pad(0.2));
            this.scrollToSection('live-heading');
            this.showNotification(`🎯 Focused ${match.name}`);
          }
        }

        setupSheetControls() {
          const backdrop = document.getElementById('sheetBackdrop');
          const closeBtn = document.getElementById('sheetClose');
          
          [backdrop, closeBtn].forEach(el => {
            el?.addEventListener('click', () => this.closeSheet());
          });

          // Prevent sheet content clicks from closing
          document.getElementById('sheet')?.addEventListener('click', (e) => e.stopPropagation());
        }

        handleURLParams() {
          const params = new URLSearchParams(window.location.search);
          if (params.get('embed') === '1') {
            document.body.classList.add('embedded');
          }
          const mode = params.get('mode');
          if (mode) this.selectTransport(mode);

          // Deep-link sheet via hash
          const sheet = this.readHashParam('sheet');
          if (sheet === 'tickets') this.openTicketsSheet();
          else if (sheet === 'journey') this.openJourneySheet();
          else if (sheet === 'nearby') this.openNearbySheet();
          else if (sheet === 'recharge') this.openRechargeSheet();
          else if (sheet === 'account') this.openAccountSheet();
          else if (sheet && sheet.startsWith('mode=')) {
            const m = sheet.split('=')[1];
            this.openDetailsSheet(m);
          }
        }

        scrollToSection(headingId) {
          document.getElementById(headingId)?.scrollIntoView({ behavior: 'smooth' });
        }

        initMap() {
          const fallback = document.getElementById('mapFallback');
          const leafletDiv = document.getElementById('leafletMap');
          const miniWrap = document.getElementById('miniMapWrap');
          const miniDiv = document.getElementById('miniMap');
          try {
            if (window.L && leafletDiv) {
              this.map = L.map('leafletMap', { zoomControl: false, attributionControl: false }).setView([19.076, 72.8777], 11);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
              }).addTo(this.map);
              fallback.hidden = true;
              leafletDiv.hidden = false;

              // Mini map
              if (miniDiv) {
                this.miniMap = L.map('miniMap', { zoomControl: false, attributionControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false, boxZoom: false, keyboard: false }).setView([19.076, 72.8777], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(this.miniMap);
                miniWrap.classList.add('show');
              }
            } else {
              throw new Error('Leaflet not available yet');
            }
          } catch (e) {
            console.warn('Map init fallback:', e.message);
            this.mapFallbackMode = true;
            fallback.hidden = false;
            leafletDiv.hidden = true;
          }
        }

        createInitialVehicles() {
          const colors = { bus: '#5E6AD2', train: '#00B87A', metro: '#8B5CF6', ferry: '#0EA5E9', monorail: '#10B981' };
          const types = Object.keys(colors);
          const routes = ['A1E','2L','37','WR_F','CR_F','M1','M2A','F1','MR1'];

          for (let i = 0; i < 24; i++) {
            const type = types[i % types.length];
            const route = routes[i % routes.length];
            const lat = this.randomInRange(this.vehicleBounds.latMin, this.vehicleBounds.latMax);
            const lng = this.randomInRange(this.vehicleBounds.lngMin, this.vehicleBounds.lngMax);
            const dx = (Math.random() - 0.5) * 0.002;
            const dy = (Math.random() - 0.5) * 0.002;

            const vehicle = {
              id: `vehicle_${i}`,
              type, route,
              color: colors[type],
              lat, lng, dx, dy,
              speed: Math.random() * 0.8 + 0.2,
              lastUpdate: Date.now()
            };
            this.appData.vehicles.set(vehicle.id, vehicle);

            if (this.map && !this.mapFallbackMode) {
              const marker = L.circleMarker([vehicle.lat, vehicle.lng], {
                radius: 5, color: '#fff', weight: 1.5, fillColor: vehicle.color, fillOpacity: 1
              }).bindTooltip(`${vehicle.type.toUpperCase()} ${vehicle.route}`, { direction: 'top', offset: [0, -4] });
              marker.addTo(this.map);
              this.appData.leafletMarkers.set(vehicle.id, marker);
            }
          }
        }

        updateVehiclePositions() {
          try {
            const mapContent = document.getElementById('mapContent');
            if (this.mapFallbackMode && mapContent) {
              mapContent.querySelectorAll('.vehicle-marker').forEach(m => m.remove());
            }

            const deltaScale = this.appData.reduceMotion ? 0.5 : 1;
            this.appData.vehicles.forEach(v => {
              v.lat += v.dy * v.speed * deltaScale;
              v.lng += v.dx * v.speed * deltaScale;

              if (v.lat < this.vehicleBounds.latMin || v.lat > this.vehicleBounds.latMax) v.dy *= -1;
              if (v.lng < this.vehicleBounds.lngMin || v.lng > this.vehicleBounds.lngMax) v.dx *= -1;

              v.lat = Math.min(this.vehicleBounds.latMax, Math.max(this.vehicleBounds.latMin, v.lat));
              v.lng = Math.min(this.vehicleBounds.lngMax, Math.max(this.vehicleBounds.lngMin, v.lng));

              if (Math.random() < 0.03) {
                v.dx += (Math.random() - 0.5) * 0.0006;
                v.dy += (Math.random() - 0.5) * 0.0006;
              }

              if (this.map && !this.mapFallbackMode) {
                const marker = this.appData.leafletMarkers.get(v.id);
                if (marker) marker.setLatLng([v.lat, v.lng]);
                // Sync a subset to mini map for performance
                if (this.miniMap && Math.random() < 0.15) {
                  if (!this.miniMarkers) this.miniMarkers = new Map();
                  let m = this.miniMarkers.get(v.id);
                  if (!m) {
                    m = L.circleMarker([v.lat, v.lng], { radius: 3, color: '#fff', weight: 1, fillColor: v.color, fillOpacity: 1 });
                    m.addTo(this.miniMap);
                    this.miniMarkers.set(v.id, m);
                  } else {
                    m.setLatLng([v.lat, v.lng]);
                  }
                }
              } else if (mapContent) {
                // Render fallback markers in a simple grid (not geo-accurate)
                const marker = document.createElement('div');
                marker.className = 'vehicle-marker';
                marker.style.backgroundColor = v.color;
                const xPct = ((v.lng - this.vehicleBounds.lngMin) / (this.vehicleBounds.lngMax - this.vehicleBounds.lngMin)) * 90 + 5;
                const yPct = ((v.lat - this.vehicleBounds.latMin) / (this.vehicleBounds.latMax - this.vehicleBounds.latMin)) * 90 + 5;
                marker.style.left = xPct + '%';
                marker.style.top = (100 - yPct) + '%';
                marker.setAttribute('data-route', v.route);
                marker.title = `${v.type.toUpperCase()} ${v.route} - Live tracking`;
                mapContent.appendChild(marker);
              }
            });
          } catch (e) {
            console.error('updateVehiclePositions error:', e);
          }
        }

        updateSchedules() {
          const scheduleList = document.getElementById('scheduleList');
          const transport = this.appData.selectedTransport;
          const routes = this.appData.routes[transport] || [];
          const nowHour = new Date().getHours();
          const isPeak = this.peakHours.some(p => nowHour >= p.start && nowHour <= p.end);

          routes.forEach(route => {
            if (Math.random() < 0.3) route.time = Math.max(1, route.time + (Math.random() > 0.5 ? -1 : 1));
            if (isPeak && Math.random() < 0.4) route.delay = Math.min(10, (route.delay || 0) + Math.floor(Math.random() * 2));
            else if (!isPeak && route.delay > 0 && Math.random() < 0.6) route.delay = Math.max(0, route.delay - 1);
          });

          scheduleList.innerHTML = '';

          const colors = { bus: '#5E6AD2', train: '#00B87A', metro: '#8B5CF6', ferry: '#0EA5E9', monorail: '#10B981' };
          const icons = { bus: 'fa-bus', train: 'fa-train-subway', metro: 'fa-train-tram', ferry: 'fa-ship', monorail: 'fa-train' };

          routes.slice(0, 8).forEach(route => {
            const item = document.createElement('div');
            item.className = 'schedule-item';
            const totalTime = (route.time || 0) + (route.delay || 0);
            const delayText = route.delay > 0 ? ` (+${route.delay} min delay)` : '';
            const occupancy = Math.min(100, Math.round((route.passengers / route.capacity) * 100));

            item.innerHTML = `
              <div class="schedule-icon" style="background: ${colors[transport]};"><i class="fa-solid ${icons[transport]}"></i></div>
              <div class="schedule-content">
                <div class="schedule-route">${route.name} • ${route.from} → ${route.to}</div>
                <div class="schedule-time">Next: ${totalTime} min${delayText} • ${occupancy}% full</div>
              </div>
            `;
            if (Math.random() < 0.15) {
              item.classList.add('updating');
              setTimeout(() => item.classList.remove('updating'), 900);
            }
            scheduleList.appendChild(item);
          });
        }

        updateStats() {
          const stats = {
            bus: { count: 518, ontime: 92 },
            train: { count: 2847, ontime: 87 },
            metro: { count: 12, ontime: 98 },
            ferry: { count: 8, ontime: 95 },
            monorail: { count: 1, ontime: 94 }
          };
          Object.keys(stats).forEach(transport => {
            const countEl = document.getElementById(`${transport}-count`);
            const ontimeEl = document.getElementById(`${transport}-ontime`);
            if (!countEl || !ontimeEl) return;

            const countVariation = Math.floor(Math.random() * 10) - 5;
            const ontimeVariation = Math.floor(Math.random() * 4) - 2;
            const newCount = Math.max(0, stats[transport].count + countVariation);
            const newOntime = Math.max(70, Math.min(100, stats[transport].ontime + ontimeVariation));

            if (countEl.textContent !== newCount.toLocaleString()) {
              countEl.classList.add('updating');
              countEl.textContent = newCount.toLocaleString();
              setTimeout(() => countEl.classList.remove('updating'), 500);
            }
            if (ontimeEl.textContent !== `${newOntime}%`) {
              ontimeEl.classList.add('updating');
              ontimeEl.textContent = `${newOntime}%`;
              setTimeout(() => ontimeEl.classList.remove('updating'), 500);
            }

            const card = document.querySelector(`[data-transport="${transport}"]`);
            if (card) {
              const indicator = card.querySelector('.status-indicator');
              const statusText = card.querySelector('.card-status-text');
              if (newOntime >= 95) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = 'Operational';
              } else if (newOntime >= 85) {
                indicator.className = 'status-indicator status-delayed';
                statusText.textContent = 'Minor Delays';
              } else {
                indicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Major Delays';
              }
            }
          });
        }

        updateServiceUpdates() {
          const updatesList = document.getElementById('updatesList');
          const possible = [
            { type: 'success', icon: 'fa-circle-check', text: 'Metro Line 1 running at 2-min frequency during peak', category: 'metro' },
            { type: 'warning', icon: 'fa-triangle-exclamation', text: 'Western Line delays 3-5 min due to signal issue at Dadar', category: 'train' },
            { type: 'info', icon: 'fa-circle-info', text: 'BEST 2Ltd diverted via Linking Road (construction)', category: 'bus' },
            { type: 'success', icon: 'fa-ship', text: 'Ferry to Elephanta on schedule (every 30 min)', category: 'ferry' },
            { type: 'warning', icon: 'fa-cloud-rain', text: 'Heavy rain may impact bus timings. Plan extra time.', category: 'weather' },
            { type: 'info', icon: 'fa-tools', text: 'Central Line block Kurla-Ghatkopar 11 PM–4 AM (maintenance)', category: 'maintenance' }
          ];

          if (Math.random() < 0.1 && this.appData.updates.length < 6) {
            this.appData.updates.unshift({
              ...possible[Math.floor(Math.random() * possible.length)],
              id: Date.now(),
              time: new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date()),
              isNew: true
            });
          }

          updatesList.innerHTML = '';
          if (this.appData.updates.length === 0) {
            updatesList.innerHTML = `
              <div class="update-item">
                <div class="update-icon" style="background: var(--success);">
                  <i class="fa-solid fa-circle-check"></i>
                </div>
                <div class="update-content">
                  <div class="update-text">All Mumbai transport services operating normally</div>
                  <div class="update-time"><i class="fa-regular fa-clock"></i> ${new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date())}</div>
                </div>
              </div>
            `;
            return;
          }

          const colorMap = { success: 'var(--success)', warning: 'var(--warning)', info: 'var(--info)', error: 'var(--error)' };
          this.appData.updates.forEach(u => {
            const item = document.createElement('div');
            item.className = `update-item ${u.isNew ? 'new' : ''}`;
            item.innerHTML = `
              <div class="update-icon" style="background: ${colorMap[u.type]};"><i class="fa-solid ${u.icon}"></i></div>
              <div class="update-content">
                <div class="update-text">${u.text}</div>
                <div class="update-time"><i class="fa-regular fa-clock"></i> ${u.time}</div>
              </div>
            `;
            updatesList.appendChild(item);
            if (u.isNew) setTimeout(() => { u.isNew = false; }, 1500);
          });
        }

        selectTransport(transport) {
          this.appData.selectedTransport = transport;
          localStorage.setItem(STORAGE_KEYS.transport, transport);
          document.querySelectorAll('.transport-card').forEach(card => {
            const isActive = card.dataset.transport === transport;
            card.classList.toggle('active', isActive);
            card.setAttribute('aria-selected', String(isActive));
          });
          this.updateSchedules();
          this.showNotification(`🚌 Switched to ${transport.toUpperCase()} view`);
        }

        performSearch(query) {
          const scheduleList = document.getElementById('scheduleList');
          if (query.length < 2) {
            this.updateSchedules();
            return;
          }

          const allRoutes = [];
          const colors = { bus: '#5E6AD2', train: '#00B87A', metro: '#8B5CF6', ferry: '#0EA5E9', monorail: '#10B981' };
          const icons = { bus: 'fa-bus', train: 'fa-train-subway', metro: 'fa-train-tram', ferry: 'fa-ship', monorail: 'fa-train' };

          Object.keys(this.appData.routes).forEach(transport => {
            this.appData.routes[transport].forEach(route => allRoutes.push({ ...route, transport, color: colors[transport], icon: icons[transport] }));
          });

          const q = query.toLowerCase();
          const filtered = allRoutes.filter(route =>
            route.name.toLowerCase().includes(q) || route.from.toLowerCase().includes(q) || route.to.toLowerCase().includes(q)
          );

          scheduleList.innerHTML = '';
          if (filtered.length === 0) {
            scheduleList.innerHTML = `
              <div class="update-item">
                <div class="update-icon" style="background: var(--text-muted);">
                  <i class="fa-solid fa-magnifying-glass"></i>
                </div>
                <div class="update-content">
                  <div class="update-text">No routes found for "${this.escapeHtml(query)}"</div>
                  <div class="update-time">Try searching for route numbers or station names</div>
                </div>
              </div>
            `;
            return;
          }

          filtered.slice(0, 12).forEach(route => {
            const item = document.createElement('div');
            item.className = 'schedule-item';
            const totalTime = (route.time || 0) + (route.delay || 0);
            const delayText = route.delay > 0 ? ` (+${route.delay} min delay)` : '';
            item.innerHTML = `
              <div class="schedule-icon" style="background: ${route.color};"><i class="fa-solid ${route.icon}"></i></div>
              <div class="schedule-content">
                <div class="schedule-route">${route.name} • ${route.from} → ${route.to}</div>
                <div class="schedule-time">Next: ${totalTime} min${delayText} • ${route.transport.toUpperCase()}</div>
              </div>
              <button class="chip" data-save="${route.transport}:${route.id}"><i class="fa-solid fa-bookmark"></i> Save</button>
            `;
            scheduleList.appendChild(item);
          });

          // Save recent search
          this.addRecentSearch(query);
          // Bind save buttons
          scheduleList.querySelectorAll('[data-save]').forEach(btn => {
            btn.addEventListener('click', () => {
              const [transport, id] = btn.getAttribute('data-save').split(':');
              this.saveTrip({ transport, id });
              this.showNotification('⭐ Saved to Trips');
            });
          });
        }

        addRecentSearch(q) {
          const list = this.appData.recentSearches.filter(s => s !== q);
          list.unshift(q);
          this.appData.recentSearches = list.slice(0,8);
          localStorage.setItem('mth.recentSearches', JSON.stringify(this.appData.recentSearches));
        }

        saveTrip(trip) {
          const key = `${trip.transport}:${trip.id}`;
          const exists = this.appData.savedTrips.find(t => `${t.transport}:${t.id}` === key);
          if (!exists) {
            this.appData.savedTrips.unshift(trip);
            this.appData.savedTrips = this.appData.savedTrips.slice(0,8);
            localStorage.setItem('mth.savedTrips', JSON.stringify(this.appData.savedTrips));
          }
        }

        findNearbyStations() {
          // Get user's current location using GPS
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                
                // Calculate nearby stations based on actual location
                const nearbyStations = this.calculateNearbyStations(userLat, userLng);
                
                if (nearbyStations.length > 0) {
                  const closest = nearbyStations[0];
                  this.showNotification(`📍 Nearest: ${closest.name} (${closest.distance}km)`);
                  
                  setTimeout(() => {
                    this.showNotification(`📍 Found ${nearbyStations.length} stations within 3km`);
                  }, 1500);
                  
                  // Update nearby stations in the UI
                  this.updateNearbyStationsUI(nearbyStations);
                } else {
                  this.showNotification('📍 No stations found nearby. Try moving to a different location.');
                }
              },
              (error) => {
                console.error('Location error:', error);
                // Fallback to approximate location based on IP or default to Mumbai Central
                this.showNotification('📍 Using approximate location (Mumbai Central area)');
                this.findNearbyStationsFallback();
              },
              {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5 minutes
              }
            );
          } else {
            this.showNotification('📍 Location services not available');
            this.findNearbyStationsFallback();
          }
        }

        calculateNearbyStations(userLat, userLng) {
          // Mumbai transport stations with accurate coordinates
          const stations = [
            { name: 'Churchgate Station', type: 'Western Line', lat: 18.9349, lng: 72.8248 },
            { name: 'Marine Lines', type: 'Western Line', lat: 18.9439, lng: 72.8234 },
            { name: 'Charni Road', type: 'Western Line', lat: 18.9529, lng: 72.8219 },
            { name: 'Grant Road', type: 'Western Line', lat: 18.9619, lng: 72.8204 },
            { name: 'Mumbai Central', type: 'Western Line', lat: 18.9719, lng: 72.8194 },
            { name: 'Mahalaxmi', type: 'Western Line', lat: 18.9819, lng: 72.8184 },
            { name: 'Lower Parel', type: 'Western Line', lat: 18.9919, lng: 72.8174 },
            { name: 'Elphinstone Road', type: 'Western Line', lat: 19.0019, lng: 72.8164 },
            { name: 'Prabhadevi', type: 'Western Line', lat: 19.0119, lng: 72.8154 },
            { name: 'Dadar', type: 'Western/Central Line', lat: 19.0219, lng: 72.8144 },
            { name: 'Matunga', type: 'Western Line', lat: 19.0319, lng: 72.8134 },
            { name: 'Mahim Junction', type: 'Western Line', lat: 19.0419, lng: 72.8124 },
            { name: 'Bandra', type: 'Western Line', lat: 19.0596, lng: 72.8295 },
            { name: 'Khar Road', type: 'Western Line', lat: 19.0696, lng: 72.8305 },
            { name: 'Santacruz', type: 'Western Line', lat: 19.0810, lng: 72.8410 },
            { name: 'Vile Parle', type: 'Western Line', lat: 19.0910, lng: 72.8420 },
            { name: 'Andheri', type: 'Western Line', lat: 19.1197, lng: 72.8464 },
            { name: 'Jogeshwari', type: 'Western Line', lat: 19.1356, lng: 72.8480 },
            { name: 'Goregaon', type: 'Western Line', lat: 19.1516, lng: 72.8496 },
            { name: 'Malad', type: 'Western Line', lat: 19.1676, lng: 72.8512 },
            { name: 'Kandivali', type: 'Western Line', lat: 19.1836, lng: 72.8528 },
            { name: 'Borivali', type: 'Western Line', lat: 19.2324, lng: 72.8565 },
            { name: 'Dahisar', type: 'Western Line', lat: 19.2487, lng: 72.8609 },
            { name: 'Mira Road', type: 'Western Line', lat: 19.2875, lng: 72.8682 },
            { name: 'Bhayandar', type: 'Western Line', lat: 19.3012, lng: 72.8745 },
            { name: 'Vasai Road', type: 'Western Line', lat: 19.4089, lng: 72.8090 },
            { name: 'Virar', type: 'Western Line', lat: 19.4558, lng: 72.8090 },
            { name: 'CST Terminus', type: 'Central/Harbour Line', lat: 18.9398, lng: 72.8354 },
            { name: 'Masjid Bunder', type: 'Central Line', lat: 18.9498, lng: 72.8344 },
            { name: 'Sandhurst Road', type: 'Central Line', lat: 18.9634, lng: 72.8397 },
            { name: 'Byculla', type: 'Central Line', lat: 18.9734, lng: 72.8387 },
            { name: 'Chinchpokli', type: 'Central Line', lat: 18.9834, lng: 72.8377 },
            { name: 'Currey Road', type: 'Central Line', lat: 18.9934, lng: 72.8367 },
            { name: 'Parel', type: 'Central Line', lat: 19.0034, lng: 72.8357 },
            { name: 'Sewri', type: 'Harbour Line', lat: 19.0134, lng: 72.8347 },
            { name: 'Cotton Green', type: 'Harbour Line', lat: 19.0234, lng: 72.8337 },
            { name: 'Reay Road', type: 'Harbour Line', lat: 19.0334, lng: 72.8327 },
            { name: 'Dockyard Road', type: 'Harbour Line', lat: 19.0434, lng: 72.8317 },
            { name: 'Wadala Road', type: 'Harbour Line', lat: 19.0534, lng: 72.8307 },
            { name: 'GTB Nagar', type: 'Harbour Line', lat: 19.0634, lng: 72.8297 },
            { name: 'Chunabhatti', type: 'Harbour Line', lat: 19.0734, lng: 72.8287 },
            { name: 'Kurla', type: 'Central/Harbour Line', lat: 19.0669, lng: 72.8830 },
            { name: 'Tilak Nagar', type: 'Central Line', lat: 19.0769, lng: 72.8820 },
            { name: 'Chembur', type: 'Harbour Line', lat: 19.0869, lng: 72.8810 },
            { name: 'Govandi', type: 'Harbour Line', lat: 19.0969, lng: 72.8800 },
            { name: 'Mankhurd', type: 'Harbour Line', lat: 19.1069, lng: 72.8790 },
            { name: 'Vashi', type: 'Harbour Line', lat: 19.0802, lng: 72.9984 },
            { name: 'Sanpada', type: 'Harbour Line', lat: 19.0902, lng: 72.9974 },
            { name: 'Juinagar', type: 'Harbour Line', lat: 19.1002, lng: 72.9964 },
            { name: 'Nerul', type: 'Harbour Line', lat: 19.1102, lng: 72.9954 },
            { name: 'Seawoods Darave', type: 'Harbour Line', lat: 19.1202, lng: 72.9944 },
            { name: 'Belapur CBD', type: 'Harbour Line', lat: 19.1302, lng: 72.9934 },
            { name: 'Kharghar', type: 'Harbour Line', lat: 19.1402, lng: 72.9924 },
            { name: 'Mansarovar', type: 'Harbour Line', lat: 19.1502, lng: 72.9914 },
            { name: 'Khandeshwar', type: 'Harbour Line', lat: 19.1602, lng: 72.9904 },
            { name: 'Panvel', type: 'Harbour Line', lat: 18.9881, lng: 73.1103 },
            { name: 'Ghatkopar', type: 'Central Line', lat: 19.0769, lng: 72.9080 },
            { name: 'Vikhroli', type: 'Central Line', lat: 19.0869, lng: 72.9070 },
            { name: 'Kanjurmarg', type: 'Central Line', lat: 19.0969, lng: 72.9060 },
            { name: 'Bhandup', type: 'Central Line', lat: 19.1069, lng: 72.9050 },
            { name: 'Nahur', type: 'Central Line', lat: 19.1169, lng: 72.9040 },
            { name: 'Mulund', type: 'Central Line', lat: 19.1736, lng: 72.9425 },
            { name: 'Thane', type: 'Central Line', lat: 19.2183, lng: 72.9781 },
            { name: 'Kalyan', type: 'Central Line', lat: 19.2433, lng: 73.1355 },
            { name: 'Versova Metro', type: 'Metro Line 1', lat: 19.1274, lng: 72.8050 },
            { name: 'DN Nagar Metro', type: 'Metro Line 1', lat: 19.1197, lng: 72.8464 },
            { name: 'Andheri Metro', type: 'Metro Line 1', lat: 19.1197, lng: 72.8464 },
            { name: 'Western Express Highway Metro', type: 'Metro Line 1', lat: 19.1097, lng: 72.8564 },
            { name: 'Chakala Metro', type: 'Metro Line 1', lat: 19.0997, lng: 72.8664 },
            { name: 'Airport Road Metro', type: 'Metro Line 1', lat: 19.0897, lng: 72.8764 },
            { name: 'Marol Naka Metro', type: 'Metro Line 1', lat: 19.0797, lng: 72.8864 },
            { name: 'Saki Naka Metro', type: 'Metro Line 1', lat: 19.0697, lng: 72.8964 },
            { name: 'Asalpha Metro', type: 'Metro Line 1', lat: 19.0597, lng: 72.9064 },
            { name: 'Jagruti Nagar Metro', type: 'Metro Line 1', lat: 19.0497, lng: 72.9164 },
            { name: 'Ghatkopar Metro', type: 'Metro Line 1', lat: 19.0769, lng: 72.9080 }
          ];

          // Calculate distances and sort by proximity
          const nearbyStations = stations.map(station => {
            const distance = this.calculateDistance(userLat, userLng, station.lat, station.lng);
            return {
              ...station,
              distance: Math.round(distance * 10) / 10 // Round to 1 decimal place
            };
          }).filter(station => station.distance <= 3) // Within 3km
            .sort((a, b) => a.distance - b.distance)
            .slice(0, 10); // Top 10 nearest

          return nearbyStations;
        }

        calculateDistance(lat1, lng1, lat2, lng2) {
          const R = 6371; // Earth's radius in kilometers
          const dLat = this.deg2rad(lat2 - lat1);
          const dLng = this.deg2rad(lng2 - lng1);
          const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) * 
            Math.sin(dLng/2) * Math.sin(dLng/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          const distance = R * c; // Distance in kilometers
          return distance;
        }

        deg2rad(deg) {
          return deg * (Math.PI/180);
        }

        updateNearbyStationsUI(stations) {
          // Update the nearby stations display in the UI
          const nearbySection = document.querySelector('.nearby-stations');
          if (nearbySection) {
            nearbySection.innerHTML = '';
            stations.forEach(station => {
              const stationElement = document.createElement('div');
              stationElement.className = 'nearby-station-item';
              stationElement.innerHTML = `
                <div class="station-info">
                  <strong>${station.name}</strong>
                  <span class="station-type">${station.type}</span>
                </div>
                <div class="station-distance">${station.distance}km</div>
              `;
              nearbySection.appendChild(stationElement);
            });
          }
        }

        findNearbyStationsFallback() {
          // Fallback when GPS is not available
          const fallbackStations = [
            'Churchgate Station - 0.3 km (Western Line)',
            'Marine Lines - 0.8 km (Western Line)',
            'Charni Road - 1.2 km (Western Line)',
            'CST Terminus - 1.5 km (Central/Harbour Lines)',
            'Ghatkopar Metro - 2.1 km (Metro Line 1)'
          ];
          this.showNotification(`📍 Nearby: ${fallbackStations[0]}`);
          setTimeout(() => this.showNotification(`📍 Found ${fallbackStations.length} stations within 3km radius`), 1500);
        }

        toggleTheme() {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          const newTheme = isDark ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem(STORAGE_KEYS.theme, newTheme);
          const themeIcon = document.querySelector('#theme-toggle i');
          themeIcon.className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
          this.showNotification(`${isDark ? '🌞' : '🌙'} Switched to ${newTheme} theme`);
        }

        showNotification(message) {
          const notification = document.createElement('div');
          notification.className = 'notification';
          notification.role = 'status';
          notification.textContent = message;
          document.body.appendChild(notification);
          const live = document.getElementById('liveRegion');
          if (live) live.textContent = message;

          setTimeout(() => {
            notification.remove();
          }, 2600);
        }

        updateUI() {
          this.updateVehiclePositions();
          this.updateSchedules();
          this.updateStats();
          this.updateServiceUpdates();
        }

        startRealTimeUpdates() {
          const vehicleInterval = this.appData.reduceMotion ? 3000 : 1800;
          this.timers.vehicles = setInterval(() => this.updateVehiclePositions(), vehicleInterval);
          this.timers.schedules = setInterval(() => this.updateSchedules(), 5000);
          this.timers.stats = setInterval(() => this.updateStats(), 8000);
          this.timers.updates = setInterval(() => this.updateServiceUpdates(), 15000);

          setInterval(() => {
            if (this.appData.updates.length > 8) this.appData.updates = this.appData.updates.slice(0, 6);
          }, 60000);
        }

        pauseUpdates() {
          Object.values(this.timers).forEach(t => t && clearInterval(t));
          this.timers = { vehicles: null, schedules: null, stats: null, updates: null };
        }
        resumeUpdates() {
          if (!this.timers.vehicles) this.startRealTimeUpdates();
        }
        cleanup() { this.pauseUpdates(); }

        restoreSelectedTransportUI() {
          const t = this.appData.selectedTransport;
          document.querySelectorAll('.transport-card').forEach(card => {
            const isActive = card.dataset.transport === t;
            card.classList.toggle('active', isActive);
            card.setAttribute('aria-selected', String(isActive));
          });
        }

        setupNetworkBanner() {
          const banner = document.getElementById('networkBanner');
          const update = () => {
            if (navigator.onLine) {
              banner.textContent = 'Online';
              banner.className = 'network-banner online show';
              setTimeout(() => banner.classList.remove('show'), 1200);
            } else {
              banner.textContent = 'You are offline. Showing cached data (if available).';
              banner.className = 'network-banner show';
            }
          };
          window.addEventListener('online', update);
          window.addEventListener('offline', update);
          update();
        }

        registerServiceWorker() {
          // Disable SW under proxied /portal path to avoid caching/interaction issues
          try {
            const path = (location && location.pathname) || '';
            if (path.startsWith('/portal')) return; // skip under Cloudflare proxy
          } catch (_) {}
          if ('serviceWorker' in navigator) {
            // Only register if sw.js exists
            fetch('sw.js', { method: 'HEAD' })
              .then(r => { if (r.ok) return navigator.serviceWorker.register('sw.js'); })
              .catch(() => {});
          }
        }

        randomInRange(min, max) { return Math.random() * (max - min) + min; }
        escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

        // Bottom Sheet Methods
        openSheet(title, content) {
          document.getElementById('sheetTitle').textContent = title;
          document.getElementById('sheetBody').innerHTML = content;
          document.getElementById('sheetBackdrop').classList.add('show');
          document.getElementById('sheet').classList.add('show');
          document.getElementById('sheet').setAttribute('aria-hidden', 'false');
        }

        closeSheet() {
          document.getElementById('sheetBackdrop').classList.remove('show');
          document.getElementById('sheet').classList.remove('show');
          document.getElementById('sheet').setAttribute('aria-hidden', 'true');
        }

        openDetailsSheet(transport) {
          const routes = window.MUMBAI_SCHEDULES?.routes?.filter(r => r.mode === transport) || [];
          const hash = `mode=${encodeURIComponent(transport)}`;
          history.replaceState(null, '', this.updateHashParam('sheet', hash));
          let content = `<h3>${transport.toUpperCase()} Routes & Schedules</h3>`;
          
          if (routes.length > 0) {
            content += `<p>Found ${routes.length} active routes for ${transport}:</p>`;
            content += '<div class="frequency-list">';
            routes.forEach(route => {
              const nextDeps = window.nextDepartures ? window.nextDepartures(route, 3) : [];
              const nextTimings = nextDeps.length ? 
                nextDeps.map(d => `${d.etaMin} min`).join(', ') : 
                'Schedule loading...';
              
              content += `
                <div class="frequency-item">
                  <div>
                    <strong>${route.name}</strong><br>
                    <span style="color: var(--text-secondary); font-size: 13px;">${route.from} → ${route.to}</span><br>
                    <span style="color: var(--text-muted); font-size: 11px;">Next: ${nextTimings}</span>
                  </div>
                  <div style="text-align: right; font-size: 12px; color: var(--text-muted);">
                    ${route.frequencies?.[0]?.headway || 'N/A'} min intervals
                  </div>
                </div>
              `;
            });
            content += '</div>';
          } else {
            content += '<p>Loading route information...</p>';
          }
          
          this.openSheet(`${transport.toUpperCase()} Information`, content);
        }

        openTicketsSheet() {
          const content = `
            <div class="tabs" role="tablist" aria-label="Ticketing">
              <div class="tab active" data-tab="metro" role="tab" aria-selected="true">Metro</div>
              <div class="tab" data-tab="train" role="tab" aria-selected="false">Train</div>
              <div class="tab" data-tab="bus" role="tab" aria-selected="false">Bus</div>
              <div class="tab" data-tab="upi" role="tab" aria-selected="false">UPI</div>
            </div>
            <div id="tickets-content" style="margin-top:12px">
              ${this.renderTicketsTab('metro')}
            </div>
          `;
          this.openSheet('Buy Tickets', content);
          this.bindTicketsTabs();
          history.replaceState(null, '', this.updateHashParam('sheet', 'tickets'));
        }

        renderTicketsTab(tab) {
          if (tab === 'metro') {
            return `
              <div class="frequency-item">
                <div>
                  <strong>Line 1 (Blue)</strong><br>
                  <span style="color:var(--text-secondary);font-size:13px">WhatsApp Ticketing</span>
                </div>
                <a href="https://wa.me/919670008889?text=hi" target="_blank" class="chip info">
                  <i class="fa-brands fa-whatsapp"></i> Book Now
                </a>
              </div>
              <ol>
                <li>Click "Book Now" or send 'hi' to <strong>9670008889</strong></li>
                <li>Select source & destination</li>
                <li>Pay online or share OTP for paper ticket</li>
                <li>Receive WhatsApp QR to travel</li>
              </ol>
              
              <div class="frequency-item">
                <div>
                  <strong>Lines 2A & 7 (Yellow)</strong><br>
                  <span style="color:var(--text-secondary);font-size:13px">WhatsApp Ticketing</span>
                </div>
                <a href="https://wa.me/918652635500?text=Hi" target="_blank" class="chip info">
                  <i class="fa-brands fa-whatsapp"></i> Book Now
                </a>
              </div>
              <ul>
                <li>Click "Book Now" or send 'Hi' to <strong>86526 35500</strong></li>
                <li>Pay via card/UPI</li>
                <li>Valid same business day; non-refundable</li>
              </ul>
              
              <div class="frequency-item">
                <div>
                  <strong>Line 3 (Aqua)</strong><br>
                  <span style="color:var(--text-secondary);font-size:13px">Official MMRCL Portal</span>
                </div>
                <a href="https://mmrcl.com/en/map" target="_blank" class="chip">
                  <i class="fa-solid fa-external-link-alt"></i> Portal
                </a>
              </div>
              <p>Book tickets via the official MMRCL portal for Aqua Line services.</p>
            `;
          }
          if (tab === 'train') {
            return `
              <div class="frequency-item">
                <div>
                  <strong>UTS on Mobile</strong><br>
                  <span style="color:var(--text-secondary);font-size:13px">Unreserved tickets & passes</span>
                </div>
                <div style="display:flex; gap:6px;">
                  <a href="https://www.utsonmobile.indianrail.gov.in/login?4" target="_blank" class="chip success" style="text-decoration:none;">
                    <i class="fa-solid fa-external-link-alt"></i> UTS Web
                  </a>
                  <div class="chip info">
                    <i class="fa-solid fa-mobile-screen"></i> UTS App
                  </div>
                </div>
              </div>
              <p>Download UTS app from Play Store/App Store or use the web portal for suburban train tickets and passes.</p>
            `;
          }
          if (tab === 'upi') {
            return `
              <div class="frequency-item">
                <div>
                  <strong>UPI Payment Options</strong><br>
                  <span style="color:var(--text-secondary);font-size:13px">Pay with UPI for all transport</span>
                </div>
              </div>
              <p>Use UPI apps to pay for tickets:</p>
              
              <div class="frequency-item">
                <div>
                  <strong>Paytm</strong><br>
                  <span style="color:var(--text-secondary);font-size:13px">Metro & Bus tickets</span>
                </div>
                <a href="https://paytm.com/metro" target="_blank" class="chip success">
                  <i class="fa-solid fa-mobile-screen"></i> Open App
                </a>
              </div>
              
              <div class="frequency-item">
                <div>
                  <strong>PhonePe</strong><br>
                  <span style="color:var(--text-secondary);font-size:13px">Metro & Bus tickets</span>
                </div>
                <a href="https://www.phonepe.com/travel-and-transit/" target="_blank" class="chip success">
                  <i class="fa-solid fa-mobile-screen"></i> Open App
                </a>
              </div>
              
              <div class="frequency-item">
                <div>
                  <strong>Google Pay</strong><br>
                  <span style="color:var(--text-secondary);font-size:13px">All transport modes</span>
                </div>
                <a href="https://pay.google.com/about/" target="_blank" class="chip success">
                  <i class="fa-solid fa-mobile-screen"></i> Open App
                </a>
              </div>
              
              <p style="font-size: 12px; color: var(--text-muted); margin-top: 16px;">
                <i class="fa-solid fa-info-circle"></i> Scan QR codes at ticket counters or use app deep links for instant payments.
              </p>
            `;
          }
          return `
            <div class="frequency-item">
              <div>
                <strong>BEST Bus</strong><br>
                <span style="color:var(--text-secondary);font-size:13px">Mobile app / card / cash</span>
              </div>
              <div class="chip"><i class="fa-solid fa-bus"></i> Citywide</div>
            </div>
            <p>Pay via BEST app, prepaid cards, or cash at boarding.</p>
            
            <div class="frequency-item">
              <div>
                <strong>Chalo App</strong><br>
                <span style="color:var(--text-secondary);font-size:13px">Live tracking & digital tickets</span>
              </div>
              <div style="display:flex; gap:6px;">
                <a href="https://chalo.com/" target="_blank" class="chip info" style="text-decoration:none;">
                  <i class="fa-solid fa-external-link-alt"></i> Chalo Web
                </a>
                <div class="chip success">
                  <i class="fa-solid fa-mobile-screen"></i> Chalo App
                </div>
              </div>
            </div>
            <p>India's #1 bus transport technology - track buses live, buy mobile tickets, and get digital bus passes. Available in 65+ cities including Mumbai.</p>
          `;
        }

        bindTicketsTabs() {
          const container = document.getElementById('sheetBody');
          container.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
              container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              container.querySelector('#tickets-content').innerHTML = this.renderTicketsTab(tab.dataset.tab);
              
              // Bind UPI tab specific functionality
              if (tab.dataset.tab === 'upi') {
                setTimeout(() => {
                  const quickTicketBtn = document.getElementById('quick-metro-ticket');
                  const viewTicketsBtn = document.getElementById('view-my-tickets');
                  
                  if (quickTicketBtn) {
                    quickTicketBtn.addEventListener('click', () => this.showQuickTicketBooking());
                  }
                  
                  if (viewTicketsBtn) {
                    viewTicketsBtn.addEventListener('click', () => this.showUserTickets());
                  }
                }, 100);
              }
            });
          });
        }

        showQuickTicketBooking() {
          const content = `
            <div style="padding: 20px;">
              <div style="text-align: center; margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 16px; background: linear-gradient(135deg, #5F259F, #8E44AD); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(95, 37, 159, 0.3);">
                  <i class="fa-solid fa-train" style="font-size: 32px; color: white;"></i>
                </div>
                <h3 style="margin: 0 0 8px 0; color: var(--primary); font-size: 20px; font-weight: 600;">Metro Line 1 Ticket</h3>
                <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">Versova ↔ Ghatkopar</p>
              </div>
              
                              <div style="background: linear-gradient(135deg, #f8f9ff, #ffffff); border: 2px solid #e1e8ff; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(95, 37, 159, 0.08);">
                  <div style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                      <div style="width: 32px; height: 32px; background: var(--primary-light); border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                        <i class="fa-solid fa-route" style="color: var(--primary); font-size: 14px;"></i>
                      </div>
                      <label style="font-size: 14px; color: var(--text-primary); font-weight: 500;">Route</label>
                    </div>
                    <select id="ticket-route" style="width: 100%; padding: 12px; border: 2px solid #e1e8ff; border-radius: 10px; background: white; font-size: 14px; color: var(--text-primary);">
                      <option value="M1">Metro Line 1 (Blue) - Versova ↔ Ghatkopar</option>
                    </select>
                    <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); border: 1px solid #ffeaa7; border-radius: 8px; padding: 8px; margin-top: 8px;">
                      <i class="fa-solid fa-info-circle" style="color: #856404; margin-right: 6px;"></i>
                      <span style="font-size: 12px; color: #856404; font-weight: 500;">PhonePe booking available for Metro Line 1</span>
                    </div>
                  </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                  <div>
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                      <div style="width: 24px; height: 24px; background: #e3f2fd; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 6px;">
                        <i class="fa-solid fa-map-marker-alt" style="color: #1976d2; font-size: 12px;"></i>
                      </div>
                      <label style="font-size: 13px; color: var(--text-primary); font-weight: 500;">From</label>
                    </div>
                    <select id="ticket-from" style="width: 100%; padding: 10px; border: 2px solid #e1e8ff; border-radius: 8px; background: white; font-size: 13px; color: var(--text-primary);">
                      <option value="">Select station</option>
                      <option value="Versova">Versova</option>
                      <option value="DN Nagar">DN Nagar</option>
                      <option value="Azad Nagar">Azad Nagar</option>
                      <option value="Andheri">Andheri</option>
                      <option value="Western Express Highway">Western Express Highway</option>
                      <option value="Chakala">Chakala</option>
                      <option value="Airport Road">Airport Road</option>
                      <option value="Marol Naka">Marol Naka</option>
                      <option value="Saki Naka">Saki Naka</option>
                      <option value="Asalpha">Asalpha</option>
                      <option value="Jagruti Nagar">Jagruti Nagar</option>
                      <option value="Ghatkopar">Ghatkopar</option>
                    </select>
                  </div>
                  <div>
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                      <div style="width: 24px; height: 24px; background: #f3e5f5; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 6px;">
                        <i class="fa-solid fa-map-marker" style="color: #7b1fa2; font-size: 12px;"></i>
                      </div>
                      <label style="font-size: 13px; color: var(--text-primary); font-weight: 500;">To</label>
                    </div>
                    <select id="ticket-to" style="width: 100%; padding: 10px; border: 2px solid #e1e8ff; border-radius: 8px; background: white; font-size: 13px; color: var(--text-primary);">
                      <option value="">Select station</option>
                      <option value="Versova">Versova</option>
                      <option value="DN Nagar">DN Nagar</option>
                      <option value="Azad Nagar">Azad Nagar</option>
                      <option value="Andheri">Andheri</option>
                      <option value="Western Express Highway">Western Express Highway</option>
                      <option value="Chakala">Chakala</option>
                      <option value="Airport Road">Airport Road</option>
                      <option value="Marol Naka">Marol Naka</option>
                      <option value="Saki Naka">Saki Naka</option>
                      <option value="Asalpha">Asalpha</option>
                      <option value="Jagruti Nagar">Jagruti Nagar</option>
                      <option value="Ghatkopar">Ghatkopar</option>
                    </select>
                  </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                  <div>
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                      <div style="width: 24px; height: 24px; background: #e8f5e8; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 6px;">
                        <i class="fa-solid fa-calendar" style="color: #2e7d32; font-size: 12px;"></i>
                      </div>
                      <label style="font-size: 13px; color: var(--text-primary); font-weight: 500;">Journey Date</label>
                    </div>
                    <input type="date" id="ticket-date" style="width: 100%; padding: 10px; border: 2px solid #e1e8ff; border-radius: 8px; background: white; font-size: 13px; color: var(--text-primary);" value="${new Date().toISOString().split('T')[0]}">
                  </div>
                  <div>
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                      <div style="width: 24px; height: 24px; background: #fff3e0; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 6px;">
                        <i class="fa-solid fa-users" style="color: #f57c00; font-size: 12px;"></i>
                      </div>
                      <label style="font-size: 13px; color: var(--text-primary); font-weight: 500;">Passengers</label>
                    </div>
                    <select id="ticket-passengers" style="width: 100%; padding: 10px; border: 2px solid #e1e8ff; border-radius: 8px; background: white; font-size: 13px; color: var(--text-primary);">
                      <option value="1">1 Adult</option>
                      <option value="2">2 Adults</option>
                      <option value="3">3 Adults</option>
                      <option value="4">4 Adults</option>
                    </select>
                  </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #5F259F, #8E44AD); border-radius: 16px; padding: 20px; text-align: center; position: relative; overflow: hidden; margin-bottom: 20px;">
                  <div style="position: absolute; top: -10px; right: -10px; width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                  <div style="position: absolute; bottom: -15px; left: -15px; width: 30px; height: 30px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>
                  
                  <div style="position: relative; z-index: 2;">
                    <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 6px; font-weight: 500;">Estimated Fare</div>
                    <div style="font-size: 32px; font-weight: 700; color: white; margin-bottom: 4px;" id="estimated-fare">₹45</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.8);">Base fare + taxes included</div>
                  </div>
                </div>
              </div>
              
              <button id="proceed-payment" class="btn" style="width: 100%; padding: 16px; font-size: 16px; background: linear-gradient(135deg, #5F259F, #8E44AD); border: none; border-radius: 16px; font-weight: 600; color: white; box-shadow: 0 8px 24px rgba(95, 37, 159, 0.3); transition: all 0.3s ease; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;"></div>
                <i class="fa-solid fa-credit-card" style="margin-right: 8px;"></i> Pay with PhonePe
              </button>
              
              <div style="background: linear-gradient(135deg, #f8f9ff, #e8f2ff); border: 1px solid #e1e8ff; border-radius: 12px; padding: 16px; margin-top: 16px; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                  <div style="width: 32px; height: 32px; background: rgba(95, 37, 159, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                    <i class="fa-solid fa-shield-halved" style="color: #5F259F; font-size: 14px;"></i>
                  </div>
                  <span style="font-size: 13px; color: #5F259F; font-weight: 600;">Secure Payment</span>
                </div>
                <div style="display: flex; justify-content: space-around; font-size: 11px; color: #5F259F;">
                  <span><i class="fa-solid fa-clock" style="margin-right: 4px;"></i> 2 hours validity</span>
                  <span><i class="fa-solid fa-qrcode" style="margin-right: 4px;"></i> Digital QR ticket</span>
                  <span><i class="fa-solid fa-mobile-screen" style="margin-right: 4px;"></i> Instant booking</span>
                </div>
              </div>
            </div>
          `;
          
          this.openSheet('Book Metro Line 1 Ticket', content);
          
          setTimeout(() => {
            const proceedBtn = document.getElementById('proceed-payment');
            const routeSelect = document.getElementById('ticket-route');
            const passengersSelect = document.getElementById('ticket-passengers');
            const fareDisplay = document.getElementById('estimated-fare');
            
            // Update fare when route or passengers change
            const updateFare = () => {
              const baseFare = 45; // Base metro fare
              const passengers = parseInt(passengersSelect.value);
              const totalFare = baseFare * passengers;
              fareDisplay.textContent = `₹${totalFare}`;
            };
            
            if (routeSelect) routeSelect.addEventListener('change', updateFare);
            if (passengersSelect) passengersSelect.addEventListener('change', updateFare);
            
            if (proceedBtn) {
              proceedBtn.addEventListener('click', () => {
                const ticketData = {
                  route: routeSelect.options[routeSelect.selectedIndex].text,
                  from: document.getElementById('ticket-from').value,
                  to: document.getElementById('ticket-to').value,
                  date: document.getElementById('ticket-date').value,
                  passengers: passengersSelect.value,
                  amount: parseInt(fareDisplay.textContent.replace('₹', ''))
                };
                
                if (!ticketData.from || !ticketData.to || ticketData.from === ticketData.to) {
                  this.showNotification('⚠️ Please select different stations');
                  return;
                }
                
                this.initPhonePePayment(ticketData);
              });
            }
          }, 100);
        }

        openJourneySheet() {
          const allRoutes = window.MUMBAI_SCHEDULES?.routes || [];
          const metroRoutes = allRoutes.filter(r => r.mode === 'metro').length;
          const trainRoutes = allRoutes.filter(r => r.mode === 'train').length;
          const busRoutes = allRoutes.filter(r => r.mode === 'bus').length;
          const ferryRoutes = allRoutes.filter(r => r.mode === 'ferry').length;
          
          const content = `
            <h3>🗺️ Plan Your Journey</h3>
            <p>Plan efficient routes across Mumbai's comprehensive transport network:</p>
            
            <div style="margin: 16px 0;">
              <h4 style="margin: 0 0 8px 0; color: var(--primary);">Available Transport Modes</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                <div class="frequency-item" style="margin: 0;">
                  <div><strong>🚇 Metro</strong><br><span style="color: var(--text-secondary); font-size: 12px;">${metroRoutes} active lines</span></div>
                  <div class="chip info">East-West</div>
                </div>
                <div class="frequency-item" style="margin: 0;">
                  <div><strong>🚊 Trains</strong><br><span style="color: var(--text-secondary); font-size: 12px;">${trainRoutes} major routes</span></div>
                  <div class="chip success">North-South</div>
                </div>
                <div class="frequency-item" style="margin: 0;">
                  <div><strong>🚌 Buses</strong><br><span style="color: var(--text-secondary); font-size: 12px;">${busRoutes} BEST routes</span></div>
                  <div class="chip">Citywide</div>
                </div>
                <div class="frequency-item" style="margin: 0;">
                  <div><strong>⛴️ Ferry</strong><br><span style="color: var(--text-secondary); font-size: 12px;">${ferryRoutes} routes</span></div>
                  <div class="chip warn">Coastal</div>
                </div>
              </div>
            </div>
            
            <h4 style="margin: 16px 0 8px 0; color: var(--primary);">Smart Travel Tips</h4>
            <ul style="margin: 0 0 16px 0; padding-left: 18px;">
              <li>Metro: Best for Versova-Ghatkopar (Line 1) and Dahisar-DN Nagar (Line 2A/7)</li>
              <li>Local Trains: Fastest for long-distance North-South travel</li>
              <li>BEST Buses: Last-mile connectivity and cross-city routes</li>
              <li>Ferry: Scenic route to Elephanta and coastal destinations</li>
              <li>Peak hours: 7-10 AM & 6-9 PM (expect delays)</li>
            </ul>
            
            <h4 style="margin: 16px 0 8px 0; color: var(--primary);">Major Interchange Hubs</h4>
            <ul style="margin: 0; padding-left: 18px;">
              <li><strong>Andheri:</strong> Metro Line 1 ↔ Western Railway ↔ Metro Line 7</li>
              <li><strong>Ghatkopar:</strong> Metro Line 1 ↔ Central Railway</li>
              <li><strong>Churchgate/CST:</strong> Major train terminuses + bus connectivity</li>
              <li><strong>Bandra:</strong> Western Railway ↔ Multiple bus routes</li>
            </ul>
            
            <div style="margin-top: 16px; padding: 12px; background: var(--primary-light); border-radius: 8px;">
              <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                💡 <strong>Pro Tip:</strong> Use the transport mode cards above to view detailed schedules and live timings for specific routes.
              </p>
            </div>
          `;
          this.openSheet('Plan Journey', content);
          history.replaceState(null, '', this.updateHashParam('sheet', 'journey'));
        }

        openNearbySheet() {
          const content = `
            <div style="margin-bottom: 16px;">
              <button id="get-location-btn" class="btn" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-weight: 600;">
                <i class="fa-solid fa-location-crosshairs" style="margin-right: 8px;"></i>Get My Location
              </button>
            </div>
            
            <div id="nearby-stations" class="nearby-stations" style="display: none;">
              <h4 style="margin-bottom: 12px; color: var(--text-primary);">Nearby Stations</h4>
              <div class="nearby-stations-list"></div>
            </div>
            
            <div id="location-status" style="text-align: center; color: var(--text-secondary); font-size: 14px;">
              <i class="fa-solid fa-info-circle" style="margin-right: 6px;"></i>
              Click "Get My Location" to find nearby transport stations
            </div>
          `;
          this.openSheet('Nearby Stations', content);
          this.bindNearbySheetEvents();
          history.replaceState(null, '', this.updateHashParam('sheet', 'nearby'));
        }

        bindNearbySheetEvents() {
          const locationBtn = document.getElementById('get-location-btn');
          const nearbyStations = document.getElementById('nearby-stations');
          const locationStatus = document.getElementById('location-status');
          
          locationBtn?.addEventListener('click', () => {
            locationBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin" style="margin-right: 8px;"></i>Getting Location...';
            locationBtn.disabled = true;
            
            this.findNearbyStations();
            
            // Show nearby stations after a short delay
            setTimeout(() => {
              nearbyStations.style.display = 'block';
              locationStatus.style.display = 'none';
              locationBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs" style="margin-right: 8px;"></i>Refresh Location';
              locationBtn.disabled = false;
            }, 2000);
          });
        }

        openRechargeSheet() {
          const content = `
            <div class="tabs" role="tablist" aria-label="Recharge">
              <div class="tab active" data-tab="metro" role="tab" aria-selected="true">Metro</div>
              <div class="tab" data-tab="train" role="tab" aria-selected="false">Train</div>
              <div class="tab" data-tab="bus" role="tab" aria-selected="false">Bus</div>
            </div>
            <div id="recharge-content" style="margin-top:12px">${this.renderRechargeTab('metro')}</div>
          `;
          this.openSheet('Recharge Cards', content);
          this.bindRechargeTabs();
          history.replaceState(null, '', this.updateHashParam('sheet', 'recharge'));
        }

        renderRechargeTab(tab) {
          if (tab === 'train') {
            return `
              <div class="frequency-item"><div><strong>Season Pass</strong><br><span style="color:var(--text-secondary);font-size:13px;">Monthly/Quarterly</span></div><div class="chip success">UTS app</div></div>
              <p>Recharge and manage passes via UTS app or counters.</p>
            `;
          }
          if (tab === 'bus') {
            return `
              <div class="frequency-item"><div><strong>BEST Prepaid</strong><br><span style="color:var(--text-secondary);font-size:13px;">Citywide</span></div><div class="chip">Retail/Online</div></div>
              <p>Recharge at depots, authorized centers, or through the BEST app.</p>
            `;
          }
          return `
            <div class="frequency-item"><div><strong>Metro Smart Cards</strong><br><span style="color:var(--text-secondary);font-size:13px;">Lines 1, 2A, 7</span></div><div class="chip info">App/Station</div></div>
            <p>Recharge at stations, authorized retailers, or the Mumbai Metro app.</p>
          `;
        }

        bindRechargeTabs() {
          const container = document.getElementById('sheetBody');
          container.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
              container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              container.querySelector('#recharge-content').innerHTML = this.renderRechargeTab(tab.dataset.tab);
            });
          });
        }

        openAccountSheet() {
          const content = `
            <h3>👤 Account & Settings</h3>
            
            <div class="frequency-item">
              <div>
                <strong>Theme Settings</strong><br>
                <span style="color: var(--text-secondary); font-size: 13px;">Light/Dark mode toggle</span>
              </div>
            </div>
            
            <div class="frequency-item">
              <div>
                <strong>Notifications</strong><br>
                <span style="color: var(--text-secondary); font-size: 13px;">Service alerts & updates</span>
              </div>
            </div>
            
            <div class="frequency-item">
              <div>
                <strong>Saved Routes</strong><br>
                <span style="color: var(--text-secondary); font-size: 13px;">Quick access to frequent routes</span>
              </div>
            </div>
            
            <div class="frequency-item">
              <div>
                <strong>Language</strong><br>
                <span style="color: var(--text-secondary); font-size: 13px;">English, हिंदी, मराठी</span>
              </div>
            </div>
            
            <p><strong>Data & Privacy:</strong></p>
            <ul>
              <li>Location data used only for nearby stations</li>
              <li>No personal data stored on servers</li>
              <li>All preferences saved locally</li>
            </ul>
          `;
          this.openSheet('Account & Settings', content);
          history.replaceState(null, '', this.updateHashParam('sheet', 'account'));
        }

        // PhonePe UPI Payment Integration with Atomicity
        async initPhonePePayment(ticketData) {
          const transactionId = 'TXN_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const transactionState = {
            status: 'INITIATED',
            transactionId,
            ticketData,
            timestamp: Date.now(),
            attempts: 0
          };
          
          const paymentPayload = {
            merchantId: window.PhonePeConfig.merchantId,
            merchantTransactionId: transactionId,
            merchantUserId: 'USER_' + Date.now(),
            amount: ticketData.amount * 100, // Amount in paisa
            redirectUrl: window.PhonePeConfig.redirectUrl,
            redirectMode: 'REDIRECT',
            callbackUrl: window.PhonePeConfig.callbackUrl,
            mobileNumber: ticketData.mobile || '',
            paymentInstrument: {
              type: 'UPI_INTENT',
              targetApp: 'com.phonepe.app'
            }
          };

          try {
            // Atomic Step 1: Store transaction state
            localStorage.setItem('pendingTransaction', JSON.stringify(transactionState));
            
            // Atomic Step 2: Validate transaction data
            if (!this.validateTransactionData(ticketData)) {
              throw new Error('Invalid transaction data');
            }
            
            // Atomic Step 3: Show payment modal
            await this.showPhonePePaymentModal(paymentPayload, ticketData);
            
          } catch (error) {
            console.error('PhonePe payment initialization error:', error);
            // Rollback: Clear pending transaction
            localStorage.removeItem('pendingTransaction');
            this.showNotification('❌ Payment initialization failed. Please try again.');
          }
        }

        validateTransactionData(ticketData) {
          return ticketData && 
                 ticketData.from && 
                 ticketData.to && 
                 ticketData.from !== ticketData.to &&
                 ticketData.amount > 0 &&
                 ticketData.date &&
                 ticketData.passengers > 0;
        }

        async showPhonePePaymentModal(payload, ticketData) {
          const content = `
            <div style="text-align: center; padding: 20px;">
              <div style="position: relative; margin-bottom: 24px;">
                <div style="width: 100px; height: 100px; margin: 0 auto; background: linear-gradient(135deg, #5F259F, #8E44AD); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 12px 32px rgba(95, 37, 159, 0.3); position: relative; overflow: hidden;">
                  <div style="position: absolute; top: -20px; right: -20px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                  <div style="position: absolute; bottom: -15px; left: -15px; width: 40px; height: 40px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>
                  <i class="fa-solid fa-mobile-screen" style="font-size: 36px; color: white; position: relative; z-index: 2;"></i>
                </div>
                <div style="position: absolute; top: -5px; right: 25%; width: 20px; height: 20px; background: #4CAF50; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
              </div>
              
              <h3 style="margin: 0 0 8px 0; color: var(--primary); font-size: 22px; font-weight: 600;">PhonePe Payment</h3>
              <p style="margin: 0 0 24px 0; color: var(--text-secondary); font-size: 15px;">Complete your payment securely with India's trusted UPI app</p>
              
              <div style="background: linear-gradient(135deg, #f8f9ff, #ffffff); border: 2px solid #e1e8ff; border-radius: 16px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 16px rgba(95, 37, 159, 0.1);">
                <div style="display: flex; align-items: center; margin-bottom: 16px;">
                  <div style="width: 40px; height: 40px; background: var(--primary-light); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                    <i class="fa-solid fa-receipt" style="color: var(--primary); font-size: 18px;"></i>
                  </div>
                  <h4 style="margin: 0; color: var(--primary); font-size: 16px; font-weight: 600;">Payment Summary</h4>
                </div>
                
                <div style="display: grid; gap: 12px; margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                    <span style="color: var(--text-secondary); font-size: 14px;">Route:</span>
                    <strong style="color: var(--text-primary); font-size: 14px;">${ticketData.route}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                    <span style="color: var(--text-secondary); font-size: 14px;">From:</span>
                    <strong style="color: var(--text-primary); font-size: 14px;">${ticketData.from}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                    <span style="color: var(--text-secondary); font-size: 14px;">To:</span>
                    <strong style="color: var(--text-primary); font-size: 14px;">${ticketData.to}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                    <span style="color: var(--text-secondary); font-size: 14px;">Journey Date:</span>
                    <strong style="color: var(--text-primary); font-size: 14px;">${ticketData.date}</strong>
                  </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #5F259F, #8E44AD); border-radius: 12px; padding: 16px; text-align: center; position: relative; overflow: hidden;">
                  <div style="position: absolute; top: -10px; right: -10px; width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                  <div style="position: absolute; bottom: -15px; left: -15px; width: 30px; height: 30px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>
                  
                  <div style="position: relative; z-index: 2;">
                    <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 4px;">Total Amount</div>
                    <div style="font-size: 28px; font-weight: 700; color: white;">₹${ticketData.amount}</div>
                  </div>
                </div>
              </div>
              
              <div style="margin: 24px 0;">
                <button id="phonepe-pay-btn" class="btn" style="width: 100%; padding: 16px; font-size: 16px; background: linear-gradient(135deg, #5F259F, #8E44AD); border: none; border-radius: 16px; font-weight: 600; color: white; box-shadow: 0 8px 24px rgba(95, 37, 159, 0.3); transition: all 0.3s ease; position: relative; overflow: hidden;">
                  <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;"></div>
                  <i class="fa-solid fa-mobile-screen" style="margin-right: 8px; font-size: 18px;"></i> Pay with PhonePe
                </button>
              </div>
              
              <div style="margin: 16px 0;">
                <button id="simulate-success-btn" class="btn btn-secondary" style="width: 100%; padding: 12px; font-size: 14px; border-radius: 12px; background: #f8f9fa; border: 1px solid #e9ecef; color: #6c757d;">
                  <i class="fa-solid fa-check" style="margin-right: 6px;"></i> Simulate Success (Demo)
                </button>
              </div>
              
              <div style="background: linear-gradient(135deg, #f8f9ff, #e8f2ff); border: 1px solid #e1e8ff; border-radius: 12px; padding: 16px; margin-top: 20px; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                  <div style="width: 32px; height: 32px; background: rgba(95, 37, 159, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                    <i class="fa-solid fa-shield-halved" style="color: #5F259F; font-size: 14px;"></i>
                  </div>
                  <span style="font-size: 13px; color: #5F259F; font-weight: 600;">Secure Payment</span>
                </div>
                <p style="font-size: 12px; color: #5F259F; margin: 0;">Powered by PhonePe - India's trusted UPI platform</p>
              </div>
            </div>
          `;

          this.openSheet('Complete Payment', content);

          // Bind payment button events
          setTimeout(() => {
            const payBtn = document.getElementById('phonepe-pay-btn');
            const simulateBtn = document.getElementById('simulate-success-btn');
            
            if (payBtn) {
              payBtn.addEventListener('click', () => this.processPhonePePayment(payload, ticketData));
            }
            
            if (simulateBtn) {
              simulateBtn.addEventListener('click', () => this.simulatePaymentSuccess(ticketData));
            }
          }, 100);
        }

        async processPhonePePayment(payload, ticketData) {
          // Show loading state
          const payBtn = document.getElementById('phonepe-pay-btn');
          if (payBtn) {
            payBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            payBtn.disabled = true;
          }

          try {
            // Atomic Step 1: Update transaction state
            const pendingTransaction = JSON.parse(localStorage.getItem('pendingTransaction') || '{}');
            pendingTransaction.status = 'PROCESSING';
            pendingTransaction.attempts++;
            localStorage.setItem('pendingTransaction', JSON.stringify(pendingTransaction));

            // Atomic Step 2: Validate transaction still exists
            if (!pendingTransaction.transactionId) {
              throw new Error('Transaction not found');
            }

            // Atomic Step 3: Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Atomic Step 4: Simulate opening PhonePe app or web interface
            const phonepeUrl = `phonepe://pay?pa=mumbaitransport@paytm&pn=Mumbai+Transport&tn=Metro+Ticket+${payload.merchantTransactionId}&am=${ticketData.amount}&cu=INR&mode=02`;
            
            // Try to open PhonePe app, fallback to web
            const opened = this.tryOpenApp(phonepeUrl);
            
            if (!opened) {
              // Fallback to web interface simulation
              await this.showPhonePeWebInterface(ticketData);
            } else {
              // Monitor for return from PhonePe app
              this.monitorPaymentReturn(payload.merchantTransactionId, ticketData);
            }
            
          } catch (error) {
            console.error('Payment processing error:', error);
            
            // Rollback: Reset transaction state
            const pendingTransaction = JSON.parse(localStorage.getItem('pendingTransaction') || '{}');
            pendingTransaction.status = 'FAILED';
            localStorage.setItem('pendingTransaction', JSON.stringify(pendingTransaction));
            
            this.showNotification('❌ Payment processing failed. Please try again.');
            
            if (payBtn) {
              payBtn.innerHTML = '<i class="fa-solid fa-mobile-screen"></i> Pay with PhonePe';
              payBtn.disabled = false;
            }
          }
        }

        tryOpenApp(url) {
          try {
            // Create a hidden iframe to attempt app opening
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);
            
            // Remove iframe after attempting to open
            setTimeout(() => {
              document.body.removeChild(iframe);
            }, 1000);
            
            return true;
          } catch (error) {
            console.log('App opening failed, falling back to web interface');
            return false;
          }
        }

        async showPhonePeWebInterface(ticketData) {
          const content = `
            <div style="text-align: center; padding: 20px;">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #5F259F, #8E44AD); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                <i class="fa-solid fa-qrcode" style="font-size: 32px; color: white;"></i>
              </div>
              
              <h3 style="margin: 0 0 10px 0; color: var(--primary);">Scan QR Code</h3>
              <p style="margin: 0 0 20px 0; color: var(--text-secondary);">Open PhonePe app and scan the QR code</p>
              
              <div style="background: white; border: 2px solid var(--border); border-radius: 12px; padding: 20px; margin: 20px 0; display: inline-block;">
                <div style="width: 150px; height: 150px; background: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><rect width=\"100\" height=\"100\" fill=\"%23000\"/><rect x=\"10\" y=\"10\" width=\"10\" height=\"10\" fill=\"%23fff\"/><rect x=\"30\" y=\"10\" width=\"10\" height=\"10\" fill=\"%23fff\"/><rect x=\"50\" y=\"10\" width=\"10\" height=\"10\" fill=\"%23fff\"/><rect x=\"70\" y=\"10\" width=\"10\" height=\"10\" fill=\"%23fff\"/></svg>') center/cover;"></div>
              </div>
              
              <p style="font-size: 14px; color: var(--text-secondary); margin: 16px 0;">
                Amount: <strong style="color: var(--primary);">₹${ticketData.amount}</strong>
              </p>
              
              <div style="margin: 20px 0;">
                <button id="payment-success-btn" class="btn btn-primary" style="width: 100%; padding: 12px;">
                  <i class="fa-solid fa-check"></i> Payment Completed
                </button>
              </div>
              
              <div style="margin: 16px 0;">
                <button id="payment-cancel-btn" class="btn btn-secondary" style="width: 100%; padding: 10px;">
                  <i class="fa-solid fa-times"></i> Cancel Payment
                </button>
              </div>
            </div>
          `;

          this.openSheet('PhonePe Payment', content);

          setTimeout(() => {
            const successBtn = document.getElementById('payment-success-btn');
            const cancelBtn = document.getElementById('payment-cancel-btn');
            
            if (successBtn) {
              successBtn.addEventListener('click', () => this.simulatePaymentSuccess(ticketData));
            }
            
            if (cancelBtn) {
              cancelBtn.addEventListener('click', () => {
                this.closeSheet();
                this.showNotification('❌ Payment cancelled by user');
              });
            }
          }, 100);
        }

        monitorPaymentReturn(transactionId, ticketData) {
          // Simulate monitoring payment status
          let checkCount = 0;
          const maxChecks = 30; // 30 seconds timeout
          
          const checkInterval = setInterval(async () => {
            checkCount++;
            
            // Simulate random success after some time (for demo)
            if (checkCount > 5 && Math.random() > 0.3) {
              clearInterval(checkInterval);
              await this.simulatePaymentSuccess(ticketData);
              return;
            }
            
            if (checkCount >= maxChecks) {
              clearInterval(checkInterval);
              this.showNotification('⏱️ Payment timeout. Please check your PhonePe app or try again.');
              this.closeSheet();
            }
          }, 1000);
        }

        async simulatePaymentSuccess(ticketData) {
          try {
            // Atomic Step 1: Validate pending transaction
            const pendingTransaction = JSON.parse(localStorage.getItem('pendingTransaction') || '{}');
            if (!pendingTransaction.transactionId) {
              throw new Error('No pending transaction found');
            }

            // Atomic Step 2: Generate ticket with transaction ID
            const ticket = {
              id: 'TKT_' + Date.now(),
              ...ticketData,
              status: 'CONFIRMED',
              paymentMethod: 'PhonePe UPI',
              transactionId: pendingTransaction.transactionId,
              qrCode: this.generateQRCode(),
              validUntil: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(), // 2 hours validity
              issuedAt: new Date().toISOString()
            };

            // Atomic Step 3: Save ticket to storage
            const savedTickets = JSON.parse(localStorage.getItem('userTickets') || '[]');
            savedTickets.unshift(ticket);
            localStorage.setItem('userTickets', JSON.stringify(savedTickets));

            // Atomic Step 4: Update transaction state to completed
            pendingTransaction.status = 'COMPLETED';
            pendingTransaction.ticketId = ticket.id;
            localStorage.setItem('pendingTransaction', JSON.stringify(pendingTransaction));

            // Atomic Step 5: Show success
            await this.showTicketSuccess(ticket);

            // Atomic Step 6: Clean up after successful completion
            setTimeout(() => {
              localStorage.removeItem('pendingTransaction');
            }, 5000); // Keep for 5 seconds for debugging

          } catch (error) {
            console.error('Payment success processing error:', error);
            
            // Rollback: Mark transaction as failed
            const pendingTransaction = JSON.parse(localStorage.getItem('pendingTransaction') || '{}');
            pendingTransaction.status = 'FAILED';
            pendingTransaction.error = error.message;
            localStorage.setItem('pendingTransaction', JSON.stringify(pendingTransaction));
            
            this.showNotification('❌ Ticket generation failed. Please contact support.');
          }
        }

        generateQRCode() {
          // Generate a simple QR-like code for demo
          return 'QR_' + Math.random().toString(36).substr(2, 12).toUpperCase();
        }

        // Transaction recovery mechanism for atomicity
        recoverPendingTransactions() {
          try {
            const pendingTransaction = JSON.parse(localStorage.getItem('pendingTransaction') || '{}');
            
            if (pendingTransaction.status === 'PROCESSING') {
              // Check if transaction is stale (older than 5 minutes)
              const isStale = Date.now() - pendingTransaction.timestamp > 5 * 60 * 1000;
              
              if (isStale) {
                // Rollback stale transaction
                pendingTransaction.status = 'FAILED';
                pendingTransaction.error = 'Transaction timeout';
                localStorage.setItem('pendingTransaction', JSON.stringify(pendingTransaction));
                
                console.log('Recovered stale transaction:', pendingTransaction.transactionId);
                this.showNotification('⚠️ Previous transaction timed out. Please try again.');
              } else {
                // Transaction still in progress, show status
                console.log('Transaction in progress:', pendingTransaction.transactionId);
              }
            }
          } catch (error) {
            console.error('Transaction recovery error:', error);
            // Clear corrupted transaction data
            localStorage.removeItem('pendingTransaction');
          }
        }

        async showTicketSuccess(ticket) {
          const content = `
            <div style="text-align: center; padding: 20px;">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fa-solid fa-check" style="font-size: 32px; color: white;"></i>
              </div>
              
              <h3 style="margin: 0 0 10px 0; color: var(--success);">Payment Successful!</h3>
              <p style="margin: 0 0 20px 0; color: var(--text-secondary);">Your ticket has been confirmed</p>
              
              <div style="background: var(--background); border: 2px solid var(--success); border-radius: 12px; padding: 16px; margin: 16px 0;">
                <div style="border-bottom: 1px dashed var(--border); padding-bottom: 12px; margin-bottom: 12px;">
                  <h4 style="margin: 0 0 8px 0; color: var(--primary);">Digital Ticket</h4>
                  <div style="font-family: monospace; font-size: 12px; color: var(--text-muted);">ID: ${ticket.id}</div>
                </div>
                
                <div style="text-align: left;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: var(--text-secondary);">Route:</span>
                    <strong>${ticket.route}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: var(--text-secondary);">From:</span>
                    <strong>${ticket.from}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: var(--text-secondary);">To:</span>
                    <strong>${ticket.to}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: var(--text-secondary);">Amount:</span>
                    <strong>₹${ticket.amount}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="color: var(--text-secondary);">Valid Until:</span>
                    <strong>${new Date(ticket.validUntil).toLocaleTimeString()}</strong>
                  </div>
                </div>
                
                <div style="border-top: 1px dashed var(--border); padding-top: 12px; margin-top: 12px; text-align: center;">
                  <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin: 8px 0;">
                    <div style="font-family: monospace; font-size: 24px; letter-spacing: 3px; color: var(--primary);">${ticket.qrCode}</div>
                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">Show this QR at gates</div>
                  </div>
                </div>
              </div>
              
              <div style="margin: 20px 0;">
                <button id="download-ticket-btn" class="btn btn-primary" style="width: 100%; padding: 12px; margin-bottom: 8px;">
                  <i class="fa-solid fa-download"></i> Save Ticket
                </button>
                <button id="view-tickets-btn" class="btn btn-secondary" style="width: 100%; padding: 10px;">
                  <i class="fa-solid fa-ticket"></i> View All Tickets
                </button>
              </div>
              
              <p style="font-size: 12px; color: var(--text-muted);">
                <i class="fa-solid fa-info-circle"></i> Valid for 2 hours from issue time
              </p>
            </div>
          `;

          this.openSheet('Ticket Confirmed', content);

          setTimeout(() => {
            const downloadBtn = document.getElementById('download-ticket-btn');
            const viewBtn = document.getElementById('view-tickets-btn');
            
            if (downloadBtn) {
              downloadBtn.addEventListener('click', () => {
                this.downloadTicket(ticket);
                this.showNotification('✅ Ticket saved to device');
              });
            }
            
            if (viewBtn) {
              viewBtn.addEventListener('click', () => {
                this.showUserTickets();
              });
            }
          }, 100);

          // Auto-close after 10 seconds
          setTimeout(() => {
            this.closeSheet();
            this.showNotification('🎫 Ticket saved! Access via Tickets tab');
          }, 10000);
        }

        downloadTicket(ticket) {
          const ticketData = JSON.stringify(ticket, null, 2);
          const blob = new Blob([ticketData], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ticket_${ticket.id}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        showUserTickets() {
          const tickets = JSON.parse(localStorage.getItem('userTickets') || '[]');
          
          if (tickets.length === 0) {
            const content = `
              <h3>🎫 Your Tickets</h3>
              <div style="text-align: center; padding: 40px 20px;">
                <i class="fa-solid fa-ticket" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px;"></i>
                <p style="color: var(--text-secondary);">No tickets found</p>
                <button class="btn btn-primary" onclick="hub.openTicketsSheet()">Buy Tickets</button>
              </div>
            `;
            this.openSheet('Your Tickets', content);
            return;
          }

          const ticketsList = tickets.map(ticket => {
            const isValid = new Date(ticket.validUntil) > new Date();
            const statusColor = isValid ? 'var(--success)' : 'var(--text-muted)';
            const statusIcon = isValid ? 'fa-check-circle' : 'fa-clock';
            
            return `
              <div class="frequency-item" style="margin-bottom: 12px;">
                <div>
                  <strong>${ticket.route}</strong><br>
                  <span style="color: var(--text-secondary); font-size: 13px;">${ticket.from} → ${ticket.to}</span><br>
                  <span style="color: ${statusColor}; font-size: 11px;">
                    <i class="fa-solid ${statusIcon}"></i> ${isValid ? 'Valid until ' + new Date(ticket.validUntil).toLocaleTimeString() : 'Expired'}
                  </span>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 14px; color: var(--primary); font-weight: 600;">₹${ticket.amount}</div>
                  <div style="font-size: 10px; color: var(--text-muted);">${ticket.id}</div>
                </div>
              </div>
            `;
          }).join('');

          const content = `
            <h3>🎫 Your Tickets</h3>
            <p>Manage your purchased tickets:</p>
            ${ticketsList}
            <div style="margin-top: 16px;">
              <button class="btn btn-primary" style="width: 100%;" onclick="hub.openTicketsSheet()">
                <i class="fa-solid fa-plus"></i> Buy More Tickets
              </button>
            </div>
          `;
          
          this.openSheet('Your Tickets', content);
        }

        // Deep link helpers
        updateHashParam(key, value) {
          const url = new URL(location.href);
          const hash = new URLSearchParams(url.hash.replace(/^#/, ''));
          hash.set(key, value);
          url.hash = hash.toString();
          return url.toString();
        }
        readHashParam(key) {
          const hash = new URLSearchParams((location.hash||'').replace(/^#/, ''));
          return hash.get(key);
        }

        // Auto Fare Estimator (Mumbai, Aug 2025)
        openFareEstimator() {
          const now = new Date();
          const night = now.getHours() < 5; // 00:00–05:00 night charge window
          const base = 26; // Minimum fare (covers first 1 km)
          const perKm = 17.14; // Each km after first, rounded to nearest rupee on total

          const content = `
            <div class="tabs" role="tablist" aria-label="Fare">
              <div class="tab active" data-tab="auto" role="tab" aria-selected="true">Auto</div>
              <div class="tab" data-tab="taxi" role="tab" aria-selected="false">Taxi</div>
            </div>
            <div id="fare-content" style="margin-top:12px">
              ${this.renderFareTab('auto', { base, perKm, night })}
            </div>
          `;
          this.openSheet('Fare Estimator', content);
          this.bindFareTabs({ base, perKm, night });
          this.setupFareCalc('auto', { base, perKm, night });
        }

        renderFareTab(tab, cfg) {
          const inputs = `
            <div style="display:grid;grid-template-columns:1fr;gap:10px;margin:10px 0;">
              <div>
                <label style="font-size:12px;color:var(--text-secondary)">Distance (km)</label>
                <input id="fare-km" type="number" min="0" step="0.1" value="5" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text-primary)" />
                <div style="font-size:11px;color:var(--text-muted);margin-top:6px;">Minimum fare ₹${Math.round(cfg.base)} covers first 1 km. Subsequent per km ₹${cfg.perKm}.</div>
              </div>
            </div>
            <div class="chip ${cfg.night ? 'warn' : 'success'}">${cfg.night ? 'Night +25% (00:00–05:00)' : 'Day rates'}</div>
          `;

          if (tab === 'taxi') {
            const tCfg = { base: cfg.night ? 40 : 35, perKm: cfg.night ? 28 : 26, perMin: 3, night: cfg.night };
            return `
              ${inputs}
              <div id="fare-output" style="margin-top:12px"></div>
              <div style="margin-top:12px;font-size:12px;color:var(--text-muted)">Estimates as of Aug 2025. Actual fares may vary by RTO updates, traffic, and operator.</div>
            `;
          }

          return `
            ${inputs}
            <div id="fare-output" style="margin-top:12px"></div>
            <div style="margin-top:12px;font-size:12px;color:var(--text-muted)">Estimates as of Aug 2025. Actual fares may vary by RTO updates, traffic, and operator.</div>
          `;
        }

        bindFareTabs(cfg) {
          const container = document.getElementById('sheetBody');
          container.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
              container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              container.querySelector('#fare-content').innerHTML = this.renderFareTab(tab.dataset.tab, cfg);
              if (tab.dataset.tab === 'taxi') {
                const tCfg = { base: cfg.night ? 40 : 35, perKm: cfg.night ? 28 : 26, perMin: 3, night: cfg.night };
                this.setupFareCalc('taxi', tCfg);
              } else {
                this.setupFareCalc('auto', cfg);
              }
            });
          });
        }

        setupFareCalc(mode, cfg) {
          const kmInput = document.getElementById('fare-km');
          const out = document.getElementById('fare-output');
          if (!kmInput || !out) return;
          const calc = () => {
            const km = Math.max(0, parseFloat(kmInput.value || '0'));
            let fare;
            if (mode === 'auto') {
              const extraKm = Math.max(0, km - 1);
              const dayFare = cfg.base + extraKm * cfg.perKm;
              fare = cfg.night ? Math.round(dayFare * 1.25) : Math.round(dayFare);
              out.innerHTML = `<div class="frequency-item"><div><strong>Estimated Auto Fare</strong><br><span style="color:var(--text-secondary);font-size:13px">${km.toFixed(1)} km</span></div><div class="chip">₹ ${fare}</div></div>`;
            } else {
              // Simple taxi estimate: base + perKm*km
              const dayFare = cfg.base + km * cfg.perKm; // ignoring perMin in simple UI
              fare = Math.round(dayFare);
              out.innerHTML = `<div class="frequency-item"><div><strong>Estimated Taxi Fare</strong><br><span style="color:var(--text-secondary);font-size:13px">${km.toFixed(1)} km</span></div><div class="chip">₹ ${fare}</div></div>`;
            }
          };
          kmInput.addEventListener('input', calc);
          calc();
        }
      }

      let transportHub;
      window.addEventListener('load', () => {
        transportHub = new MumbaiTransportHub();

        // Initial service update
        setTimeout(() => {
          transportHub.appData.updates.push({
            id: Date.now(),
            type: 'success',
            icon: 'fa-circle-check',
            text: 'Metro Line 1 running with 2-minute peak frequency',
            time: new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date()),
            isNew: true
          });
          transportHub.updateServiceUpdates();
        }, 2000);

        setInterval(() => {
          if (!document.hidden && Math.random() < 0.1) transportHub.updateUI();
        }, 30000);

        window.MumbaiTransport = transportHub;
        
        // Expose functions globally for embedded use
        window.openTicketsSheet = () => transportHub.openTicketsSheet();
        window.openDetailsSheet = (transport) => transportHub.openDetailsSheet(transport);
      });
    })();
  </script>
  <script data-cfasync="false">
  /* Static live overlay (Aug 2025) — single-file, no external JSON. */
  (function(){
    const SCHEDULES = {
      generatedAt: '2025-08-10T00:00:00+05:30',
      timezone: 'Asia/Kolkata',
      vehicleBounds: { latMin: 18.85, latMax: 19.35, lngMin: 72.75, lngMax: 73.10 },
      routes: [
        { mode:'metro', routeId:'M1', name:'Line 1 (Blue)', from:'Versova', to:'Ghatkopar',
          fromStop:{ id:'VERS', lat:19.1340, lng:72.8260 }, toStop:{ id:'GHAT', lat:19.0860, lng:72.9230 },
          frequencies:[
            { days:'weekday', start:'06:00', end:'10:30', headway:3, runtime:24 },
            { days:'weekday', start:'10:30', end:'17:00', headway:5, runtime:24 },
            { days:'weekday', start:'17:00', end:'21:30', headway:3, runtime:24 },
            { days:'weekday', start:'21:30', end:'23:15', headway:6, runtime:24 },
            { days:'weekend', start:'07:00', end:'23:00', headway:6, runtime:24 }
          ]
        },
        // Aqua Line (Line 3) partial operations (Aarey JVLR ↔ Acharya Atre Chowk)
        { mode:'metro', routeId:'M3', name:'Line 3 (Aqua) – Aarey JVLR ↔ Acharya Atre Chowk', from:'Aarey JVLR', to:'Acharya Atre Chowk',
          fromStop:{ id:'ARY', lat:19.1475, lng:72.8644 }, toStop:{ id:'AAC', lat:18.9775, lng:72.8325 },
          frequencies:[
            { days:'weekday', start:'06:30', end:'10:30', headway:7, runtime:32 },
            { days:'weekday', start:'10:30', end:'17:30', headway:8, runtime:32 },
            { days:'weekday', start:'17:30', end:'21:30', headway:7, runtime:32 },
            { days:'weekend', start:'07:00', end:'22:30', headway:8, runtime:32 }
          ]
        },
        { mode:'metro', routeId:'M2A', name:'Line 2A (Yellow)', from:'Dahisar E', to:'DN Nagar',
          fromStop:{ id:'DHS', lat:19.2560, lng:72.8625 }, toStop:{ id:'DNN', lat:19.1287, lng:72.8370 },
          frequencies:[
            { days:'weekday', start:'06:30', end:'10:30', headway:4, runtime:40 },
            { days:'weekday', start:'10:30', end:'17:00', headway:6, runtime:40 },
            { days:'weekday', start:'17:00', end:'21:30', headway:4, runtime:40 },
            { days:'weekday', start:'21:30', end:'23:00', headway:8, runtime:40 },
            { days:'weekend', start:'07:00', end:'23:00', headway:6, runtime:40 }
          ]
        },
        { mode:'metro', routeId:'M7', name:'Line 7 (Red)', from:'Andheri E', to:'Dahisar E',
          fromStop:{ id:'AND', lat:19.1130, lng:72.8697 }, toStop:{ id:'DHE', lat:19.2512, lng:72.8720 },
          frequencies:[
            { days:'weekday', start:'06:30', end:'10:30', headway:4, runtime:33 },
            { days:'weekday', start:'10:30', end:'17:00', headway:6, runtime:33 },
            { days:'weekday', start:'17:00', end:'21:30', headway:4, runtime:33 },
            { days:'weekday', start:'21:30', end:'23:00', headway:8, runtime:33 },
            { days:'weekend', start:'07:00', end:'23:00', headway:6, runtime:33 }
          ]
        },

        { mode:'train', routeId:'WR_FAST', name:'Western Fast (Borivali → Churchgate)', from:'Borivali', to:'Churchgate',
          fromStop:{ id:'BOR', lat:19.2307, lng:72.8567 }, toStop:{ id:'CHG', lat:18.9354, lng:72.8277 },
          frequencies:[
            { days:'weekday', start:'05:30', end:'09:45', headway:2, runtime:38 },
            { days:'weekday', start:'09:45', end:'17:30', headway:5, runtime:38 },
            { days:'weekday', start:'17:30', end:'21:30', headway:2, runtime:38 },
            { days:'weekday', start:'21:30', end:'00:15', headway:6, runtime:38 },
            { days:'weekend', start:'06:00', end:'23:30', headway:6, runtime:38 }
          ]
        },
        { mode:'train', routeId:'WR_SLOW', name:'Western Slow (Virar → Churchgate)', from:'Virar', to:'Churchgate',
          fromStop:{ id:'VIR', lat:19.4559, lng:72.8110 }, toStop:{ id:'CHG', lat:18.9354, lng:72.8277 },
          frequencies:[
            { days:'weekday', start:'05:15', end:'09:45', headway:3, runtime:75 },
            { days:'weekday', start:'09:45', end:'17:30', headway:6, runtime:75 },
            { days:'weekday', start:'17:30', end:'21:30', headway:3, runtime:75 },
            { days:'weekday', start:'21:30', end:'00:00', headway:8, runtime:75 },
            { days:'weekend', start:'06:00', end:'23:30', headway:8, runtime:75 }
          ]
        },
        { mode:'train', routeId:'CR_FAST', name:'Central Fast (Kalyan → CSMT)', from:'Kalyan', to:'CSMT',
          fromStop:{ id:'KLY', lat:19.2437, lng:73.1355 }, toStop:{ id:'CSM', lat:18.9402, lng:72.8356 },
          frequencies:[
            { days:'weekday', start:'05:30', end:'09:45', headway:3, runtime:45 },
            { days:'weekday', start:'09:45', end:'17:30', headway:6, runtime:45 },
            { days:'weekday', start:'17:30', end:'21:30', headway:3, runtime:45 },
            { days:'weekday', start:'21:30', end:'00:15', headway:8, runtime:45 },
            { days:'weekend', start:'06:00', end:'23:30', headway:8, runtime:45 }
          ]
        },
        { mode:'train', routeId:'HR', name:'Harbour (Panvel → CSMT)', from:'Panvel', to:'CSMT',
          fromStop:{ id:'PNV', lat:18.9894, lng:73.1175 }, toStop:{ id:'CSM', lat:18.9402, lng:72.8356 },
          frequencies:[
            { days:'weekday', start:'05:45', end:'10:00', headway:4, runtime:60 },
            { days:'weekday', start:'10:00', end:'17:30', headway:8, runtime:60 },
            { days:'weekday', start:'17:30', end:'21:30', headway:4, runtime:60 },
            { days:'weekday', start:'21:30', end:'23:15', headway:10, runtime:60 },
            { days:'weekend', start:'06:30', end:'23:00', headway:10, runtime:60 }
          ]
        },

        { mode:'ferry', routeId:'F1', name:'Gateway ↔ Elephanta', from:'Gateway of India', to:'Elephanta',
          fromStop:{ id:'GTW', lat:18.9218, lng:72.8347 }, toStop:{ id:'ELP', lat:18.9634, lng:72.9316 },
          frequencies:[ { days:'daily', start:'09:00', end:'17:00', headway:30, runtime:50 } ]
        },

        { mode:'bus', routeId:'A1E', name:'BEST A-1 Express', from:'Colaba', to:'Bandra',
          fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'BAN', lat:19.0596, lng:72.8295 },
          frequencies:[
            { days:'weekday', start:'07:00', end:'10:30', headway:10, runtime:55 },
            { days:'weekday', start:'17:00', end:'20:30', headway:10, runtime:55 }
          ]
        },
        { mode:'bus', routeId:'2L', name:'BEST 2Ltd (Mumbai Central → Bandra)', from:'Mumbai Central', to:'Bandra',
          fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'BAN', lat:19.0596, lng:72.8295 },
          frequencies:[
            { days:'weekday', start:'07:00', end:'10:30', headway:12, runtime:45 },
            { days:'weekday', start:'10:30', end:'17:00', headway:15, runtime:45 },
            { days:'weekday', start:'17:00', end:'20:30', headway:12, runtime:45 }
          ]
        },
        { mode:'bus', routeId:'37', name:'BEST 37 (Santacruz → Colaba)', from:'Santacruz', to:'Colaba',
          fromStop:{ id:'SAN', lat:19.0810, lng:72.8410 }, toStop:{ id:'COL', lat:18.9100, lng:72.8090 },
          frequencies:[ { days:'daily', start:'06:30', end:'22:00', headway:15, runtime:65 } ]
        },

        // Additional BEST routes (from published timetables)
        { mode:'bus', routeId:'234', name:'BEST 234 (Vesave/Yari Road ↔ Jogeshwari)', from:'Vesave/Yari Road', to:'Jogeshwari',
          fromStop:{ id:'VYR', lat:19.1274, lng:72.8050 }, toStop:{ id:'JOG', lat:19.1356, lng:72.8480 },
          frequencies:[
            { days:'daily', start:'06:00', end:'10:00', headway:10, runtime:35 },
            { days:'daily', start:'10:00', end:'17:00', headway:15, runtime:35 },
            { days:'daily', start:'17:00', end:'21:00', headway:10, runtime:35 },
            { days:'daily', start:'21:00', end:'22:30', headway:15, runtime:35 }
          ]
        },
        { mode:'bus', routeId:'78', name:'Bus 78 (Wagle Depot ↔ Bharat Gears)', from:'Wagle Depot', to:'Bharat Gears',
          fromStop:{ id:'WAG', lat:19.1969, lng:72.9611 }, toStop:{ id:'BGE', lat:19.1780, lng:72.9690 },
          frequencies:[
            { days:'daily', start:'05:45', end:'10:00', headway:30, runtime:60 },
            { days:'daily', start:'10:00', end:'17:00', headway:40, runtime:60 },
            { days:'daily', start:'17:00', end:'19:15', headway:30, runtime:60 }
          ]
        },
        { mode:'bus', routeId:'42', name:'BEST 42 (Sandhurst Road ↔ Kamla Nehru Park)', from:'Sandhurst Road', to:'Kamla Nehru Park',
          fromStop:{ id:'SDR', lat:18.9634, lng:72.8397 }, toStop:{ id:'KNP', lat:18.9533, lng:72.8050 },
          frequencies:[
            { days:'daily', start:'06:00', end:'22:00', headway:12, runtime:45 }
          ]
        },
        { mode:'bus', routeId:'164', name:'BEST 164 (Maharana Pratap Chowk ↔ Dharavi Depot)', from:'Maharana Pratap Chowk', to:'Dharavi Depot',
          fromStop:{ id:'MPC', lat:19.1735, lng:72.9477 }, toStop:{ id:'DHD', lat:19.0465, lng:72.8543 },
          frequencies:[
            { days:'daily', start:'06:00', end:'21:30', headway:26, runtime:65 }
          ]
        },
        { mode:'bus', routeId:'9', name:'BEST 9 (Antop Hill ↔ Colaba)', from:'Antop Hill', to:'Colaba',
          fromStop:{ id:'ATH', lat:19.0169, lng:72.8598 }, toStop:{ id:'COL', lat:18.9100, lng:72.8090 },
          frequencies:[
            { days:'daily', start:'06:30', end:'22:00', headway:30, runtime:70 }
          ]
        },
        { mode:'bus', routeId:'115', name:'Bus 115 (Lakshmi Park ↔ Mulund Stn W)', from:'Lakshmi Park', to:'Mulund Stn (W)',
          fromStop:{ id:'LKP', lat:19.1730, lng:72.9330 }, toStop:{ id:'MLW', lat:19.1736, lng:72.9425 },
          frequencies:[
            { days:'daily', start:'07:00', end:'12:00', headway:25, runtime:35 },
            { days:'daily', start:'12:00', end:'17:00', headway:35, runtime:35 },
            { days:'daily', start:'17:00', end:'22:00', headway:25, runtime:35 }
          ]
        }
      ]
    };

    // Expose schedules globally for the main class to use
    window.MUMBAI_SCHEDULES = SCHEDULES;

    const colors = { bus:'#5E6AD2', train:'#00B87A', metro:'#8B5CF6', ferry:'#0EA5E9', monorail:'#10B981' };
    const icons  = { bus:'fa-bus', train:'fa-train-subway', metro:'fa-train-tram', ferry:'fa-ship', monorail:'fa-train' };
    const toMinutes = (hhmm) => { const [h,m] = hhmm.split(':').map(Number); return h*60 + m; };
    const sinceMid  = (d=new Date()) => d.getHours()*60 + d.getMinutes();
    const dayType   = (d=new Date()) => ([0,6].includes(d.getDay()) ? 'weekend' : 'weekday');
    const peak      = (h) => (h>=7 && h<=10) || (h>=18 && h<=21);
    const jitter    = (now=new Date()) => peak(now.getHours()) ? (Math.random()<0.5?0:1) : 0;

    // Define and expose helper functions globally
    function nextDepartures(routeDef, count=6, now=new Date()) {
      const nowMin = sinceMid(now);
      const wins = (routeDef.frequencies||[]).filter(f => f.days==='daily' || f.days===dayType(now));
      const out = [];
      for (const w of wins) {
        const start = toMinutes(w.start), end = toMinutes(w.end), head = Math.max(1, Math.round(+w.headway));
        for (let t=start; t<=end; t+=head) { if (t >= nowMin) out.push({ departMin:t, runtime:Math.max(1, +w.runtime) }); if (out.length >= count*2) break; }
        if (out.length >= count*2) break;
      }
      if (out.length < count && wins.length) {
        const w=wins[0], start=toMinutes(w.start), head=Math.max(1, Math.round(+w.headway));
        for (let t=start; out.length<count; t+=head) out.push({ departMin:t+1440, runtime:Math.max(1,+w.runtime) });
      }
      return out.slice(0, count).map(d => ({ etaMin: Math.max(0, d.departMin - sinceMid(now)) + jitter(now), runtime: d.runtime }));
    }

    // Expose the function globally
    window.nextDepartures = nextDepartures;

    function clearFallbackMarkers() {
      const mapContent = document.getElementById('mapContent');
      if (mapContent) mapContent.querySelectorAll('.vehicle-marker').forEach(m => m.remove());
    }
    function appendFallbackMarker(lat, lng, color) {
      const b = SCHEDULES.vehicleBounds;
      const mapContent = document.getElementById('mapContent');
      if (!mapContent) return;
      const xPct = ((lng - b.lngMin) / (b.lngMax - b.lngMin)) * 90 + 5;
      const yPct = ((lat - b.latMin) / (b.latMax - b.latMin)) * 90 + 5;
      const marker = document.createElement('div');
      marker.className = 'vehicle-marker';
      marker.style.backgroundColor = color;
      marker.style.left = xPct + '%';
      marker.style.top = (100 - yPct) + '%';
      marker.setAttribute('data-route', '');
      mapContent.appendChild(marker);
    }

    function placeMarkersForRoute(hub, route, mode) {
      const wins = (route.frequencies||[]).filter(f => f.days==='daily' || f.days===dayType());
      if (!wins.length || !route.fromStop || !route.toStop) return;
      const runtime = Math.max(1, +wins[0].runtime);
      const head    = Math.max(1, Math.round(+wins[0].headway));
      const pool    = Math.max(2, Math.min(6, Math.ceil(runtime / Math.max(5, head))));
      const nowMin  = sinceMid(new Date());
      for (let i=0; i<pool; i++) {
        const offset = Math.min(runtime, Math.floor((i/(pool-1||1)) * runtime));
        const progress = Math.min(1, Math.max(0, offset / runtime));
        const lat = route.fromStop.lat + (route.toStop.lat - route.fromStop.lat) * progress;
        const lng = route.fromStop.lng + (route.toStop.lng - route.fromStop.lng) * progress;
        if (hub.map && !hub.mapFallbackMode && window.L) {
          const id = `${route.routeId}_${nowMin - offset}`;
          let marker = hub.appData.leafletMarkers?.get ? hub.appData.leafletMarkers.get(id) : null;
          if (!marker) {
            marker = L.circleMarker([lat, lng], { radius:5, color:'#fff', weight:1.5, fillColor:colors[mode], fillOpacity:1 })
                      .bindTooltip(`${route.name}`, { direction:'top', offset:[0,-4] })
                      .addTo(hub.map);
            hub.appData.leafletMarkers?.set && hub.appData.leafletMarkers.set(id, marker);
          } else {
            marker.setLatLng([lat, lng]);
          }
        } else {
          appendFallbackMarker(lat, lng, colors[mode]);
        }
      }
    }

    function tryInit() {
      const hub = window.MumbaiTransport;
      if (!hub) return false;
      if (!hub.updateSchedulesSimulated) hub.updateSchedulesSimulated = hub.updateSchedules.bind(hub);
      if (!hub.updateVehiclePositionsSimulated) hub.updateVehiclePositionsSimulated = hub.updateVehiclePositions.bind(hub);

      hub.updateSchedules = function() {
        const scheduleList = document.getElementById('scheduleList');
        const mode = this.appData.selectedTransport;
        const routes = (SCHEDULES.routes||[]).filter(r => r.mode === mode).slice(0, 6);
        if (!routes.length) return this.updateSchedulesSimulated();
        scheduleList.innerHTML = '';
        routes.forEach(route => {
          const n = nextDepartures(route, 1)[0];
          const total = n ? n.etaMin : '—';
          const delayText = (n && n.etaMin>0 && n.etaMin%11===0) ? ' (+1 min delay)' : '';
          const item = document.createElement('div');
          item.className = 'schedule-item';
          item.innerHTML = `
            <div class="schedule-icon" style="background:${colors[mode]}"><i class="fa-solid ${icons[mode]}"></i></div>
            <div class="schedule-content">
              <div class="schedule-route">${route.name} • ${route.from} → ${route.to}</div>
              <div class="schedule-time">Next: ${total} min${delayText}</div>
            </div>`;
          scheduleList.appendChild(item);
        });
      };

      hub.updateVehiclePositions = function() {
        const mode = this.appData.selectedTransport;
        const routes = (SCHEDULES.routes||[]).filter(r => r.mode === mode).slice(0, 6);
        if (!routes.length) return this.updateVehiclePositionsSimulated();
        if (!this.map || this.mapFallbackMode || !window.L) clearFallbackMarkers();
        if (this.appData?.leafletMarkers && this.appData.leafletMarkers.size > 240 && this.map) {
          this.appData.leafletMarkers.forEach((m, id) => { m.remove(); this.appData.leafletMarkers.delete(id); });
        }
        routes.forEach(route => placeMarkersForRoute(this, route, mode));
      };

      if (hub.timers) Object.values(hub.timers).forEach(t => t && clearInterval(t));
      hub.timers = hub.timers || {};
      hub.timers.vehicles  = setInterval(() => hub.updateVehiclePositions(), 3000);
      hub.timers.schedules = setInterval(() => hub.updateSchedules(), 15000);

      hub.updateSchedules();
      hub.updateVehiclePositions();
      return true;
    }

    if (!tryInit()) {
      const iv = setInterval(() => { if (tryInit()) clearInterval(iv); }, 300);
      setTimeout(() => clearInterval(iv), 12000);
    }
    })();
  </script>

  <!-- Google Maps Integration for accurate journey calculations -->
  <script>
    if (!tryInit()) {
      const iv = setInterval(() => { if (tryInit()) clearInterval(iv); }, 300);
      setTimeout(() => clearInterval(iv), 12000);
    }

    // Google Maps Integration for accurate journey calculations
    window.googleMapsReady = false;
    window.googleMapsAPI = null;

    function initGoogleMaps() {
      window.googleMapsReady = true;
      window.googleMapsAPI = google;
      console.log('Google Maps API loaded successfully');
    }

    // Accurate journey calculation using Google Maps Directions API
    function calculateJourney(origin, destination, mode = 'transit') {
      return new Promise((resolve, reject) => {
        if (!window.googleMapsReady || !window.googleMapsAPI) {
          reject(new Error('Google Maps API not loaded'));
          return;
        }

        const directionsService = new google.maps.DirectionsService();
        const request = {
          origin: origin,
          destination: destination,
          travelMode: google.maps.TravelMode[mode.toUpperCase()],
          transitOptions: {
            modes: [google.maps.TransitMode.BUS, google.maps.TransitMode.TRAIN, google.maps.TransitMode.SUBWAY],
            routingPreference: google.maps.TransitRoutePreference.FEWER_TRANSFERS
          },
          drivingOptions: {
            departureTime: new Date(),
            trafficModel: google.maps.TrafficModel.BEST_GUESS
          }
        };

        directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            const route = result.routes[0];
            const leg = route.legs[0];
            
            const journey = {
              distance: leg.distance.text,
              duration: leg.duration.text,
              durationValue: leg.duration.value,
              steps: leg.steps.map(step => ({
                instruction: step.instructions,
                distance: step.distance.text,
                duration: step.duration.text,
                travelMode: step.travel_mode,
                transitDetails: step.transit_details ? {
                  line: step.transit_details.line.name,
                  departure: step.transit_details.departure_stop.name,
                  arrival: step.transit_details.arrival_stop.name,
                  headsign: step.transit_details.headsign,
                  vehicle: step.transit_details.line.vehicle.type
                } : null
              })),
              fare: route.fare ? route.fare.text : null,
              warnings: route.warnings || []
            };
            
            resolve(journey);
          } else {
            reject(new Error(`Directions request failed: ${status}`));
          }
        });
      });
    }

    // Get accurate travel time between two points
    function getTravelTime(origin, destination, mode = 'transit') {
      return calculateJourney(origin, destination, mode)
        .then(journey => ({
          duration: journey.duration,
          durationValue: journey.durationValue,
          distance: journey.distance,
          steps: journey.steps.length
        }))
        .catch(error => {
          console.warn('Google Maps calculation failed:', error);
          // Fallback to estimated calculation
          return getEstimatedTravelTime(origin, destination, mode);
        });
    }

    // Fallback estimation when Google Maps is unavailable
    function getEstimatedTravelTime(origin, destination, mode) {
      // Simple distance-based estimation
      const originCoords = getCoordinatesFromAddress(origin);
      const destCoords = getCoordinatesFromAddress(destination);
      
      if (!originCoords || !destCoords) {
        return { duration: 'Unknown', durationValue: 0, distance: 'Unknown', steps: 0 };
      }

      const distance = google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(originCoords.lat, originCoords.lng),
        new google.maps.LatLng(destCoords.lat, destCoords.lng)
      );

      let durationMinutes;
      switch (mode) {
        case 'transit':
          durationMinutes = Math.max(10, distance / 500); // 500m per minute for transit
          break;
        case 'driving':
          durationMinutes = Math.max(5, distance / 1000); // 1km per minute for driving
          break;
        case 'walking':
          durationMinutes = Math.max(5, distance / 80); // 80m per minute for walking
          break;
        default:
          durationMinutes = Math.max(10, distance / 500);
      }

      return {
        duration: `${Math.round(durationMinutes)} min`,
        durationValue: durationMinutes * 60,
        distance: `${Math.round(distance / 1000 * 10) / 10} km`,
        steps: Math.ceil(durationMinutes / 15)
      };
    }

    // Get coordinates from address (simplified)
    function getCoordinatesFromAddress(address) {
      // Mumbai area coordinates for common locations
      const mumbaiLocations = {
        'colaba': { lat: 18.9100, lng: 72.8090 },
        'bandra': { lat: 19.0596, lng: 72.8295 },
        'andheri': { lat: 19.1197, lng: 72.8464 },
        'borivali': { lat: 19.2324, lng: 72.8565 },
        'dahisar': { lat: 19.2487, lng: 72.8609 },
        'mira road': { lat: 19.2875, lng: 72.8682 },
        'bhayandar': { lat: 19.3012, lng: 72.8745 },
        'vasai': { lat: 19.4089, lng: 72.8090 },
        'virar': { lat: 19.4558, lng: 72.8090 },
        'mumbai central': { lat: 18.9719, lng: 72.8194 },
        'cst': { lat: 18.9398, lng: 72.8354 },
        'churchgate': { lat: 18.9349, lng: 72.8248 },
        'santacruz': { lat: 19.0810, lng: 72.8410 },
        'kurla': { lat: 19.0669, lng: 72.8830 },
        'thane': { lat: 19.2183, lng: 72.9781 },
        'kalyan': { lat: 19.2433, lng: 73.1355 },
        'panvel': { lat: 18.9881, lng: 73.1103 },
        'vashi': { lat: 19.0802, lng: 72.9984 }
      };

      const searchTerm = address.toLowerCase();
      for (const [key, coords] of Object.entries(mumbaiLocations)) {
        if (searchTerm.includes(key)) {
          return coords;
        }
      }
      return null;
    }

    // Enhanced journey planning with Google Maps
    function planJourneyWithGoogleMaps(origin, destination) {
      return Promise.all([
        calculateJourney(origin, destination, 'transit'),
        calculateJourney(origin, destination, 'driving'),
        calculateJourney(origin, destination, 'walking')
      ]).then(([transit, driving, walking]) => {
        return {
          transit,
          driving,
          walking,
          recommendations: getJourneyRecommendations(transit, driving, walking)
        };
      }).catch(error => {
        console.error('Journey planning failed:', error);
        return getFallbackJourneyPlan(origin, destination);
      });
    }

    function getJourneyRecommendations(transit, driving, walking) {
      const recommendations = [];
      
      if (transit.durationValue < driving.durationValue) {
        recommendations.push({
          type: 'transit',
          reason: 'Public transport is faster',
          time: transit.duration,
          cost: transit.fare || '₹20-50'
        });
      }
      
      if (walking.durationValue < 1800) { // Less than 30 minutes
        recommendations.push({
          type: 'walking',
          reason: 'Walking is healthy and eco-friendly',
          time: walking.duration,
          cost: 'Free'
        });
      }
      
      if (driving.durationValue < transit.durationValue) {
        recommendations.push({
          type: 'driving',
          reason: 'Driving is faster for this route',
          time: driving.duration,
          cost: 'Fuel + Parking'
        });
      }
      
      return recommendations;
    }

    function getFallbackJourneyPlan(origin, destination) {
      // Fallback when Google Maps is unavailable
      return {
        transit: getEstimatedTravelTime(origin, destination, 'transit'),
        driving: getEstimatedTravelTime(origin, destination, 'driving'),
        walking: getEstimatedTravelTime(origin, destination, 'walking'),
        recommendations: [
          {
            type: 'transit',
            reason: 'Recommended for Mumbai traffic',
            time: '30-60 min',
            cost: '₹20-50'
          }
        ]
      };
    }

    // Expose functions globally
    window.calculateJourney = calculateJourney;
    window.getTravelTime = getTravelTime;
    window.planJourneyWithGoogleMaps = planJourneyWithGoogleMaps;
    })();
  </script>
</body>
</html>

