<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mumbai Transport Navigator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mumbai Transport">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4VXgebBaqOojiujAPYIP8Qv-iYPSFVWw&libraries=places"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Install Prompt */
        .install-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .install-prompt.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .install-prompt .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* Main Container */
        .container {
            max-width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        /* Quick Actions */
        .quick-actions {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .quick-action {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .quick-action:active {
            transform: scale(0.95);
        }

        .quick-action i {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .quick-action h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }

        .quick-action p {
            font-size: 12px;
            color: #666;
        }

        /* Route Planning Section */
        .route-section {
            background: rgba(255,255,255,0.95);
            margin: 0 20px 20px;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Results */
        .results {
            margin: 0 20px 20px;
            display: none;
        }

        .route-option {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .route-option.recommended {
            border: 2px solid #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .route-number {
            font-weight: 600;
            font-size: 18px;
            color: #333;
        }

        .route-modes {
            font-size: 24px;
        }

        .recommended-badge {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .route-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 14px;
        }

        .stat i {
            color: #667eea;
        }

        /* Map Container */
        .map-container {
            height: 300px;
            margin: 0 20px 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Popular Routes */
        .popular-routes {
            margin: 0 20px 20px;
        }

        .route-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .route-card:active {
            transform: scale(0.98);
        }

        .route-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .route-card p {
            color: #666;
            font-size: 14px;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item span {
            font-size: 12px;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 400px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <!-- Install Prompt -->
    <div class="install-prompt" id="install-prompt">
        <div>
            <strong>Add to Home Screen</strong>
            <br>
            <small>Quick access to Mumbai Transport</small>
        </div>
        <button class="close-btn" onclick="hideInstallPrompt()">Ã—</button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-bus"></i> Mumbai Transport</h1>
            <p>Quick Navigation & Live Tracking</p>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action" onclick="quickRoute('home', 'work')">
                <i class="fas fa-home"></i>
                <h3>Home â†’ Work</h3>
                <p>Quick route</p>
            </div>
            <div class="quick-action" onclick="quickRoute('current', 'airport')">
                <i class="fas fa-plane"></i>
                <h3>To Airport</h3>
                <p>Mumbai Airport</p>
            </div>
            <div class="quick-action" onclick="quickRoute('current', 'station')">
                <i class="fas fa-train"></i>
                <h3>Nearest Station</h3>
                <p>Find station</p>
            </div>
            <div class="quick-action" onclick="showPopularRoutes()">
                <i class="fas fa-star"></i>
                <h3>Popular Routes</h3>
                <p>Saved routes</p>
            </div>
        </div>

        <!-- Route Planning -->
        <div class="route-section">
            <h2 class="section-title">
                <i class="fas fa-route"></i>
                Plan Your Route
            </h2>
            
            <div class="form-group">
                <input type="text" id="from-location" class="form-input" placeholder="From where?">
            </div>
            
            <div class="form-group">
                <input type="text" id="to-location" class="form-input" placeholder="To where?">
            </div>
            
            <button class="btn btn-primary" id="plan-route-btn" onclick="planRoute()">
                <i class="fas fa-search"></i> Find Route
            </button>
        </div>

        <!-- Results -->
        <div class="results" id="results">
            <h2 class="section-title">
                <i class="fas fa-list"></i>
                Route Options
            </h2>
            <div id="route-results"></div>
        </div>

        <!-- Map -->
        <div class="map-container" id="map-container">
            <div id="map"></div>
        </div>

        <!-- Popular Routes -->
        <div class="popular-routes" id="popular-routes" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-star"></i>
                Popular Routes
            </h2>
            <div class="route-card" onclick="selectPopularRoute('Colaba', 'Bandra')">
                <h3>ðŸšŒ Route 139</h3>
                <p>Colaba â†’ Bandra â€¢ 75 min â€¢ â‚¹20</p>
            </div>
            <div class="route-card" onclick="selectPopularRoute('Andheri', 'CST')">
                <h3>ðŸš† Western Line</h3>
                <p>Andheri â†’ CST â€¢ 45 min â€¢ â‚¹15</p>
            </div>
            <div class="route-card" onclick="selectPopularRoute('Bandra', 'Airport')">
                <h3>ðŸšŒ Route 78</h3>
                <p>Bandra â†’ Airport â€¢ 30 min â€¢ â‚¹25</p>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showSection('home')">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="showSection('routes')">
            <i class="fas fa-route"></i>
            <span>Routes</span>
        </div>
        <div class="nav-item" onclick="showSection('tracking')">
            <i class="fas fa-satellite-dish"></i>
            <span>Track</span>
        </div>
        <div class="nav-item" onclick="showSection('favorites')">
            <i class="fas fa-heart"></i>
            <span>Favorites</span>
        </div>
    </div>

    <script>
        // PWA Variables
        let deferredPrompt;
        let map;
        let directionsService;
        let directionsRenderer;
        let autocompleteFrom;
        let autocompleteTo;

        // Mumbai Transport Data
        const MUMBAI_ROUTES = {
            '139': { name: 'BEST Route 139', from: 'Colaba', to: 'Bandra', duration: '75 min', fare: 'â‚¹20' },
            '78': { name: 'BEST Route 78', from: 'Worli', to: 'Andheri', duration: '60 min', fare: 'â‚¹18' },
            '41': { name: 'BEST Route 41', from: 'Ayyappa Mandir', to: 'Thane Station', duration: '45 min', fare: 'â‚¹15' }
        };

        // Initialize PWA
        window.addEventListener('load', () => {
            initPWA();
            initMap();
            setupEventListeners();
            // checkInstallPrompt(); // This is now handled by handleURLShortcuts
        });

        // PWA Functions
        function initPWA() {
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('SW registered successfully');
                        // Request notification permission
                        if ('Notification' in window) {
                            Notification.requestPermission();
                        }
                    })
                    .catch(error => console.log('SW registration failed:', error));
            }

            // Handle beforeinstallprompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('Install prompt ready');
                // Show install prompt after user interaction
                setTimeout(() => {
                    if (!localStorage.getItem('install-dismissed')) {
                        showInstallPrompt();
                    }
                }, 3000);
            });

            // Handle app installed
            window.addEventListener('appinstalled', () => {
                console.log('App installed successfully');
                hideInstallPrompt();
                showInstallSuccess();
            });

            // Handle URL shortcuts
            handleURLShortcuts();
        }

        function showInstallPrompt() {
            const prompt = document.getElementById('install-prompt');
            prompt.classList.add('show');
            
            // Add install button functionality
            const installBtn = document.createElement('button');
            installBtn.textContent = 'Install';
            installBtn.style.cssText = `
                background: #667eea;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 20px;
                margin-left: 10px;
                cursor: pointer;
                font-weight: 600;
            `;
            installBtn.onclick = installApp;
            
            prompt.querySelector('div').appendChild(installBtn);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        }

        function showInstallSuccess() {
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10001;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            `;
            successMsg.innerHTML = 'âœ… App installed successfully!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }

        function handleURLShortcuts() {
            const urlParams = new URLSearchParams(window.location.search);
            const shortcut = urlParams.get('shortcut');
            
            if (shortcut) {
                switch(shortcut) {
                    case 'home-work':
                        quickRoute('home', 'work');
                        break;
                    case 'airport':
                        quickRoute('current', 'airport');
                        break;
                    case 'station':
                        quickRoute('current', 'station');
                        break;
                }
            }
        }

        // Map Functions
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 19.0760, lng: 72.8777 },
                zoom: 12,
                mapTypeControl: false,
                streetViewControl: false
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true
            });

            // Initialize autocomplete
            autocompleteFrom = new google.maps.places.Autocomplete(
                document.getElementById('from-location'),
                { bounds: new google.maps.LatLngBounds(
                    new google.maps.LatLng(18.8964, 72.7962),
                    new google.maps.LatLng(19.2189, 72.9780)
                )}
            );

            autocompleteTo = new google.maps.places.Autocomplete(
                document.getElementById('to-location'),
                { bounds: new google.maps.LatLngBounds(
                    new google.maps.LatLng(18.8964, 72.7962),
                    new google.maps.LatLng(19.2189, 72.9780)
                )}
            );
        }

        function setupEventListeners() {
            // Add touch feedback
            document.querySelectorAll('.quick-action, .route-card, .btn').forEach(element => {
                element.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                element.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        }

        // Route Planning Functions
        function planRoute() {
            const from = document.getElementById('from-location').value;
            const to = document.getElementById('to-location').value;

            if (!from || !to) {
                showToast('Please enter both locations', 'error');
                return;
            }

            // Show loading
            const btn = document.getElementById('plan-route-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Finding...';
            btn.disabled = true;

            // Check if offline
            if (!navigator.onLine) {
                showOfflineRoute(from, to);
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            // Get route using Google Directions API
            directionsService.route({
                origin: from,
                destination: to,
                travelMode: google.maps.TravelMode.TRANSIT,
                provideRouteAlternatives: true
            }, (response, status) => {
                btn.innerHTML = originalText;
                btn.disabled = false;

                if (status === 'OK') {
                    displayRouteResults(response.routes, from, to);
                    showRouteOnMap(response.routes[0]);
                    saveRouteToHistory(from, to, response.routes[0]);
                } else {
                    showToast('Could not find route. Try different locations.', 'error');
                }
            });
        }

        function displayRouteResults(routes, from, to) {
            const resultsDiv = document.getElementById('results');
            const resultsContainer = document.getElementById('route-results');
            
            resultsDiv.style.display = 'block';
            
            let html = '';
            
            routes.forEach((route, index) => {
                const isRecommended = index === 0;
                const leg = route.legs[0];
                
                html += `
                    <div class="route-option ${isRecommended ? 'recommended' : ''}" onclick="selectRoute(${index})">
                        <div class="route-header">
                            <div class="route-info">
                                <span class="route-number">Route ${index + 1}</span>
                                <span class="route-modes">ðŸšŒ</span>
                            </div>
                            ${isRecommended ? '<span class="recommended-badge">Best</span>' : ''}
                        </div>
                        <div class="route-stats">
                            <span class="stat">
                                <i class="fas fa-clock"></i> ${leg.duration.text}
                            </span>
                            <span class="stat">
                                <i class="fas fa-road"></i> ${leg.distance.text}
                            </span>
                            <span class="stat">
                                <i class="fas fa-exchange-alt"></i> ${route.legs[0].steps.filter(step => step.travel_mode === 'TRANSIT').length} transfers
                            </span>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function showRouteOnMap(route) {
            const mapContainer = document.getElementById('map-container');
            mapContainer.style.display = 'block';
            
            directionsRenderer.setDirections({
                routes: [route],
                request: {
                    origin: route.legs[0].start_address,
                    destination: route.legs[0].end_address,
                    travelMode: google.maps.TravelMode.TRANSIT
                }
            });

            // Scroll to map
            mapContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Enhanced Quick Actions with better UX
        function quickRoute(from, to) {
            // Show loading state
            const loadingOverlay = document.createElement('div');
            loadingOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            loadingOverlay.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div class="loading"></div>
                    <p style="margin-top: 10px;">Finding best route...</p>
                </div>
            `;
            document.body.appendChild(loadingOverlay);

            if (from === 'current') {
                getCurrentLocation().then(location => {
                    document.getElementById('from-location').value = 'Current Location';
                    document.getElementById('to-location').value = to === 'airport' ? 'Mumbai Airport' : 'Nearest Station';
                    planRoute();
                    loadingOverlay.remove();
                });
            } else {
                document.getElementById('from-location').value = from === 'home' ? 'Home' : 'Current Location';
                document.getElementById('to-location').value = to === 'work' ? 'Work' : 'Airport';
                planRoute();
                loadingOverlay.remove();
            }
        }

        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            resolve(`${latitude}, ${longitude}`);
                        },
                        error => {
                            resolve('Current Location');
                        }
                    );
                } else {
                    resolve('Current Location');
                }
            });
        }

        function showPopularRoutes() {
            document.getElementById('popular-routes').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('map-container').style.display = 'none';
        }

        function selectPopularRoute(from, to) {
            document.getElementById('from-location').value = from;
            document.getElementById('to-location').value = to;
            planRoute();
        }

        function selectRoute(routeIndex) {
            // Save to favorites
            const route = document.querySelectorAll('.route-option')[routeIndex];
            const routeText = route.querySelector('.route-number').textContent;
            
            // Show success message
            alert(`Route ${routeText} selected! Added to favorites.`);
        }

        function showOfflineRoute(from, to) {
            // Show cached routes or basic route info
            const resultsDiv = document.getElementById('results');
            const resultsContainer = document.getElementById('route-results');
            
            resultsDiv.style.display = 'block';
            
            const html = `
                <div class="route-option recommended">
                    <div class="route-header">
                        <div class="route-info">
                            <span class="route-number">Offline Route</span>
                            <span class="route-modes">ðŸ“±</span>
                        </div>
                        <span class="recommended-badge">Offline</span>
                    </div>
                    <div class="route-stats">
                        <span class="stat">
                            <i class="fas fa-info-circle"></i> Connect to internet for live routes
                        </span>
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
        }

        function saveRouteToHistory(from, to, route) {
            const history = JSON.parse(localStorage.getItem('routeHistory') || '[]');
            const routeData = {
                from,
                to,
                duration: route.legs[0].duration.text,
                distance: route.legs[0].distance.text,
                timestamp: new Date().toISOString()
            };
            
            history.unshift(routeData);
            history.splice(10); // Keep only last 10 routes
            
            localStorage.setItem('routeHistory', JSON.stringify(history));
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? '#f44336' : '#667eea'};
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                z-index: 10001;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-size: 14px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Navigation
        function showSection(section) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // Show/hide sections based on section
            // This would be implemented based on your needs
            console.log('Showing section:', section);
        }
    </script>
</body>
</html>
