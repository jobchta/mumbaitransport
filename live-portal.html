<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#5E6AD2" />
  <meta name="color-scheme" content="light dark" />
  <meta name="description" content="Mumbai Transport Hub: Live map, schedules, and updates for BEST buses, local trains, metro, monorail, and ferries." />
  <title>Mumbai Transport Hub | Real-Time Tracking</title>

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="preconnect" href="https://unpkg.com" crossorigin />
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Leaflet for real map rendering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --primary: #5E6AD2;
      --primary-dark: #4C56C4;
      --primary-light: #F1F2FD;
      --secondary: #8B92B2;
      --background: #FAFBFC;
      --surface: #FFFFFF;
      --surface-hover: #F7F8FA;
      --border: #E1E4E8;
      --border-light: #F1F3F4;
      --text-primary: #1D2125;
      --text-secondary: #626F86;
      --text-muted: #8B92B2;
      --success: #00B87A;
      --warning: #F79009;
      --error: #DC3A42;
      --info: #0EA5E9;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }
    [data-theme="dark"] {
      --background: #0F1419;
      --surface: #1A1D23;
      --surface-hover: #222530;
      --border: #2D3442;
      --border-light: #252932;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --text-muted: #6B7280;
      --primary-light: rgba(94, 106, 210, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 14px;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background 0.3s ease, color 0.3s ease;
    }
    .app { height: 100vh; display: flex; flex-direction: column; position: relative; overflow: hidden; }

    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px 12px;
      position: relative;
      z-index: 100;
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
    }
    [data-theme="dark"] .header { background: rgba(26, 29, 35, 0.9); }
    .header-top { display: flex; align-items: center; justify-content: space-between; }
    .logo { font-size: 18px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.2px; display: flex; align-items: center; gap: 8px; }
    .logo-icon { width: 28px; height: 28px; background: var(--primary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; }
    .header-actions { display: flex; gap: 10px; }
    .header-btn { width: 36px; height: 36px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; background: var(--background); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; }
    .header-btn:hover { background: var(--surface-hover); }
    .header-btn:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    .search-bar { position: relative; }
    .search-input { width: 100%; padding: 12px 16px 12px 44px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; color: var(--text-primary); outline: none; transition: all 0.2s ease; }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(94, 106, 210, 0.1); }
    .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 16px; }

    .content { flex: 1; padding: 16px 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; scroll-behavior: smooth; }
    .section-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .section-title i { color: var(--primary); }

    .transport-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
    .transport-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; transition: all 0.2s ease; cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column; gap: 8px; }
    .transport-card.active { border-color: var(--primary); background: var(--primary-light); }
    .transport-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .card-header { display: flex; align-items: center; gap: 10px; }
    .card-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; flex-shrink: 0; }
    .bus-icon { background: var(--primary); }
    .train-icon { background: var(--success); }
    .metro-icon { background: #8B5CF6; }
    .ferry-icon { background: var(--info); }
    .mono-icon { background: #10B981; }
    .card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); line-height: 1.2; }
    .card-status { display: flex; align-items: center; gap: 6px; }
    .status-indicator { width: 8px; height: 8px; border-radius: 50%; }
    .status-active { background: var(--success); }
    .status-delayed { background: var(--warning); }
    .status-offline { background: var(--error); }
    .card-status-text { font-size: 12px; color: var(--text-muted); }
    .card-stats { display: flex; justify-content: space-between; margin-top: auto; padding-top: 8px; }
    .stat { text-align: center; flex: 1; }
    .stat-number { font-size: 16px; font-weight: 700; color: var(--text-primary); line-height: 1; transition: all 0.3s ease; }
    .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

    .action-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .action-button { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px; font-size: 13px; color: var(--text-secondary); font-weight: 500; cursor: pointer; transition: all 0.2s ease; text-align: left; display: flex; align-items: center; gap: 10px; }
    .action-button:hover { background: var(--surface-hover); transform: translateY(-1px); }
    .action-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 16px; flex-shrink: 0; }

    /* Real map container */
    .map-container { border-radius: var(--radius-lg); overflow: hidden; position: relative; border: 1px solid var(--border); background: var(--surface); }
    #leafletMap { height: 260px; width: 100%; }
    /* Fallback decorative map */
    .map-fallback { height: 200px; position: relative; background: linear-gradient(135deg, #e8f4f8 0%, #f5f9fc 100%); }
    .map-bg { position: absolute; inset: 0; background-image:
      radial-gradient(circle at 20% 30%, rgba(94, 106, 210, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(0, 184, 122, 0.1) 0%, transparent 50%); }
    .map-grid { position: absolute; inset: 0; background-image:
      linear-gradient(90deg, rgba(225, 228, 232, 0.3) 1px, transparent 1px),
      linear-gradient(0deg, rgba(225, 228, 232, 0.3) 1px, transparent 1px);
      background-size: 30px 30px; }
    .vehicle-marker { position: absolute; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transform: translate(-50%, -50%); transition: transform 0.2s ease; cursor: pointer; z-index: 5; }
    .vehicle-marker:hover { transform: translate(-50%, -50%) scale(1.4); z-index: 10; }
    .vehicle-marker::after {
      content: attr(data-route); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm);
      padding: 4px 6px; font-size: 10px; font-weight: 600; white-space: nowrap; box-shadow: var(--shadow-md);
      opacity: 0; pointer-events: none; transition: opacity 0.2s ease; color: var(--text-primary); margin-bottom: 4px;
    }
    .vehicle-marker:hover::after { opacity: 1; }

    .updates-list { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .update-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); display: flex; align-items: flex-start; gap: 12px; transition: background-color 0.3s ease; }
    .update-item:last-child { border-bottom: none; }
    .update-item.new { background-color: var(--primary-light); }
    .update-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; color: white; }
    .update-content { flex: 1; min-width: 0; }
    .update-text { font-size: 13px; color: var(--text-primary); line-height: 1.4; margin-bottom: 4px; }
    .update-time { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }

    .schedule-list { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .schedule-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 12px; transition: background-color 0.3s ease; }
    .schedule-item:last-child { border-bottom: none; }
    .schedule-item:hover { background: var(--surface-hover); }
    .schedule-item.updating { background: var(--primary-light); }
    .schedule-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; color: white; }
    .schedule-content { flex: 1; min-width: 0; }
    .schedule-route { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .schedule-time { font-size: 12px; color: var(--text-muted); }
    .schedule-delay { font-size: 11px; color: var(--warning); font-weight: 600; }

    .bottom-nav { background: var(--surface); border-top: 1px solid var(--border); padding: 8px 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex-shrink: 0; }
    .nav-button { padding: 8px 4px; border-radius: var(--radius-md); background: transparent; border: none; color: var(--text-muted); font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .nav-button.active { color: var(--primary); background: var(--primary-light); }
    .nav-button:hover { background: var(--surface-hover); }
    .nav-button:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    .nav-icon { font-size: 20px; }

    .live-indicator { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 600; color: var(--error); background: rgba(220, 58, 66, 0.1); padding: 2px 6px; border-radius: 10px; margin-left: 8px; }
    .live-indicator::before { content: ""; display: block; width: 6px; height: 6px; background: var(--error); border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:0.4} 100%{opacity:1} }

    .notification {
      position: fixed; top: 80px; right: 20px; background: var(--primary); color: white;
      padding: 12px 16px; border-radius: var(--radius-md); font-size: 13px; font-weight: 500;
      z-index: 1000; box-shadow: var(--shadow-lg); max-width: 300px;
    }

    /* Bottom sheet for details */
    .sheet-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1200; display: none; }
    .sheet { position: fixed; left: 0; right: 0; bottom: 0; background: var(--surface); border-top: 1px solid var(--border); border-radius: 16px 16px 0 0; box-shadow: var(--shadow-lg); transform: translateY(100%); transition: transform 0.25s ease; z-index: 1201; max-height: 70vh; display: flex; flex-direction: column; }
    .sheet.open { transform: translateY(0); }
    .sheet-backdrop.show { display: block; }
    .sheet-header { padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-light); }
    .sheet-title { font-size: 14px; font-weight: 700; }
    .sheet-close { border: 1px solid var(--border); background: var(--background); color: var(--text-secondary); border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    .sheet-body { padding: 12px 16px; overflow-y: auto; }

    .stat-number.updating { animation: numberUpdate 0.5s ease; }
    @keyframes numberUpdate { 0%{transform:scale(1)} 50%{transform:scale(1.1); color:var(--primary)} 100%{transform:scale(1)} }

    .network-banner {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1100;
      background: var(--warning); color: #111827; padding: 6px 12px; text-align: center; font-size: 12px; display: none;
    }
    .network-banner.online { background: var(--success); color: #fff; }
    .network-banner.show { display: block; }

    .sr-only {
      position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important;
      margin: -1px !important; overflow: hidden !important; clip: rect(0, 0, 0, 0) !important; white-space: nowrap !important; border: 0 !important;
    }

    /* Embed mode tweaks */
    body.embedded .bottom-nav { display: none; }
    body.embedded .header { padding-top: 12px; }
    body.embedded .app { height: 100%; }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }
    @media (max-width: 380px) {
      .action-grid, .transport-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="network-banner" id="networkBanner" role="status" aria-live="polite"></div>
  <a href="#main" class="sr-only" id="skipLink">Skip to content</a>
  <div id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <div class="app">
    <header class="header">
      <div class="header-top">
        <div class="logo" aria-label="Mumbai Transport Hub">
          <div class="logo-icon"><i class="fa-solid fa-train-subway"></i></div>
          Mumbai Transport Hub
        </div>
        <div class="header-actions">
          <button class="header-btn" id="theme-toggle" aria-label="Switch theme" type="button">
            <i class="fa-solid fa-moon"></i>
          </button>
          <button class="header-btn" id="notifications-btn" aria-label="Notifications" type="button">
            <i class="fa-solid fa-bell"></i>
          </button>
        </div>
      </div>
      <div class="search-bar">
        <i class="fa-solid fa-magnifying-glass search-icon" aria-hidden="true"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="Search routes or destinations..." aria-label="Search routes or destinations" autocomplete="off" />
      </div>
    </header>

    <main class="content" id="main">
      <section aria-labelledby="modes-heading">
        <h2 class="section-title" id="modes-heading"><i class="fa-solid fa-bus"></i> Transport Modes <span class="live-indicator">LIVE</span></h2>
        <div class="transport-grid" role="tablist" aria-label="Transport modes">
          <button class="transport-card active" data-transport="bus" role="tab" aria-selected="true" type="button">
            <div class="card-header">
              <div class="bus-icon card-icon"><i class="fa-solid fa-bus"></i></div>
              <div class="card-title">BEST Buses</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="bus-count">2,800</span>
                <span class="stat-label">Fleet</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="bus-ontime">92%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="train" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="train-icon card-icon"><i class="fa-solid fa-train-subway"></i></div>
              <div class="card-title">Local Trains</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-delayed" aria-hidden="true"></span>
              <span class="card-status-text">Minor Delays</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="train-count">2,342</span>
                <span class="stat-label">Services</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="train-ontime">87%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="metro" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="metro-icon card-icon"><i class="fa-solid fa-train-tram"></i></div>
              <div class="card-title">Metro</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="metro-count">12</span>
                <span class="stat-label">Lines</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="metro-ontime">98%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="ferry" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="ferry-icon card-icon"><i class="fa-solid fa-ship"></i></div>
              <div class="card-title">Ferry</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="ferry-count">8</span>
                <span class="stat-label">Routes</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="ferry-ontime">95%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>

          <button class="transport-card" data-transport="monorail" role="tab" aria-selected="false" type="button">
            <div class="card-header">
              <div class="mono-icon card-icon"><i class="fa-solid fa-train"></i></div>
              <div class="card-title">Monorail</div>
            </div>
            <div class="card-status">
              <span class="status-indicator status-active" aria-hidden="true"></span>
              <span class="card-status-text">Operational</span>
            </div>
            <div class="card-stats" aria-hidden="true">
              <div class="stat">
                <span class="stat-number" id="monorail-count">1</span>
                <span class="stat-label">Line</span>
              </div>
              <div class="stat">
                <span class="stat-number" id="monorail-ontime">94%</span>
                <span class="stat-label">On Time</span>
              </div>
            </div>
          </button>
        </div>
      </section>

      <section aria-labelledby="live-heading">
        <h2 class="section-title" id="live-heading"><i class="fa-solid fa-map-location-dot"></i> Live Vehicle Tracking <span class="live-indicator">LIVE</span></h2>
        <div class="map-container">
          <div id="leafletMap" role="img" aria-label="Live map of Mumbai vehicles"></div>
          <div class="map-fallback" id="mapFallback" hidden>
            <div class="map-bg"></div>
            <div class="map-grid"></div>
            <div class="map-content" id="mapContent" aria-hidden="true"></div>
          </div>
        </div>
      </section>

      <section aria-labelledby="departures-heading">
        <h2 class="section-title" id="departures-heading"><i class="fa-solid fa-clock"></i> Next Departures</h2>
        <div class="schedule-controls" style="display:flex; gap:8px; align-items:center; margin: 0 0 8px 0;">
          <label for="refTime" style="font-size:12px; color:var(--text-secondary);">Check time:</label>
          <input type="time" id="refTime" style="padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text-primary);">
          <button id="useNow" type="button" style="padding:6px 10px; border:1px solid var(--border); background:var(--background); color:var(--text-secondary); border-radius:8px; cursor:pointer;">Now</button>
        </div>
        <div class="schedule-list" id="scheduleList" role="list"></div>
      </section>

      <section aria-labelledby="actions-heading">
        <h2 class="section-title" id="actions-heading"><i class="fa-solid fa-bolt"></i> Quick Actions</h2>
        <div class="action-grid">
          <button class="action-button" id="buy-ticket" type="button">
            <span class="action-icon"><i class="fa-solid fa-ticket"></i></span>
            Buy Ticket
          </button>
          <button class="action-button" id="plan-journey" type="button">
            <span class="action-icon"><i class="fa-solid fa-route"></i></span>
            Plan Journey
          </button>
          <button class="action-button" id="nearby-stations" type="button">
            <span class="action-icon"><i class="fa-solid fa-map-pin"></i></span>
            Nearby Stations
          </button>
          <button class="action-button" id="recharge-card" type="button">
            <span class="action-icon"><i class="fa-solid fa-wallet"></i></span>
            Recharge Card
          </button>
        </div>
      </section>

      <section aria-labelledby="updates-heading">
        <h2 class="section-title" id="updates-heading"><i class="fa-solid fa-triangle-exclamation"></i> Service Updates</h2>
        <div class="updates-list" id="updatesList" role="feed" aria-live="polite"></div>
      </section>

      <section aria-labelledby="facts-heading">
        <h2 class="section-title" id="facts-heading"><i class="fa-solid fa-chart-line"></i> Mumbai Transport Facts</h2>
        <div class="updates-list">
          <div class="update-item">
            <div class="update-icon" style="background: var(--success);">
              <i class="fa-solid fa-bus"></i>
            </div>
            <div class="update-content">
              <div class="update-text"><strong>BEST</strong> operates ~2,800 buses across Mumbai.</div>
              <div class="update-time">Daily operations</div>
            </div>
          </div>
          <div class="update-item">
            <div class="update-icon" style="background: var(--info);">
              <i class="fa-solid fa-train"></i>
            </div>
            <div class="update-content">
              <div class="update-text"><strong>Mumbai Suburban Railway</strong> runs 2,342 services daily and carries 7.5M+ commuters on Western, Central and Harbour lines.</div>
              <div class="update-time">Indicative daily averages</div>
            </div>
          </div>
        </div>
      </section>

      <section aria-labelledby="metro-info-heading">
        <h2 class="section-title" id="metro-info-heading"><i class="fa-solid fa-circle-info"></i> Mumbai Metro Network Status</h2>
        <div class="updates-list">
          <div class="update-item">
            <div class="update-icon" style="background: var(--info);">
              <i class="fa-solid fa-train-tram"></i>
            </div>
            <div class="update-content">
              <div class="update-text"><strong>Operational lines</strong>: Line 1 (Versova–Andheri–Ghatkopar), Line 2A (Dahisar–Dahanukarwadi), Line 7 (Andheri East–Dahisar East).</div>
              <div class="update-time">Verified metro info (June 2025)</div>
            </div>
          </div>
          <div class="update-item">
            <div class="update-icon" style="background: var(--warning);">
              <i class="fa-solid fa-wrench"></i>
            </div>
            <div class="update-content">
              <div class="update-text"><strong>Under construction / planned</strong>: Line 3 (Colaba–Bandra–SEEPZ), Line 5 (Thane–Bhiwandi–Kalyan), Line 6 (Swami Samarth Nagar–Vikhroli).</div>
              <div class="update-time">Compiled from official/public sources</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <nav class="bottom-nav" role="navigation" aria-label="Primary">
      <button class="nav-button active" data-nav="home" type="button">
        <i class="nav-icon fa-solid fa-house"></i>
        Home
      </button>
      <button class="nav-button" data-nav="map" type="button">
        <i class="nav-icon fa-solid fa-map-location"></i>
        Map
      </button>
      <button class="nav-button" data-nav="tickets" type="button">
        <i class="nav-icon fa-solid fa-ticket"></i>
        Tickets
      </button>
      <button class="nav-button" data-nav="account" type="button">
        <i class="nav-icon fa-solid fa-user"></i>
        Account
      </button>
    </nav>
  </div>

  <!-- Bottom sheet for details -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
    <div class="sheet-header">
      <div class="sheet-title" id="sheetTitle">Details</div>
      <button class="sheet-close" id="sheetClose" type="button">Close</button>
    </div>
    <div class="sheet-body" id="sheetBody"></div>
  </div>

  <noscript>
    <div class="notification" role="alert">This app needs JavaScript enabled.</div>
  </noscript>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer type="3b11bab85d2525af6551e7f1-text/javascript"></script>

  <script type="3b11bab85d2525af6551e7f1-text/javascript">
    // Mumbai Transport Hub - robust single-file app
    (function() {
      const STORAGE_KEYS = {
        theme: 'mth.theme',
        transport: 'mth.transport'
      };

      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
      if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
      else document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');

      class MumbaiTransportHub {
        constructor() {
          this.appData = {
            selectedTransport: localStorage.getItem(STORAGE_KEYS.transport) || 'bus',
            theme: document.documentElement.getAttribute('data-theme') || 'light',
            vehicles: new Map(),
            leafletMarkers: new Map(),
            routes: this.initializeRoutes(),
            updates: [],
            searchTimer: null,
            reduceMotion: window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches
          };

          this.map = null;
          this.mapFallbackMode = false;
          this.vehicleBounds = { latMin: 18.85, latMax: 19.35, lngMin: 72.75, lngMax: 73.10 };
          this.timers = { vehicles: null, schedules: null, stats: null, updates: null };
          this.peakHours = [ {start: 7, end: 10}, {start: 18, end: 21} ];

          this.safeInit();
        }

        safeInit() {
          try {
            this.setupEventListeners();
            this.initMap();
            this.createInitialVehicles();
            this.restoreSelectedTransportUI();
            this.updateUI();
            this.startRealTimeUpdates();
            this.showNotification('🚌 Mumbai Transport Hub ready — live tracking active!');
            this.registerServiceWorker();
            this.setupNetworkBanner();
          } catch (e) {
            console.error('Initialization error:', e);
            this.showNotification('⚠️ Initialization failed. Some features may be limited.');
          }
        }

        initializeRoutes() {
          return {
            bus: [
              { id: 'A1E', name: 'A-1 Express', from: 'Colaba', to: 'Bandra', time: 3, delay: 0, passengers: 45, capacity: 70 },
              { id: '2L', name: '2Ltd', from: 'Mumbai Central', to: 'Bandra', time: 7, delay: 2, passengers: 52, capacity: 65 },
              { id: '37', name: '37', from: 'Santacruz', to: 'Colaba', time: 12, delay: 0, passengers: 38, capacity: 60 },
              { id: '54L', name: '54Ltd', from: 'Kurla', to: 'Colaba', time: 5, delay: 1, passengers: 41, capacity: 55 },
              { id: '85', name: '85', from: 'Borivali', to: 'Colaba', time: 15, delay: 0, passengers: 29, capacity: 70 },
              { id: '124', name: '124', from: 'Andheri', to: 'CST', time: 8, delay: 3, passengers: 56, capacity: 65 }
            ],
            train: [
              { id: 'WR_F', name: 'Western Fast', from: 'Borivali', to: 'Churchgate', time: 2, delay: 3, passengers: 1247, capacity: 1800 },
              { id: 'WR_S', name: 'Western Slow', from: 'Virar', to: 'Churchgate', time: 4, delay: 1, passengers: 1456, capacity: 1800 },
              { id: 'CR_F', name: 'Central Fast', from: 'Kalyan', to: 'CST', time: 6, delay: 0, passengers: 1523, capacity: 1800 },
              { id: 'HR', name: 'Harbour Line', from: 'Panvel', to: 'CST', time: 8, delay: 2, passengers: 987, capacity: 1800 },
              { id: 'TH', name: 'Trans-Harbour', from: 'Thane', to: 'Vashi', time: 11, delay: 1, passengers: 754, capacity: 1800 }
            ],
            metro: [
              { id: 'M1', name: 'Line 1 (Blue)', from: 'Versova', to: 'Ghatkopar', time: 1, delay: 0, passengers: 234, capacity: 1200 },
              { id: 'M2A', name: 'Line 2A (Yellow)', from: 'Dahisar', to: 'DN Nagar', time: 3, delay: 0, passengers: 156, capacity: 1200 },
              { id: 'M7', name: 'Line 7 (Red)', from: 'Andheri E', to: 'Dahisar E', time: 5, delay: 0, passengers: 198, capacity: 1200 },
              { id: 'M3', name: 'Line 3 (Pink)', from: 'Colaba', to: 'SEEPZ', time: 7, delay: 1, passengers: 267, capacity: 1200 }
            ],
            ferry: [
              { id: 'F1', name: 'Gateway-Elephanta', from: 'Gateway', to: 'Elephanta', time: 25, delay: 0, passengers: 89, capacity: 150 },
              { id: 'F2', name: 'Colaba-Alibaug', from: 'Colaba', to: 'Alibaug', time: 45, delay: 5, passengers: 67, capacity: 200 },
              { id: 'F3', name: 'Mazagon-Mandwa', from: 'Mazagon', to: 'Mandwa', time: 35, delay: 0, passengers: 43, capacity: 180 }
            ],
            monorail: [
              { id: 'MR1', name: 'Monorail Line 1', from: 'Chembur', to: 'Sant Gadge Maharaj Chowk', time: 4, delay: 0, passengers: 210, capacity: 600 }
            ]
          };
        }

        setupEventListeners() {
          document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());

          document.querySelectorAll('.transport-card').forEach(card => {
            card.addEventListener('click', () => {
              const transport = card.dataset.transport;
              this.selectTransport(transport);
            });
          });

          const searchInput = document.getElementById('searchInput');
          searchInput.addEventListener('input', (e) => {
            clearTimeout(this.appData.searchTimer);
            const q = e.target.value.trim();
            this.appData.searchTimer = setTimeout(() => this.performSearch(q), 220);
          });

          document.getElementById('buy-ticket').addEventListener('click', () => {
            if (window.openTicketsSheet) window.openTicketsSheet();
            else this.showNotification('🎫 Redirecting to ticket booking...');
          });
          document.getElementById('plan-journey').addEventListener('click', () =>
            this.showNotification('🗺️ Opening route planner...'));
          document.getElementById('nearby-stations').addEventListener('click', () =>
            this.findNearbyStations());
          document.getElementById('recharge-card').addEventListener('click', () =>
            this.showNotification('💳 Opening recharge portal...'));

          document.querySelectorAll('.nav-button').forEach(btn => {
            btn.addEventListener('click', () => {
              document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              this.showNotification(`📱 ${btn.textContent.trim()} section`);
            });
          });

          document.addEventListener('visibilitychange', () => {
            if (document.hidden) this.pauseUpdates();
            else this.resumeUpdates();
          });

          window.addEventListener('beforeunload', () => this.cleanup());
        }

        initMap() {
          const fallback = document.getElementById('mapFallback');
          const leafletDiv = document.getElementById('leafletMap');
          try {
            if (window.L && leafletDiv) {
              this.map = L.map('leafletMap', { zoomControl: false, attributionControl: false }).setView([19.076, 72.8777], 11);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
              }).addTo(this.map);
              fallback.hidden = true;
              leafletDiv.hidden = false;
            } else {
              throw new Error('Leaflet not available yet');
            }
          } catch (e) {
            console.warn('Map init fallback:', e.message);
            this.mapFallbackMode = true;
            fallback.hidden = false;
            leafletDiv.hidden = true;
          }
        }

        createInitialVehicles() {
          const colors = { bus: '#5E6AD2', train: '#00B87A', metro: '#8B5CF6', ferry: '#0EA5E9', monorail: '#10B981' };
          const types = Object.keys(colors);
          const routes = ['A1E','2L','37','WR_F','CR_F','M1','M2A','F1','MR1'];

          for (let i = 0; i < 24; i++) {
            const type = types[i % types.length];
            const route = routes[i % routes.length];
            const lat = this.randomInRange(this.vehicleBounds.latMin, this.vehicleBounds.latMax);
            const lng = this.randomInRange(this.vehicleBounds.lngMin, this.vehicleBounds.lngMax);
            const dx = (Math.random() - 0.5) * 0.002;
            const dy = (Math.random() - 0.5) * 0.002;

            const vehicle = {
              id: `vehicle_${i}`,
              type, route,
              color: colors[type],
              lat, lng, dx, dy,
              speed: Math.random() * 0.8 + 0.2,
              lastUpdate: Date.now()
            };
            this.appData.vehicles.set(vehicle.id, vehicle);

            if (this.map && !this.mapFallbackMode) {
              const marker = L.circleMarker([vehicle.lat, vehicle.lng], {
                radius: 5, color: '#fff', weight: 1.5, fillColor: vehicle.color, fillOpacity: 1
              }).bindTooltip(`${vehicle.type.toUpperCase()} ${vehicle.route}`, { direction: 'top', offset: [0, -4] });
              marker.addTo(this.map);
              this.appData.leafletMarkers.set(vehicle.id, marker);
            }
          }
        }

        updateVehiclePositions() {
          try {
            const mapContent = document.getElementById('mapContent');
            if (this.mapFallbackMode && mapContent) {
              mapContent.querySelectorAll('.vehicle-marker').forEach(m => m.remove());
            }

            const deltaScale = this.appData.reduceMotion ? 0.5 : 1;
            this.appData.vehicles.forEach(v => {
              v.lat += v.dy * v.speed * deltaScale;
              v.lng += v.dx * v.speed * deltaScale;

              if (v.lat < this.vehicleBounds.latMin || v.lat > this.vehicleBounds.latMax) v.dy *= -1;
              if (v.lng < this.vehicleBounds.lngMin || v.lng > this.vehicleBounds.lngMax) v.dx *= -1;

              v.lat = Math.min(this.vehicleBounds.latMax, Math.max(this.vehicleBounds.latMin, v.lat));
              v.lng = Math.min(this.vehicleBounds.lngMax, Math.max(this.vehicleBounds.lngMin, v.lng));

              if (Math.random() < 0.03) {
                v.dx += (Math.random() - 0.5) * 0.0006;
                v.dy += (Math.random() - 0.5) * 0.0006;
              }

              if (this.map && !this.mapFallbackMode) {
                const marker = this.appData.leafletMarkers.get(v.id);
                if (marker) marker.setLatLng([v.lat, v.lng]);
              } else if (mapContent) {
                // Render fallback markers in a simple grid (not geo-accurate)
                const marker = document.createElement('div');
                marker.className = 'vehicle-marker';
                marker.style.backgroundColor = v.color;
                const xPct = ((v.lng - this.vehicleBounds.lngMin) / (this.vehicleBounds.lngMax - this.vehicleBounds.lngMin)) * 90 + 5;
                const yPct = ((v.lat - this.vehicleBounds.latMin) / (this.vehicleBounds.latMax - this.vehicleBounds.latMin)) * 90 + 5;
                marker.style.left = xPct + '%';
                marker.style.top = (100 - yPct) + '%';
                marker.setAttribute('data-route', v.route);
                marker.title = `${v.type.toUpperCase()} ${v.route} - Live tracking`;
                mapContent.appendChild(marker);
              }
            });
          } catch (e) {
            console.error('updateVehiclePositions error:', e);
          }
        }

        updateSchedules() {
          const scheduleList = document.getElementById('scheduleList');
          const transport = this.appData.selectedTransport;
          const routes = this.appData.routes[transport] || [];
          const nowHour = new Date().getHours();
          const isPeak = this.peakHours.some(p => nowHour >= p.start && nowHour <= p.end);

          routes.forEach(route => {
            if (Math.random() < 0.3) route.time = Math.max(1, route.time + (Math.random() > 0.5 ? -1 : 1));
            if (isPeak && Math.random() < 0.4) route.delay = Math.min(10, (route.delay || 0) + Math.floor(Math.random() * 2));
            else if (!isPeak && route.delay > 0 && Math.random() < 0.6) route.delay = Math.max(0, route.delay - 1);
          });

          scheduleList.innerHTML = '';

          const colors = { bus: '#5E6AD2', train: '#00B87A', metro: '#8B5CF6', ferry: '#0EA5E9', monorail: '#10B981' };
          const icons = { bus: 'fa-bus', train: 'fa-train-subway', metro: 'fa-train-tram', ferry: 'fa-ship', monorail: 'fa-train' };

          routes.slice(0, 8).forEach(route => {
            const item = document.createElement('div');
            item.className = 'schedule-item';
            const totalTime = (route.time || 0) + (route.delay || 0);
            const delayText = route.delay > 0 ? ` (+${route.delay} min delay)` : '';
            const occupancy = Math.min(100, Math.round((route.passengers / route.capacity) * 100));

            item.innerHTML = `
              <div class="schedule-icon" style="background: ${colors[transport]};"><i class="fa-solid ${icons[transport]}"></i></div>
              <div class="schedule-content">
                <div class="schedule-route">${route.name} • ${route.from} → ${route.to}</div>
                <div class="schedule-time">Next: ${totalTime} min${delayText} • ${occupancy}% full</div>
              </div>
            `;
            if (Math.random() < 0.15) {
              item.classList.add('updating');
              setTimeout(() => item.classList.remove('updating'), 900);
            }
            scheduleList.appendChild(item);
          });
        }

        updateStats() {
          const stats = {
            bus: { count: 1247, ontime: 92 },
            train: { count: 2847, ontime: 87 },
            metro: { count: 12, ontime: 98 },
            ferry: { count: 8, ontime: 95 },
            monorail: { count: 1, ontime: 94 }
          };
          Object.keys(stats).forEach(transport => {
            const countEl = document.getElementById(`${transport}-count`);
            const ontimeEl = document.getElementById(`${transport}-ontime`);
            if (!countEl || !ontimeEl) return;

            const countVariation = Math.floor(Math.random() * 10) - 5;
            const ontimeVariation = Math.floor(Math.random() * 4) - 2;
            const newCount = Math.max(0, stats[transport].count + countVariation);
            const newOntime = Math.max(70, Math.min(100, stats[transport].ontime + ontimeVariation));

            if (countEl.textContent !== newCount.toLocaleString()) {
              countEl.classList.add('updating');
              countEl.textContent = newCount.toLocaleString();
              setTimeout(() => countEl.classList.remove('updating'), 500);
            }
            if (ontimeEl.textContent !== `${newOntime}%`) {
              ontimeEl.classList.add('updating');
              ontimeEl.textContent = `${newOntime}%`;
              setTimeout(() => ontimeEl.classList.remove('updating'), 500);
            }

            const card = document.querySelector(`[data-transport="${transport}"]`);
            if (card) {
              const indicator = card.querySelector('.status-indicator');
              const statusText = card.querySelector('.card-status-text');
              if (newOntime >= 95) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = 'Operational';
              } else if (newOntime >= 85) {
                indicator.className = 'status-indicator status-delayed';
                statusText.textContent = 'Minor Delays';
              } else {
                indicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Major Delays';
              }
            }
          });
        }

        updateServiceUpdates() {
          const updatesList = document.getElementById('updatesList');
          const possible = [
            { type: 'success', icon: 'fa-circle-check', text: 'Metro Line 1 running at 2-min frequency during peak', category: 'metro' },
            { type: 'warning', icon: 'fa-triangle-exclamation', text: 'Western Line delays 3-5 min due to signal issue at Dadar', category: 'train' },
            { type: 'info', icon: 'fa-circle-info', text: 'BEST 2Ltd diverted via Linking Road (construction)', category: 'bus' },
            { type: 'success', icon: 'fa-ship', text: 'Ferry to Elephanta on schedule (every 30 min)', category: 'ferry' },
            { type: 'warning', icon: 'fa-cloud-rain', text: 'Heavy rain may impact bus timings. Plan extra time.', category: 'weather' },
            { type: 'info', icon: 'fa-tools', text: 'Central Line block Kurla-Ghatkopar 11 PM–4 AM (maintenance)', category: 'maintenance' }
          ];

          if (Math.random() < 0.1 && this.appData.updates.length < 6) {
            this.appData.updates.unshift({
              ...possible[Math.floor(Math.random() * possible.length)],
              id: Date.now(),
              time: new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date()),
              isNew: true
            });
          }

          updatesList.innerHTML = '';
          if (this.appData.updates.length === 0) {
            updatesList.innerHTML = `
              <div class="update-item">
                <div class="update-icon" style="background: var(--success);">
                  <i class="fa-solid fa-circle-check"></i>
                </div>
                <div class="update-content">
                  <div class="update-text">All Mumbai transport services operating normally</div>
                  <div class="update-time"><i class="fa-regular fa-clock"></i> ${new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date())}</div>
                </div>
              </div>
            `;
            return;
          }

          const colorMap = { success: 'var(--success)', warning: 'var(--warning)', info: 'var(--info)', error: 'var(--error)' };
          this.appData.updates.forEach(u => {
            const item = document.createElement('div');
            item.className = `update-item ${u.isNew ? 'new' : ''}`;
            item.innerHTML = `
              <div class="update-icon" style="background: ${colorMap[u.type]};"><i class="fa-solid ${u.icon}"></i></div>
              <div class="update-content">
                <div class="update-text">${u.text}</div>
                <div class="update-time"><i class="fa-regular fa-clock"></i> ${u.time}</div>
              </div>
            `;
            updatesList.appendChild(item);
            if (u.isNew) setTimeout(() => { u.isNew = false; }, 1500);
          });
        }

        selectTransport(transport) {
          this.appData.selectedTransport = transport;
          localStorage.setItem(STORAGE_KEYS.transport, transport);
          document.querySelectorAll('.transport-card').forEach(card => {
            const isActive = card.dataset.transport === transport;
            card.classList.toggle('active', isActive);
            card.setAttribute('aria-selected', String(isActive));
          });
          this.updateSchedules();
          this.showNotification(`🚌 Switched to ${transport.toUpperCase()} view`);
        }

        performSearch(query) {
          const scheduleList = document.getElementById('scheduleList');
          if (query.length < 2) {
            this.updateSchedules();
            return;
          }

          const allRoutes = [];
          const colors = { bus: '#5E6AD2', train: '#00B87A', metro: '#8B5CF6', ferry: '#0EA5E9', monorail: '#10B981' };
          const icons = { bus: 'fa-bus', train: 'fa-train-subway', metro: 'fa-train-tram', ferry: 'fa-ship', monorail: 'fa-train' };

          Object.keys(this.appData.routes).forEach(transport => {
            this.appData.routes[transport].forEach(route => allRoutes.push({ ...route, transport, color: colors[transport], icon: icons[transport] }));
          });

          const q = query.toLowerCase();
          const filtered = allRoutes.filter(route =>
            route.name.toLowerCase().includes(q) || route.from.toLowerCase().includes(q) || route.to.toLowerCase().includes(q)
          );

          scheduleList.innerHTML = '';
          if (filtered.length === 0) {
            scheduleList.innerHTML = `
              <div class="update-item">
                <div class="update-icon" style="background: var(--text-muted);">
                  <i class="fa-solid fa-magnifying-glass"></i>
                </div>
                <div class="update-content">
                  <div class="update-text">No routes found for "${this.escapeHtml(query)}"</div>
                  <div class="update-time">Try searching for route numbers or station names</div>
                </div>
              </div>
            `;
            return;
          }

          filtered.slice(0, 12).forEach(route => {
            const item = document.createElement('div');
            item.className = 'schedule-item';
            const totalTime = (route.time || 0) + (route.delay || 0);
            const delayText = route.delay > 0 ? ` (+${route.delay} min delay)` : '';
            item.innerHTML = `
              <div class="schedule-icon" style="background: ${route.color};"><i class="fa-solid ${route.icon}"></i></div>
              <div class="schedule-content">
                <div class="schedule-route">${route.name} • ${route.from} → ${route.to}</div>
                <div class="schedule-time">Next: ${totalTime} min${delayText} • ${route.transport.toUpperCase()}</div>
              </div>
            `;
            scheduleList.appendChild(item);
          });
        }

        findNearbyStations() {
          const stations = [
            'Churchgate Station - 0.3 km (Western Line)',
            'Marine Lines - 0.8 km (Western Line)',
            'Charni Road - 1.2 km (Western Line)',
            'CST Terminus - 1.5 km (Central/Harbour Lines)',
            'Ghatkopar Metro - 2.1 km (Metro Line 1)'
          ];
          this.showNotification(`📍 Nearby: ${stations[0]}`);
          setTimeout(() => this.showNotification(`📍 Found ${stations.length} stations within 3km radius`), 1500);
        }

        toggleTheme() {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          const newTheme = isDark ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem(STORAGE_KEYS.theme, newTheme);
          const themeIcon = document.querySelector('#theme-toggle i');
          themeIcon.className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
          this.showNotification(`${isDark ? '🌞' : '🌙'} Switched to ${newTheme} theme`);
        }

        showNotification(message) {
          const notification = document.createElement('div');
          notification.className = 'notification';
          notification.role = 'status';
          notification.textContent = message;
          document.body.appendChild(notification);
          const live = document.getElementById('liveRegion');
          if (live) live.textContent = message;

          setTimeout(() => {
            notification.remove();
          }, 2600);
        }

        updateUI() {
          this.updateVehiclePositions();
          this.updateSchedules();
          this.updateStats();
          this.updateServiceUpdates();
        }

        startRealTimeUpdates() {
          const vehicleInterval = this.appData.reduceMotion ? 3000 : 1800;
          this.timers.vehicles = setInterval(() => this.updateVehiclePositions(), vehicleInterval);
          this.timers.schedules = setInterval(() => this.updateSchedules(), 5000);
          this.timers.stats = setInterval(() => this.updateStats(), 8000);
          this.timers.updates = setInterval(() => this.updateServiceUpdates(), 15000);

          setInterval(() => {
            if (this.appData.updates.length > 8) this.appData.updates = this.appData.updates.slice(0, 6);
          }, 60000);
        }

        pauseUpdates() {
          Object.values(this.timers).forEach(t => t && clearInterval(t));
          this.timers = { vehicles: null, schedules: null, stats: null, updates: null };
        }
        resumeUpdates() {
          if (!this.timers.vehicles) this.startRealTimeUpdates();
        }
        cleanup() { this.pauseUpdates(); }

        restoreSelectedTransportUI() {
          const t = this.appData.selectedTransport;
          document.querySelectorAll('.transport-card').forEach(card => {
            const isActive = card.dataset.transport === t;
            card.classList.toggle('active', isActive);
            card.setAttribute('aria-selected', String(isActive));
          });
        }

        setupNetworkBanner() {
          const banner = document.getElementById('networkBanner');
          const update = () => {
            if (navigator.onLine) {
              banner.textContent = 'Online';
              banner.className = 'network-banner online show';
              setTimeout(() => banner.classList.remove('show'), 1200);
            } else {
              banner.textContent = 'You are offline. Showing cached data (if available).';
              banner.className = 'network-banner show';
            }
          };
          window.addEventListener('online', update);
          window.addEventListener('offline', update);
          update();
        }

        registerServiceWorker() {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => {
              console.warn('SW registration failed (ok if no sw.js yet):', err);
            });
          }
        }

        randomInRange(min, max) { return Math.random() * (max - min) + min; }
        escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
      }

      let transportHub;
      function boot() {
        transportHub = new MumbaiTransportHub();

        // Initial service update
        setTimeout(() => {
          transportHub.appData.updates.push({
            id: Date.now(),
            type: 'success',
            icon: 'fa-circle-check',
            text: 'Metro Line 1 running with 2-minute peak frequency',
            time: new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date()),
            isNew: true
          });
          transportHub.updateServiceUpdates();
        }, 2000);

        setInterval(() => {
          if (!document.hidden && Math.random() < 0.1) transportHub.updateUI();
        }, 30000);

        window.MumbaiTransport = transportHub;
        // Handle embed mode
        const params = new URLSearchParams(window.location.search);
        const isEmbed = params.get('embed') === '1';
        if (isEmbed) {
          document.body.classList.add('embedded');
          const mode = params.get('mode');
          const section = params.get('section');
          if (mode) {
            const card = document.querySelector(`[data-transport="${mode}"]`);
            if (card) card.click();
          }
          if (section === 'map') {
            const el = document.getElementById('live-heading');
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          // Post a ready signal
          try { parent.postMessage({ type: 'mumbai-transport-ready' }, '*'); } catch(_) {}
        }

        // Listen for parent navigation commands
        window.addEventListener('message', (e) => {
          const msg = e.data || {};
          if (msg.type === 'mumbai-transport-nav') {
            if (msg.mode) {
              const card = document.querySelector(`[data-transport="${msg.mode}"]`);
              if (card) card.click();
            }
            if (msg.section === 'map') {
              const el = document.getElementById('live-heading');
              if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }
        });
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', boot);
      } else { boot(); }
    })();
  </script>
  <script type="3b11bab85d2525af6551e7f1-text/javascript">
  /* Static live overlay (Aug 2025) — single-file, no external JSON. */
  (function(){
    const SCHEDULES = {
      generatedAt: '2025-08-10T00:00:00+05:30',
      timezone: 'Asia/Kolkata',
      vehicleBounds: { latMin: 18.85, latMax: 19.35, lngMin: 72.75, lngMax: 73.10 },
      routes: [
        { mode:'metro', routeId:'M1', name:'Line 1 (Blue)', from:'Versova', to:'Ghatkopar',
          fromStop:{ id:'VERS', lat:19.1340, lng:72.8260 }, toStop:{ id:'GHAT', lat:19.0860, lng:72.9230 },
          frequencies:[
            { days:'weekday', start:'06:00', end:'10:30', headway:3, runtime:24 },
            { days:'weekday', start:'10:30', end:'17:00', headway:5, runtime:24 },
            { days:'weekday', start:'17:00', end:'21:30', headway:3, runtime:24 },
            { days:'weekday', start:'21:30', end:'23:15', headway:6, runtime:24 },
            { days:'weekend', start:'07:00', end:'23:00', headway:6, runtime:24 }
          ]
        },
        // Aqua Line (Line 3) partial operations (Aarey JVLR ↔ Acharya Atre Chowk)
        { mode:'metro', routeId:'M3', name:'Line 3 (Aqua) – Aarey JVLR ↔ Acharya Atre Chowk', from:'Aarey JVLR', to:'Acharya Atre Chowk',
          fromStop:{ id:'ARY', lat:19.1475, lng:72.8644 }, toStop:{ id:'AAC', lat:18.9775, lng:72.8325 },
          frequencies:[
            { days:'weekday', start:'06:30', end:'10:30', headway:7, runtime:32 },
            { days:'weekday', start:'10:30', end:'17:30', headway:8, runtime:32 },
            { days:'weekday', start:'17:30', end:'21:30', headway:7, runtime:32 },
            { days:'weekend', start:'07:00', end:'22:30', headway:8, runtime:32 }
          ]
        },
        { mode:'metro', routeId:'M2A', name:'Line 2A (Yellow)', from:'Dahisar E', to:'DN Nagar',
          fromStop:{ id:'DHS', lat:19.2560, lng:72.8625 }, toStop:{ id:'DNN', lat:19.1287, lng:72.8370 },
          frequencies:[
            { days:'weekday', start:'06:30', end:'10:30', headway:4, runtime:40 },
            { days:'weekday', start:'10:30', end:'17:00', headway:6, runtime:40 },
            { days:'weekday', start:'17:00', end:'21:30', headway:4, runtime:40 },
            { days:'weekday', start:'21:30', end:'23:00', headway:8, runtime:40 },
            { days:'weekend', start:'07:00', end:'23:00', headway:6, runtime:40 }
          ]
        },
        { mode:'metro', routeId:'M7', name:'Line 7 (Red)', from:'Andheri E', to:'Dahisar E',
          fromStop:{ id:'AND', lat:19.1130, lng:72.8697 }, toStop:{ id:'DHE', lat:19.2512, lng:72.8720 },
          frequencies:[
            { days:'weekday', start:'06:30', end:'10:30', headway:4, runtime:33 },
            { days:'weekday', start:'10:30', end:'17:00', headway:6, runtime:33 },
            { days:'weekday', start:'17:00', end:'21:30', headway:4, runtime:33 },
            { days:'weekday', start:'21:30', end:'23:00', headway:8, runtime:33 },
            { days:'weekend', start:'07:00', end:'23:00', headway:6, runtime:33 }
          ]
        },

        { mode:'train', routeId:'WR_FAST', name:'Western Fast (Borivali → Churchgate)', from:'Borivali', to:'Churchgate',
          fromStop:{ id:'BOR', lat:19.2307, lng:72.8567 }, toStop:{ id:'CHG', lat:18.9354, lng:72.8277 },
          frequencies:[
            { days:'weekday', start:'05:30', end:'09:45', headway:2, runtime:38 },
            { days:'weekday', start:'09:45', end:'17:30', headway:5, runtime:38 },
            { days:'weekday', start:'17:30', end:'21:30', headway:2, runtime:38 },
            { days:'weekday', start:'21:30', end:'00:15', headway:6, runtime:38 },
            { days:'weekend', start:'06:00', end:'23:30', headway:6, runtime:38 }
          ]
        },
        { mode:'train', routeId:'WR_SLOW', name:'Western Slow (Virar → Churchgate)', from:'Virar', to:'Churchgate',
          fromStop:{ id:'VIR', lat:19.4559, lng:72.8110 }, toStop:{ id:'CHG', lat:18.9354, lng:72.8277 },
          frequencies:[
            { days:'weekday', start:'05:15', end:'09:45', headway:3, runtime:75 },
            { days:'weekday', start:'09:45', end:'17:30', headway:6, runtime:75 },
            { days:'weekday', start:'17:30', end:'21:30', headway:3, runtime:75 },
            { days:'weekday', start:'21:30', end:'00:00', headway:8, runtime:75 },
            { days:'weekend', start:'06:00', end:'23:30', headway:8, runtime:75 }
          ]
        },
        { mode:'train', routeId:'CR_FAST', name:'Central Fast (Kalyan → CSMT)', from:'Kalyan', to:'CSMT',
          fromStop:{ id:'KLY', lat:19.2437, lng:73.1355 }, toStop:{ id:'CSM', lat:18.9402, lng:72.8356 },
          frequencies:[
            { days:'weekday', start:'05:30', end:'09:45', headway:3, runtime:45 },
            { days:'weekday', start:'09:45', end:'17:30', headway:6, runtime:45 },
            { days:'weekday', start:'17:30', end:'21:30', headway:3, runtime:45 },
            { days:'weekday', start:'21:30', end:'00:15', headway:8, runtime:45 },
            { days:'weekend', start:'06:00', end:'23:30', headway:8, runtime:45 }
          ]
        },
        { mode:'train', routeId:'HR', name:'Harbour (Panvel → CSMT)', from:'Panvel', to:'CSMT',
          fromStop:{ id:'PNV', lat:18.9894, lng:73.1175 }, toStop:{ id:'CSM', lat:18.9402, lng:72.8356 },
          frequencies:[
            { days:'weekday', start:'05:45', end:'10:00', headway:4, runtime:60 },
            { days:'weekday', start:'10:00', end:'17:30', headway:8, runtime:60 },
            { days:'weekday', start:'17:30', end:'21:30', headway:4, runtime:60 },
            { days:'weekday', start:'21:30', end:'23:15', headway:10, runtime:60 },
            { days:'weekend', start:'06:30', end:'23:00', headway:10, runtime:60 }
          ]
        },

        { mode:'ferry', routeId:'F1', name:'Gateway ↔ Elephanta', from:'Gateway of India', to:'Elephanta',
          fromStop:{ id:'GTW', lat:18.9218, lng:72.8347 }, toStop:{ id:'ELP', lat:18.9634, lng:72.9316 },
          frequencies:[ { days:'daily', start:'09:00', end:'17:00', headway:30, runtime:50 } ]
        },

        { mode:'bus', routeId:'A1E', name:'BEST A-1 Express', from:'Colaba', to:'Bandra',
          fromStop:{ id:'COL', lat:18.9100, lng:72.8090 }, toStop:{ id:'BAN', lat:19.0596, lng:72.8295 },
          frequencies:[
            { days:'weekday', start:'07:00', end:'10:30', headway:10, runtime:55 },
            { days:'weekday', start:'17:00', end:'20:30', headway:10, runtime:55 }
          ]
        },
        { mode:'bus', routeId:'2L', name:'BEST 2Ltd (Mumbai Central → Bandra)', from:'Mumbai Central', to:'Bandra',
          fromStop:{ id:'MCT', lat:18.9719, lng:72.8194 }, toStop:{ id:'BAN', lat:19.0596, lng:72.8295 },
          frequencies:[
            { days:'weekday', start:'07:00', end:'10:30', headway:12, runtime:45 },
            { days:'weekday', start:'10:30', end:'17:00', headway:15, runtime:45 },
            { days:'weekday', start:'17:00', end:'20:30', headway:12, runtime:45 }
          ]
        },
        { mode:'bus', routeId:'37', name:'BEST 37 (Santacruz → Colaba)', from:'Santacruz', to:'Colaba',
          fromStop:{ id:'SAN', lat:19.0810, lng:72.8410 }, toStop:{ id:'COL', lat:18.9100, lng:72.8090 },
          frequencies:[ { days:'daily', start:'06:30', end:'22:00', headway:15, runtime:65 } ]
        },

        // Additional BEST routes (from published timetables)
        { mode:'bus', routeId:'234', name:'BEST 234 (Vesave/Yari Road ↔ Jogeshwari)', from:'Vesave/Yari Road', to:'Jogeshwari',
          fromStop:{ id:'VYR', lat:19.1274, lng:72.8050 }, toStop:{ id:'JOG', lat:19.1356, lng:72.8480 },
          frequencies:[
            { days:'daily', start:'06:00', end:'10:00', headway:10, runtime:35 },
            { days:'daily', start:'10:00', end:'17:00', headway:15, runtime:35 },
            { days:'daily', start:'17:00', end:'21:00', headway:10, runtime:35 },
            { days:'daily', start:'21:00', end:'22:30', headway:15, runtime:35 }
          ]
        },
        { mode:'bus', routeId:'78', name:'Bus 78 (Wagle Depot ↔ Bharat Gears)', from:'Wagle Depot', to:'Bharat Gears',
          fromStop:{ id:'WAG', lat:19.1969, lng:72.9611 }, toStop:{ id:'BGE', lat:19.1780, lng:72.9690 },
          frequencies:[
            { days:'daily', start:'05:45', end:'10:00', headway:30, runtime:60 },
            { days:'daily', start:'10:00', end:'17:00', headway:40, runtime:60 },
            { days:'daily', start:'17:00', end:'19:15', headway:30, runtime:60 }
          ]
        },
        { mode:'bus', routeId:'42', name:'BEST 42 (Sandhurst Road ↔ Kamla Nehru Park)', from:'Sandhurst Road', to:'Kamla Nehru Park',
          fromStop:{ id:'SDR', lat:18.9634, lng:72.8397 }, toStop:{ id:'KNP', lat:18.9533, lng:72.8050 },
          frequencies:[
            { days:'daily', start:'06:00', end:'22:00', headway:12, runtime:45 }
          ]
        },
        { mode:'bus', routeId:'164', name:'BEST 164 (Maharana Pratap Chowk ↔ Dharavi Depot)', from:'Maharana Pratap Chowk', to:'Dharavi Depot',
          fromStop:{ id:'MPC', lat:19.1735, lng:72.9477 }, toStop:{ id:'DHD', lat:19.0465, lng:72.8543 },
          frequencies:[
            { days:'daily', start:'06:00', end:'21:30', headway:26, runtime:65 }
          ]
        },
        { mode:'bus', routeId:'9', name:'BEST 9 (Antop Hill ↔ Colaba)', from:'Antop Hill', to:'Colaba',
          fromStop:{ id:'ATH', lat:19.0169, lng:72.8598 }, toStop:{ id:'COL', lat:18.9100, lng:72.8090 },
          frequencies:[
            { days:'daily', start:'06:30', end:'22:00', headway:30, runtime:70 }
          ]
        },
        { mode:'bus', routeId:'115', name:'Bus 115 (Lakshmi Park ↔ Mulund Stn W)', from:'Lakshmi Park', to:'Mulund Stn (W)',
          fromStop:{ id:'LKP', lat:19.1730, lng:72.9330 }, toStop:{ id:'MLW', lat:19.1736, lng:72.9425 },
          frequencies:[
            { days:'daily', start:'07:00', end:'12:00', headway:25, runtime:35 },
            { days:'daily', start:'12:00', end:'17:00', headway:35, runtime:35 },
            { days:'daily', start:'17:00', end:'22:00', headway:25, runtime:35 }
          ]
        }
      ]
    };

    // Expose schedules for UI details
    window.MUMBAI_SCHEDULES = SCHEDULES;

    const colors = { bus:'#5E6AD2', train:'#00B87A', metro:'#8B5CF6', ferry:'#0EA5E9', monorail:'#10B981' };
    const icons  = { bus:'fa-bus', train:'fa-train-subway', metro:'fa-train-tram', ferry:'fa-ship', monorail:'fa-train' };
    const toMinutes = (hhmm) => { const [h,m] = hhmm.split(':').map(Number); return h*60 + m; };
    const sinceMid  = (d=new Date()) => d.getHours()*60 + d.getMinutes();
    const dayType   = (d=new Date()) => ([0,6].includes(d.getDay()) ? 'weekend' : 'weekday');
    const peak      = (h) => (h>=7 && h<=10) || (h>=18 && h<=21);
    const jitter    = (now=new Date()) => peak(now.getHours()) ? (Math.random()<0.5?0:1) : 0;
    function getReferenceTime() {
      const inp = document.getElementById('refTime');
      const val = inp && inp.value;
      if (!val) return new Date();
      const [hh, mm] = val.split(':').map(Number);
      const d = new Date();
      d.setHours(hh || 0, mm || 0, 0, 0);
      return d;
    }
    function prettyClockFromMinutes(mins) {
      const m = ((mins % 1440) + 1440) % 1440;
      const h = Math.floor(m / 60);
      const mi = m % 60;
      const d = new Date();
      d.setHours(h, mi, 0, 0);
      return new Intl.DateTimeFormat(undefined, { hour: 'numeric', minute: '2-digit' }).format(d);
    }

    function nextDepartures(routeDef, count=6, now=new Date()) {
      const nowMin = sinceMid(now);
      const wins = (routeDef.frequencies||[]).filter(f => f.days==='daily' || f.days===dayType(now));
      const out = [];
      for (const w of wins) {
        const start = toMinutes(w.start), end = toMinutes(w.end), head = Math.max(1, Math.round(+w.headway));
        for (let t=start; t<=end; t+=head) { if (t >= nowMin) out.push({ departMin:t, runtime:Math.max(1, +w.runtime) }); if (out.length >= count*2) break; }
        if (out.length >= count*2) break;
      }
      if (out.length < count && wins.length) {
        const w=wins[0], start=toMinutes(w.start), head=Math.max(1, Math.round(+w.headway));
        for (let t=start; out.length<count; t+=head) out.push({ departMin:t+1440, runtime:Math.max(1,+w.runtime) });
      }
      return out.slice(0, count).map(d => ({
        etaMin: Math.max(0, d.departMin - sinceMid(now)) + jitter(now),
        departMin: d.departMin,
        runtime: d.runtime
      }));
    }

    function clearFallbackMarkers() {
      const mapContent = document.getElementById('mapContent');
      if (mapContent) mapContent.querySelectorAll('.vehicle-marker').forEach(m => m.remove());
    }
    function appendFallbackMarker(lat, lng, color) {
      const b = SCHEDULES.vehicleBounds;
      const mapContent = document.getElementById('mapContent');
      if (!mapContent) return;
      const xPct = ((lng - b.lngMin) / (b.lngMax - b.lngMin)) * 90 + 5;
      const yPct = ((lat - b.latMin) / (b.latMax - b.latMin)) * 90 + 5;
      const marker = document.createElement('div');
      marker.className = 'vehicle-marker';
      marker.style.backgroundColor = color;
      marker.style.left = xPct + '%';
      marker.style.top = (100 - yPct) + '%';
      marker.setAttribute('data-route', '');
      mapContent.appendChild(marker);
    }

    function placeMarkersForRoute(hub, route, mode) {
      const wins = (route.frequencies||[]).filter(f => f.days==='daily' || f.days===dayType());
      if (!wins.length || !route.fromStop || !route.toStop) return;
      const runtime = Math.max(1, +wins[0].runtime);
      const head    = Math.max(1, Math.round(+wins[0].headway));
      const pool    = Math.max(2, Math.min(6, Math.ceil(runtime / Math.max(5, head))));
      const nowMin  = sinceMid(new Date());
      for (let i=0; i<pool; i++) {
        const offset = Math.min(runtime, Math.floor((i/(pool-1||1)) * runtime));
        const progress = Math.min(1, Math.max(0, offset / runtime));
        const lat = route.fromStop.lat + (route.toStop.lat - route.fromStop.lat) * progress;
        const lng = route.fromStop.lng + (route.toStop.lng - route.fromStop.lng) * progress;
        if (hub.map && !hub.mapFallbackMode && window.L) {
          const id = `${route.routeId}_${nowMin - offset}`;
          let marker = (hub.appData && hub.appData.leafletMarkers && hub.appData.leafletMarkers.get) ? hub.appData.leafletMarkers.get(id) : null;
          if (!marker) {
            marker = L.circleMarker([lat, lng], { radius:5, color:'#fff', weight:1.5, fillColor:colors[mode], fillOpacity:1 })
                      .bindTooltip(`${route.name}`, { direction:'top', offset:[0,-4] })
                      .addTo(hub.map);
            if (hub.appData && hub.appData.leafletMarkers && hub.appData.leafletMarkers.set) hub.appData.leafletMarkers.set(id, marker);
          } else {
            marker.setLatLng([lat, lng]);
          }
        } else {
          appendFallbackMarker(lat, lng, colors[mode]);
        }
      }
    }

    function tryInit() {
      const hub = window.MumbaiTransport;
      if (!hub) return false;
      if (!hub.updateSchedulesSimulated) hub.updateSchedulesSimulated = hub.updateSchedules.bind(hub);
      if (!hub.updateVehiclePositionsSimulated) hub.updateVehiclePositionsSimulated = hub.updateVehiclePositions.bind(hub);

      hub.updateSchedules = function() {
        const scheduleList = document.getElementById('scheduleList');
        const mode = this.appData.selectedTransport;
        const routes = (SCHEDULES.routes||[]).filter(r => r.mode === mode).slice(0, 6);
        if (!routes.length) return this.updateSchedulesSimulated();
        scheduleList.innerHTML = '';
        // Add a header row with a details button
        const header = document.createElement('div');
        header.className = 'update-item';
        header.innerHTML = `
          <div class="update-icon" style="background:${colors[mode]};"><i class="fa-solid ${icons[mode]}"></i></div>
          <div class="update-content">
            <div class="update-text"><strong>${mode.toUpperCase()}</strong> next departures</div>
            <div class="update-time">Tap a route for details</div>
          </div>`;
        scheduleList.appendChild(header);
        routes.forEach(route => {
          const refNow = getReferenceTime();
          const n = nextDepartures(route, 1, refNow)[0];
          const total = n ? n.etaMin : '—';
          const timeStr = n ? prettyClockFromMinutes(n.departMin % (24*60)) : '—';
          const delayText = (n && n.etaMin>0 && n.etaMin%11===0) ? ' (+1 min delay)' : '';
          const item = document.createElement('div');
          item.className = 'schedule-item';
          item.innerHTML = `
            <div class="schedule-icon" style="background:${colors[mode]}"><i class="fa-solid ${icons[mode]}"></i></div>
            <div class="schedule-content">
              <div class="schedule-route">${route.name} • ${route.from} → ${route.to}</div>
              <div class="schedule-time">Next: ${total} min at ${timeStr}${delayText}</div>
            </div>`;
          item.addEventListener('click', () => openDetailsSheet({ type: 'route', mode, route }));
          scheduleList.appendChild(item);
        });
      };

      hub.updateVehiclePositions = function() {
        const mode = this.appData.selectedTransport;
        const routes = (SCHEDULES.routes||[]).filter(r => r.mode === mode).slice(0, 6);
        if (!routes.length) return this.updateVehiclePositionsSimulated();
        if (!this.map || this.mapFallbackMode || !window.L) clearFallbackMarkers();
        if (this.appData && this.appData.leafletMarkers && this.appData.leafletMarkers.size > 240 && this.map) {
          this.appData.leafletMarkers.forEach((m, id) => { m.remove(); this.appData.leafletMarkers.delete(id); });
        }
        routes.forEach(route => placeMarkersForRoute(this, route, mode));
      };

      if (hub.timers) Object.values(hub.timers).forEach(t => t && clearInterval(t));
      hub.timers = hub.timers || {};
      hub.timers.vehicles  = setInterval(() => hub.updateVehiclePositions(), 3000);
      hub.timers.schedules = setInterval(() => hub.updateSchedules(), 15000);

      hub.updateSchedules();
      hub.updateVehiclePositions();
      hub.showNotification && hub.showNotification('✅ Static schedules (Aug 2025) live view enabled');
      return true;
    }

    if (!tryInit()) {
      const iv = setInterval(() => { if (tryInit()) clearInterval(iv); }, 300);
      setTimeout(() => clearInterval(iv), 12000);
    }

    // Bottom sheet helpers
    function openDetailsSheet(payload) {
      const sheet = document.getElementById('sheet');
      const sheetBody = document.getElementById('sheetBody');
      const sheetTitle = document.getElementById('sheetTitle');
      const backdrop = document.getElementById('sheetBackdrop');
      if (!sheet || !sheetBody || !sheetTitle || !backdrop) return;

      if (payload && payload.type === 'route') {
        const r = payload.route;
        sheetTitle.textContent = `${r.name}`;
        const wins = (r.frequencies||[]).map(f => `<li>${f.days}: ${f.start}–${f.end} • every ${f.headway} min • runtime ${f.runtime} min</li>`).join('');
        sheetBody.innerHTML = `
          <div style="margin-bottom:8px; color: var(--text-secondary);">${r.from} → ${r.to}</div>
          <ul style="margin-left:16px;">${wins || '<li>No data</li>'}</ul>
        `;
      } else if (payload && payload.type === 'actions') {
        sheetTitle.textContent = payload.title || 'Actions';
        sheetBody.innerHTML = payload.html || '';
      }

      sheet.setAttribute('aria-hidden', 'false');
      sheet.classList.add('open');
      backdrop.classList.add('show');
      backdrop.onclick = closeDetailsSheet;
      const closeBtn = document.getElementById('sheetClose');
      if (closeBtn) closeBtn.onclick = closeDetailsSheet;
    }
    function closeDetailsSheet() {
      const sheet = document.getElementById('sheet');
      const backdrop = document.getElementById('sheetBackdrop');
      if (!sheet || !backdrop) return;
      sheet.classList.remove('open');
      backdrop.classList.remove('show');
      sheet.setAttribute('aria-hidden', 'true');
    }

    // Hook up action buttons and nav for better UX
    document.addEventListener('DOMContentLoaded', () => {
      const actions = [
        { id: 'buy-ticket', title: 'Buy Ticket', html: '<p>Use the official operator apps or kiosks. This demo shows static schedules only.</p>' },
        { id: 'plan-journey', title: 'Plan Journey', html: '<p>Pick a mode, then compare next departures. Detailed journey planning can be integrated later.</p>' },
        { id: 'nearby-stations', title: 'Nearby Stations', html: '<p>Enable location in a future update to show stations within 1–3 km. For now, use mode schedules above.</p>' },
        { id: 'recharge-card', title: 'Recharge Card', html: '<p>Use your wallet or the official portals to recharge. This demo does not process payments.</p>' }
      ];
      actions.forEach(a => {
        const el = document.getElementById(a.id);
        if (el) el.addEventListener('click', () => openDetailsSheet({ type: 'actions', title: a.title, html: a.html }));
      });

      document.querySelectorAll('.nav-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const nav = btn.getAttribute('data-nav');
          if (nav === 'home') window.scrollTo({ top: 0, behavior: 'smooth' });
          if (nav === 'map') {
            const el = document.getElementById('live-heading');
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          if (nav === 'tickets') { if (window.openTicketsSheet) window.openTicketsSheet(); }
          if (nav === 'account') {
            openDetailsSheet({ type:'actions', title:'Account', html:'<p>Sign-in and profile features are not part of this static demo.</p>' });
          }
        });
      });
      const ref = document.getElementById('refTime');
      const useNow = document.getElementById('useNow');
      if (ref) ref.addEventListener('change', () => {
        if (window.MumbaiTransport && window.MumbaiTransport.updateSchedules) window.MumbaiTransport.updateSchedules();
      });
      if (useNow) useNow.addEventListener('click', () => {
        const inp = document.getElementById('refTime');
        if (inp) inp.value = '';
        if (window.MumbaiTransport && window.MumbaiTransport.updateSchedules) window.MumbaiTransport.updateSchedules();
      });
    });

    // Tickets sheet (organized per mode) and WhatsApp flows
    window.openTicketsSheet = function() {
      const sheet = document.getElementById('sheet');
      const sheetBody = document.getElementById('sheetBody');
      const sheetTitle = document.getElementById('sheetTitle');
      const backdrop = document.getElementById('sheetBackdrop');
      if (!sheet || !sheetBody || !sheetTitle || !backdrop) return;

      sheetTitle.textContent = 'Tickets – Mumbai';
      const row = (icon, title, html) => `
        <div class="update-item">
          <div class="update-icon" style="background: var(--primary);"><i class="fa-solid ${icon}"></i></div>
          <div class="update-content">
            <div class="update-text"><strong>${title}</strong></div>
            <div class="update-time" style="margin-top:6px; color: var(--text-secondary);">${html}</div>
          </div>
        </div>`;

      const waLink = (num, text='Hi') => `https://wa.me/${num}?text=${encodeURIComponent(text)}`;
      const link = (href, label) => `<a href="${href}" target="_blank" rel="noopener" style="text-decoration:none;">${label}</a>`;

      const line1 = row('fa-train-tram', 'Mumbai Metro Line 1 (Versova–Andheri–Ghatkopar) – WhatsApp Ticketing', `
        Steps: 1) Send “hi” to 9670008889 2) Select source & destination 3) Pay online or share OTP at counter 4) Receive QR to travel.<br/>
        ${link(waLink('919670008889'), 'Open WhatsApp (9670008889)')}
      `);

      const lines2A7 = row('fa-train', 'Mumbai Metro Lines 2A & 7 – WhatsApp Ticketing', `
        Send “Hi” on 86526 35500. Tickets are non-refundable and valid for the same business day. Check operational hours before booking.<br/>
        ${link(waLink('918652635500'), 'Open WhatsApp (86526 35500)')}
      `);

      const aqua = row('fa-water', 'Mumbai Metro Line 3 (Aqua) – Booking', `
        Use the official MMRCL portal to select stations and proceed.<br/>
        ${link('https://mmrcl.com/en/map', 'Open MMRCL Portal')}
      `);

      const suburban = row('fa-train-subway', 'Suburban Trains', `
        Use official ticketing (e.g., UTS) or counters. Ensure correct origin/destination and class.
      `);

      const best = row('fa-bus', 'BEST Buses', `
        Buy from conductor/counters or official app/cards. Confirm route and stage before purchase.
      `);

      const ferry = row('fa-ship', 'Ferries', `
        Buy at jetties/authorized operators. Check last sailing and sea conditions.
      `);

      sheetBody.innerHTML = line1 + lines2A7 + aqua + suburban + best + ferry;
      sheet.setAttribute('aria-hidden', 'false');
      sheet.classList.add('open');
      backdrop.classList.add('show');
      backdrop.onclick = closeDetailsSheet;
      const closeBtn = document.getElementById('sheetClose');
      if (closeBtn) closeBtn.onclick = closeDetailsSheet;
    };
    })();
  </script>
<script src="/portal/cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min.js" data-cf-settings="3b11bab85d2525af6551e7f1-|49" defer></script></body>
</html>
